<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DONGJU SPORT - OT SYSTEM Design by Thanh Thien</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===== GIAO DIỆN CHUẨN XANH/TRẮNG ===== */
        :root {
            --primary: #1a237e; --primary-light: #534bae;
            --accent: #2962ff; --accent-light: #768fff;
            --success: #00c853; --warning: #ff9100; --danger: #ff1744;
            --gray-50: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0; --gray-300: #cbd5e1;
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--gray-50); color: #333; height: 100vh; overflow: hidden; }
        .app-container { display: flex; height: 100vh; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* SIDEBAR */
        .sidebar { width: var(--sidebar-width); background: linear-gradient(180deg, var(--primary) 0%, #0d47a1 100%); color: white; display: flex; flex-direction: column; z-index: 100; box-shadow: 4px 0 10px rgba(0,0,0,0.1); }
        .sidebar-header { padding: 25px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.1); }
        .logo { font-size: 1.6rem; font-weight: 700; margin-bottom: 5px; letter-spacing: 1px; }
        .nav-items { padding: 20px 15px; flex: 1; }
        .nav-item { padding: 12px 15px; margin: 5px 0; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; opacity: 0.85; font-size: 0.95rem; }
        .nav-item:hover { background: rgba(255,255,255,0.1); opacity: 1; }
        .nav-item.active { background: white; color: var(--primary); font-weight: bold; opacity: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .user-info { padding: 15px; background: rgba(0,0,0,0.2); font-size: 0.85rem; }

        /* MAIN */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .main-header { background: white; padding: 12px 30px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .page-title { font-size: 1.3rem; font-weight: 700; color: var(--primary); }
        .header-tools { display: flex; align-items: center; gap: 15px; }
        .sync-status { font-size: 0.8rem; font-weight: 600; padding: 4px 10px; border-radius: 20px; background: var(--gray-100); display: flex; align-items: center; gap: 5px; }
        
        .content-area { flex: 1; overflow-y: auto; padding: 20px 30px; }
        .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid var(--gray-200); }
        .card-header { font-size: 1.1rem; font-weight: 600; color: var(--primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--gray-100); display: flex; align-items: center; gap: 10px; }
        
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center; }
        input, select { padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; outline: none; transition: all 0.2s; }
        input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(41, 98, 255, 0.1); }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 0.9rem; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); color: #333; }
        .btn-danger { background: var(--danger); }
        .btn-gray { background: #607d8b; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95rem; }
        th { background: #f1f5f9; padding: 12px 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #e2e8f0; color: #475569; white-space: nowrap; }
        td { padding: 8px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }
        
        .ot-input-fast { width: 50px; text-align: center; border: 1px solid #ddd; padding: 6px 4px; border-radius: 4px; font-weight: 500; }
        .ot-input-fast:focus { background: #e3f2fd; border-color: var(--accent); font-weight: bold; }
        .ot-input-fast.updating { background: #fff9c4; border-color: #fbc02d; transition: 0.5s; }
        .money { color: #d32f2f; font-weight: bold; text-align: right; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        /* UTILS */
        .hidden { display: none !important; }
        .queue-status { position: fixed; bottom: 20px; right: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-left: 4px solid var(--warning); z-index: 9999; width: 250px; }
        .progress-bar { height: 4px; background: #eee; margin-top: 8px; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: 0.3s; }
        .history-info { background: #e8eaf6; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c5cae9; }
        .search-highlight { background-color: #fffde7 !important; transition: background-color 0.5s; }

        /* REPORTS */
        .chart-container { position: relative; height: 350px; width: 100%; margin-top: 20px; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .summary-card { padding: 15px; border-radius: 10px; color: white; display: flex; flex-direction: column; justify-content: center; }
        .sc-blue { background: linear-gradient(135deg, #2196f3, #1976d2); }
        .sc-orange { background: linear-gradient(135deg, #ff9800, #f57c00); }
        .sc-green { background: linear-gradient(135deg, #4caf50, #388e3c); }
        .sc-title { font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px; }
        .sc-value { font-size: 1.5rem; font-weight: bold; }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">DONGJU SPORT</div>
                <div style="opacity:0.7; font-size:0.8rem">Version 6.3 (Stable)</div>
            </div>
            <div class="nav-items">
                <div id="nav-staff" class="nav-item active" onclick="switchTab('staff')"><i class="fas fa-users"></i> Nhân Sự</div>
                <div id="nav-ot" class="nav-item" onclick="switchTab('ot')"><i class="fas fa-clock"></i> Chấm Công OT</div>
                <div id="nav-history" class="nav-item" onclick="switchTab('history')"><i class="fas fa-history"></i> Lịch Sử & In</div>
                <div id="nav-reports" class="nav-item" onclick="switchTab('reports')"><i class="fas fa-chart-bar"></i> Báo Cáo</div>
                <div id="nav-account" class="nav-item" onclick="switchTab('account')"><i class="fas fa-user-cog"></i> Tài Khoản & Backup</div>
            </div>
            <div class="user-info">
                <div><i class="fas fa-user-circle"></i> Admin</div>
                <button class="btn btn-danger btn-sm" style="width:100%; margin-top:10px" onclick="clearAllData()">
                    <i class="fas fa-trash"></i> Xóa Cache (Reset)
                </button>
            </div>
        </div>

        <!-- MAIN -->
        <div class="main-content">
            <div class="main-header">
                <div class="page-title" id="page-title">QUẢN LÝ NHÂN SỰ</div>
                <div class="header-tools">
                    <div id="syncStatus" class="sync-status"><i class="fas fa-check-circle" style="color:green"></i> Sẵn sàng</div>
                    <div id="date-tool" class="hidden">
                        <input type="date" id="workDate" onchange="renderOTFast()" style="font-weight:bold; color:var(--primary); padding: 5px; border-radius:4px; border:1px solid #ccc;">
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="forceReload()"><i class="fas fa-sync"></i> Tải lại</button>
                </div>
            </div>

            <div class="content-area">
                <!-- 1. STAFF -->
                <div id="tab-staff">
                    <div class="card">
                        <div class="card-header"><i class="fas fa-user-plus"></i> THÊM NHÂN VIÊN</div>
                        <div class="toolbar">
                            <input type="text" id="addId" placeholder="Mã NV" style="width:100px">
                            <input type="text" id="addName" placeholder="Họ Tên">
                            <input type="text" id="addDept" placeholder="Bộ Phận" style="width:120px">
                            <input type="number" id="addSalary" placeholder="Lương CB" style="width:120px">
                            <button class="btn btn-primary" onclick="addNewStaff()">Thêm</button>
                            <button class="btn btn-success" onclick="saveStaffToCloud()">Lưu lên Sheet</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><i class="fas fa-list"></i> DANH SÁCH NHÂN VIÊN</div>
                        <div class="toolbar">
                            <input type="text" id="searchStaff" placeholder="Tìm kiếm..." onkeyup="renderStaff()" style="width:250px">
                            <label class="btn btn-gray" style="cursor:pointer">
                                <i class="fas fa-file-excel"></i> Nhập Excel/CSV
                                <input type="file" id="excelInput" hidden onchange="importExcel(this)">
                            </label>
                            <button class="btn btn-warning btn-sm" onclick="downloadTemplate()"><i class="fas fa-download"></i> Tải mẫu</button>
                            <button class="btn btn-danger" onclick="deleteSelectedStaff()" style="margin-left:auto">Xóa chọn</button>
                        </div>
                        <div style="overflow-x:auto; max-height: 500px;">
                            <table>
                                <thead style="position: sticky; top: 0; z-index: 1;">
                                    <tr>
                                        <th style="width:40px"><input type="checkbox" onchange="toggleAllStaff(this)"></th>
                                        <th>Mã NV</th><th>Họ Tên</th><th>Bộ Phận</th><th>Lương CB</th><th>Xóa</th>
                                    </tr>
                                </thead>
                                <tbody id="staffBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 2. OT -->
                <div id="tab-ot" class="hidden">
                    <div id="queueStatus" class="queue-status hidden">
                        <div style="display:flex; justify-content:space-between">
                            <strong><i class="fas fa-sync fa-spin"></i> Đang đồng bộ...</strong>
                            <span id="queueCountBadge">0</span>
                        </div>
                        <div class="progress-bar"><div id="queueProgress" class="progress-fill"></div></div>
                    </div>

                    <div class="card">
                        <div class="toolbar">
                            <select id="deptFilter" onchange="renderOTFast()"><option value="all">Tất cả bộ phận</option></select>
                            
                            <div style="display:flex; align-items:center; gap:5px; border:1px solid #ccc; border-radius:6px; padding:0 8px; background:white;">
                                <span>Công chuẩn:</span>
                                <input type="number" id="stdDays" value="26" style="width:50px; border:none; text-align:center; padding: 8px 0; font-weight:bold" onchange="renderOTFast()">
                            </div>

                            <input type="text" id="searchOT" placeholder="Nhập Mã NV..." style="width:180px" onkeyup="handleSearchOT(event)">
                            <button class="btn btn-warning btn-sm" onclick="toggleTurbo()" id="turboBtn">Turbo: OFF</button>
                            <button class="btn btn-success" onclick="exportExcelFile()">Xuất Excel</button>
                        </div>
                    </div>

                    <div class="card" style="background:#fffde7; border-color:#fff9c4">
                        <div class="card-header" style="color:#f57f17; border-bottom-color:#fff9c4"><i class="fas fa-bolt"></i> GÁN NHANH</div>
                        <div class="toolbar">
                            <b>1.5</b> <input type="text" id="b15" class="ot-input-fast" placeholder="0:30">
                            <b>2.1</b> <input type="text" id="b21" class="ot-input-fast">
                            <b>2.0</b> <input type="text" id="b20" class="ot-input-fast">
                            <b>3.5</b> <input type="text" id="b35" class="ot-input-fast">
                            <button class="btn btn-warning btn-sm" onclick="applyBulk(true)">Chọn</button>
                            <button class="btn btn-gray btn-sm" onclick="applyBulk(false)">Tất cả (Đang hiển thị)</button>
                            <button class="btn btn-danger btn-sm" onclick="clearDayOT()" style="margin-left:auto">Xóa ngày</button>
                        </div>
                    </div>

                    <div class="card">
                        <div style="overflow-x:auto; max-height: 500px;">
                            <table>
                                <thead style="position: sticky; top: 0; z-index: 1;">
                                    <tr>
                                        <th style="width:40px"><input type="checkbox" class="ot-check-all" onchange="toggleAllOT(this)"></th>
                                        <th>Nhân Viên</th>
                                        <th class="text-center">1.5</th><th class="text-center">2.1</th>
                                        <th class="text-center">2.0</th><th class="text-center">3.5</th>
                                        <th class="text-right">Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody id="otBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 3. HISTORY -->
                <div id="tab-history" class="hidden">
                    <div class="card">
                        <div class="card-header"><i class="fas fa-search"></i> TRA CỨU & IN PHIẾU</div>
                        <div class="toolbar">
                            <select id="historyDeptFilter" onchange="updateHistoryDatalist()" style="width:150px">
                                <option value="all">Tất cả BP</option>
                            </select>
                            
                            <select id="historyStaffId" style="width:200px" onchange="loadHistory()">
                                <option value="">-- Chọn Nhân Viên --</option>
                            </select>

                            <input type="date" id="historyFrom">
                            <input type="date" id="historyTo">
                            <button class="btn btn-primary" onclick="loadHistory()">Xem</button>
                            <button id="btnPrint" class="btn btn-warning hidden" onclick="printHistory()"><i class="fas fa-print"></i> In Phiếu</button>
                        </div>

                        <div id="historyUserInfo" class="history-info hidden">
                            <div style="display:flex; justify-content:space-between; align-items:center">
                                <div>
                                    <h3 style="margin:0; color:var(--primary)" id="histName">Tên NV</h3>
                                    <small id="histDetail">...</small>
                                </div>
                                <div class="text-right">
                                    <small>Tổng thực lĩnh</small><br>
                                    <span class="money" style="font-size:1.5rem" id="histTotalMoney">0 ₫</span>
                                </div>
                            </div>
                        </div>

                        <div style="overflow-x:auto">
                            <table>
                                <thead><tr><th>Ngày</th><th>1.5</th><th>2.1</th><th>2.0</th><th>3.5</th><th>Tổng giờ</th></tr></thead>
                                <tbody id="historyBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 4. REPORTS -->
                <div id="tab-reports" class="hidden">
                    <div class="card">
                        <div class="card-header"><i class="fas fa-chart-pie"></i> BÁO CÁO TĂNG CA</div>
                        <div class="toolbar">
                            <select id="reportMonth" onchange="renderReports()">
                                <option value="current">Tháng này</option>
                                <option value="last">Tháng trước</option>
                                <option value="all">Toàn bộ</option>
                            </select>
                            <button class="btn btn-primary" onclick="renderReports()"><i class="fas fa-sync"></i> Làm mới</button>
                        </div>
                        <div class="summary-cards">
                            <div class="summary-card sc-blue"><div class="sc-title">Tổng giờ OT</div><div class="sc-value" id="repTotalHours">0h</div></div>
                            <div class="summary-card sc-orange"><div class="sc-title">Tổng chi phí OT</div><div class="sc-value" id="repTotalMoney">0 ₫</div></div>
                            <div class="summary-card sc-green"><div class="sc-title">Bộ phận cao nhất</div><div class="sc-value" id="repTopDept">-</div></div>
                        </div>
                        <div class="chart-container"><canvas id="deptChart"></canvas></div>
                    </div>
                </div>

                <!-- 5. ACCOUNT -->
                <div id="tab-account" class="hidden">
                    <div class="card">
                        <div class="card-header"><i class="fas fa-database"></i> SAO LƯU & KHÔI PHỤC</div>
                        <div style="padding:15px; background:#e3f2fd; border-radius:8px; margin-bottom:20px; display:flex; gap:15px; align-items:center;">
                            <div style="flex:1"><strong>Sao lưu về máy:</strong><br><small>Tải dữ liệu về máy để dự phòng.</small></div>
                            <button class="btn btn-success" onclick="backupData()"><i class="fas fa-download"></i> Tải về</button>
                        </div>
                        <div style="padding:15px; background:#fff3e0; border-radius:8px; margin-bottom:20px; display:flex; gap:15px; align-items:center;">
                            <div style="flex:1"><strong>Khôi phục dữ liệu:</strong><br><small>Chọn file .json để phục hồi.</small></div>
                            <label class="btn btn-warning" style="cursor:pointer">
                                <i class="fas fa-upload"></i> Chọn File
                                <input type="file" hidden onchange="restoreData(this)" accept=".json">
                            </label>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><i class="fas fa-user-shield"></i> QUẢN LÝ TÀI KHOẢN</div>
                        <div class="toolbar">
                            <input type="text" id="newUsername" placeholder="Username">
                            <input type="password" id="newPassword" placeholder="Password">
                            <select id="newRole"><option value="user">User</option><option value="admin">Admin</option></select>
                            <button class="btn btn-primary" onclick="createAccount()">Tạo</button>
                            <button class="btn btn-success" onclick="saveStaffToCloud()">Lưu Sheet</button>
                        </div>
                        <table>
                            <thead><tr><th>Tài khoản</th><th>Quyền</th><th>Ngày tạo</th><th>Xóa</th></tr></thead>
                            <tbody id="accountBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzC1qlowBk3Qed6YZXOPJ6hmf4l8FG171OD3NCxLaKqYGgLQoNM_0ey0B89GeiGPSsQTA/exec";
        let DB = { staff: [], ot: {}, users: [] };
        let QUEUE = { items: [], isSending: false, batchSize: 20, timer: null };
        let TURBO_MODE = false;
        let chartInstance = null;

        window.onload = function() {
            document.getElementById('workDate').value = new Date().toISOString().split('T')[0];
            loadLocal();
            if(DB.staff.length===0) forceReload(); else { renderStaff(); updateDeptList(); renderAccounts(); updateLastBackupTime(); }
        };

        function switchTab(t) {
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById('nav-'+t).classList.add('active');
            ['staff','ot','history','account','reports'].forEach(x=>document.getElementById('tab-'+x).classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            
            const dateTool = document.getElementById('date-tool');
            if(t==='ot') { dateTool.classList.remove('hidden'); updateDeptList(); renderOTFast(); }
            else if(t==='history') { dateTool.classList.add('hidden'); initHistoryTab(); }
            else if(t==='reports') { dateTool.classList.add('hidden'); renderReports(); }
            else { dateTool.classList.add('hidden'); }
        }

        // --- BACKUP & RESTORE ---
        function backupData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB));
            const node = document.createElement('a');
            const date = new Date().toISOString().split('T')[0];
            node.setAttribute("href", dataStr);
            node.setAttribute("download", `dongju_backup_${date}.json`);
            document.body.appendChild(node); node.click(); node.remove();
            localStorage.setItem('dongju_last_backup', new Date().toLocaleString());
            updateLastBackupTime();
        }
        function restoreData(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.staff && data.ot && confirm("Cảnh báo: Dữ liệu hiện tại sẽ bị thay thế. Tiếp tục?")) {
                        DB = data; saveLocal(); location.reload();
                    }
                } catch(err) { alert("File lỗi!"); }
            };
            reader.readAsText(file); input.value = "";
        }
        function updateLastBackupTime() {
            document.getElementById('lastBackupTime').innerText = localStorage.getItem('dongju_last_backup') || "Chưa bao giờ";
        }

        // --- IMPORT EXCEL ---
        function importExcel(input) {
            if(!input.files || !input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                let json = [];
                try {
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    json = XLSX.utils.sheet_to_json(sheet, {header:1});
                } catch (err) { console.warn("Lỗi đọc XLSX, thử CSV..."); }

                if (!json || json.length < 2) {
                    try {
                        const textDecoder = new TextDecoder("utf-8");
                        const text = textDecoder.decode(data);
                        const lines = text.split(/\r\n|\n/);
                        json = lines.map(line => line.split(',')); 
                    } catch (e) { console.error("Lỗi CSV:", e); }
                }

                if(!json || json.length < 2) return alert("Không đọc được dữ liệu! Vui lòng kiểm tra file.");

                let count = 0;
                for(let i=1; i<json.length; i++) {
                    const row = json[i];
                    if(!row || row.length < 2) continue;
                    // FIX: Check null before trim
                    const id = row[0] ? String(row[0]).trim() : "";
                    const name = row[1] ? String(row[1]).trim() : "";
                    const dept = row[2] ? String(row[2]).trim() : "";
                    let salaryRaw = row[3] ? String(row[3]) : "0";
                    salaryRaw = salaryRaw.replace(/[^0-9]/g, ''); 
                    const salary = parseFloat(salaryRaw) || 0;

                    if(id && name) {
                        const exists = DB.staff.some(s => s.id === id);
                        if(!exists) {
                            DB.staff.push({ id, name, dept, salary });
                            count++;
                        }
                    }
                }
                saveLocal(); renderStaff(); updateDeptList();
                alert(`✅ Đã nhập thành công ${count} nhân viên!`);
                input.value = ""; 
            };
            reader.readAsArrayBuffer(file);
        }

        function downloadTemplate() {
            const ws = XLSX.utils.aoa_to_sheet([['Mã NV','Họ Tên','Bộ Phận','Lương CB'],['NV01','Nguyễn Văn A','Kho',7000000]]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Mau");
            XLSX.writeFile(wb, "Mau_Nhan_Vien.xlsx");
        }

        // --- QUEUE ---
        function addToQueue(sid, d, f, v) {
            const k = `${d}_${sid}_${f}`;
            QUEUE.items = QUEUE.items.filter(i=>i.k!==k);
            QUEUE.items.push({k, sid, d, f, v});
            updateQueueUI(); clearTimeout(QUEUE.timer);
            QUEUE.timer = setTimeout(processQueue, TURBO_MODE?200:1000);
        }
        async function processQueue() {
            if(QUEUE.items.length===0||QUEUE.isSending) return;
            QUEUE.isSending=true; updateQueueUI();
            const batch = QUEUE.items.splice(0, QUEUE.batchSize);
            const payload={}; batch.forEach(i=>{ if(!payload[i.d])payload[i.d]={}; if(!payload[i.d][i.sid])payload[i.d][i.sid]={}; payload[i.d][i.sid][i.f]=i.v; });
            try { await fetch(API_URL+"?action=saveBatch&data="+encodeURIComponent(JSON.stringify(payload))); } catch(e) { QUEUE.items=[...batch,...QUEUE.items]; }
            QUEUE.isSending=false; updateQueueUI(); if(QUEUE.items.length>0) setTimeout(processQueue, 500);
        }
        function updateQueueUI() {
            const q=document.getElementById('queueStatus'); 
            if(QUEUE.items.length>0||QUEUE.isSending) { q.classList.remove('hidden'); document.getElementById('queueCountBadge').innerText=QUEUE.items.length; } 
            else q.classList.add('hidden');
        }

        // --- OT ---
        function handleSearchOT(e) { if(e.key==='Enter'||!e.target.value) renderOTFast(); }
        
        function parseSmartTime(val) {
            if(!val) return 0;
            const str = String(val).trim();
            if(str.includes(':')) {
                const parts = str.split(':');
                const h = parseInt(parts[0]) || 0;
                const m = parseInt(parts[1]) || 0;
                return parseFloat((h + m/60).toFixed(2));
            }
            return parseFloat(str) || 0;
        }

        function renderOTFast() {
            const date = document.getElementById('workDate').value;
            const dept = document.getElementById('deptFilter').value;
            const search = document.getElementById('searchOT').value.toLowerCase();
            const stdDays = parseInt(document.getElementById('stdDays').value)||26;
            let html=''; const dayData = DB.ot[date]||{};
            
            const filteredStaff = DB.staff.filter(s => {
                const sDept = s.dept ? s.dept.trim() : "";
                if(dept!=='all' && sDept!==dept) return false;
                if(search && !s.id.toLowerCase().includes(search)) return false;
                return true;
            });

            filteredStaff.forEach(s => {
                const o = dayData[s.id]||{h15:0,h21:0,h20:0,h35:0};
                const money = Math.round((o.h15*1.5+o.h21*2.1+o.h20*2.0+o.h35*3.5)*(s.salary/(stdDays*8)));
                const hl = search && s.id.toLowerCase()===search ? 'search-highlight' : '';
                html += `<tr class="${hl}" data-id="${s.id}"><td><input type="checkbox" class="ot-cb" data-id="${s.id}"></td><td><b>${s.name}</b><br><small style="color:#666">${s.id}</small></td><td><input type="text" class="ot-input-fast" value="${o.h15||''}" onchange="upOT('${s.id}','h15',this)"></td><td><input type="text" class="ot-input-fast" value="${o.h21||''}" onchange="upOT('${s.id}','h21',this)"></td><td><input type="text" class="ot-input-fast" value="${o.h20||''}" onchange="upOT('${s.id}','h20',this)"></td><td><input type="text" class="ot-input-fast" value="${o.h35||''}" onchange="upOT('${s.id}','h35',this)"></td><td class="money" id="m_${s.id}">${money.toLocaleString()}</td></tr>`;
            });
            document.getElementById('otBody').innerHTML = html || '<tr><td colspan="7" class="text-center">Không tìm thấy nhân viên</td></tr>';
        }
        function upOT(id, f, el) {
            const d = document.getElementById('workDate').value;
            const numVal = parseSmartTime(el.value);
            if(numVal !== 0) el.value = numVal; else if(el.value.trim() === '') el.value = '';
            
            if(!DB.ot[d]) DB.ot[d]={}; if(!DB.ot[d][id]) DB.ot[d][id]={};
            DB.ot[d][id][f] = numVal;
            saveLocal(); addToQueue(id, d, f, numVal);
            el.classList.add('updating'); setTimeout(()=>el.classList.remove('updating'),500); 
            const s = DB.staff.find(x => x.id === id);
            const stdDays = parseInt(document.getElementById('stdDays').value)||26;
            const o = DB.ot[d][id];
            const m = Math.round((o.h15*1.5+o.h21*2.1+o.h20*2.0+o.h35*3.5)*(s.salary/(stdDays*8)));
            document.getElementById(`m_${id}`).innerText = m.toLocaleString();
        }
        
        function applyBulk(sel) {
            const d=document.getElementById('workDate').value;
            const v15 = parseSmartTime(document.getElementById('b15').value);
            const v21 = parseSmartTime(document.getElementById('b21').value);
            const v20 = parseSmartTime(document.getElementById('b20').value);
            const v35 = parseSmartTime(document.getElementById('b35').value);
            const vals={h15:v15, h21:v21, h20:v20, h35:v35};
            
            let ids = [];
            if(sel) {
                ids = Array.from(document.querySelectorAll('.ot-cb:checked')).map(c=>c.dataset.id);
                if(ids.length===0) return alert("Chưa chọn NV nào!");
            } else {
                const rows = document.querySelectorAll('#otBody tr[data-id]');
                ids = Array.from(rows).map(row => row.dataset.id);
            }

            if(!DB.ot[d]) DB.ot[d]={};
            
            ids.forEach(id => { 
                DB.ot[d][id]={...vals}; 
                Object.keys(vals).forEach(k => addToQueue(id, d, k, vals[k]));
                const row = document.querySelector(`tr[data-id="${id}"]`);
                if(row) {
                    const inputs = row.querySelectorAll('input.ot-input-fast');
                    if(inputs.length >= 4) {
                        inputs[0].value = vals.h15 || ''; inputs[1].value = vals.h21 || '';
                        inputs[2].value = vals.h20 || ''; inputs[3].value = vals.h35 || '';
                    }
                    const s = DB.staff.find(x => x.id === id);
                    const stdDays = parseInt(document.getElementById('stdDays').value)||26;
                    const m = Math.round((vals.h15*1.5+vals.h21*2.1+vals.h20*2.0+vals.h35*3.5)*(s.salary/(stdDays*8)));
                    row.querySelector('.money').innerText = m.toLocaleString();
                }
            });
            saveLocal();
            alert(`Đã áp dụng cho ${ids.length} nhân viên`);
        }
        function clearDayOT() { if(confirm("Xóa hết ngày này?")) { delete DB.ot[document.getElementById('workDate').value]; saveLocal(); renderOTFast(); } }
        function toggleAllOT(e) { document.querySelectorAll('.ot-cb').forEach(c=>c.checked=e.checked); }

        // --- STAFF ---
        function addNewStaff() {
            const id=document.getElementById('addId').value, name=document.getElementById('addName').value;
            if(!id||!name) return alert("Thiếu thông tin");
            DB.staff.push({id, name, dept:document.getElementById('addDept').value, salary:parseFloat(document.getElementById('addSalary').value)||0});
            saveLocal(); renderStaff(); updateDeptList();
            document.getElementById('addId').value=''; document.getElementById('addName').value='';
        }
        function renderStaff() {
            const k=document.getElementById('searchStaff').value.toLowerCase();
            document.getElementById('staffBody').innerHTML = DB.staff.filter(s=>s.id.toLowerCase().includes(k)||s.name.toLowerCase().includes(k)).map(s=>`
                <tr><td><input type="checkbox" class="staff-cb" data-id="${s.id}"></td><td><b>${s.id}</b></td><td>${s.name}</td><td>${s.dept}</td><td>${(s.salary||0).toLocaleString()}</td><td><i class="fas fa-trash" style="color:red;cursor:pointer" onclick="delStaff('${s.id}')"></i></td></tr>
            `).join('');
        }
        function delStaff(id) { if(confirm("Xóa?")) { DB.staff=DB.staff.filter(s=>s.id!==id); saveLocal(); renderStaff(); updateDeptList(); } }
        function deleteSelectedStaff() {
            const ids=Array.from(document.querySelectorAll('.staff-cb:checked')).map(c=>c.dataset.id);
            if(ids.length>0 && confirm("Xóa chọn?")) { DB.staff=DB.staff.filter(s=>!ids.includes(s.id)); saveLocal(); renderStaff(); updateDeptList(); }
        }

        // --- HISTORY ---
        function initHistoryTab() {
            const depts=[...new Set(DB.staff.map(s=>s.dept ? s.dept.trim() : "").filter(d=>d))];
            document.getElementById('historyDeptFilter').innerHTML='<option value="all">Tất cả BP</option>'+depts.map(d=>`<option value="${d}">${d}</option>`).join('');
            updateHistoryDatalist();
        }
        function updateHistoryDatalist() {
            const d=document.getElementById('historyDeptFilter').value;
            const lst=d==='all'?DB.staff:DB.staff.filter(s=>(s.dept?s.dept.trim():"")===d);
            const select = document.getElementById('historyStaffId');
            select.innerHTML = '<option value="">-- Chọn Nhân Viên --</option>' + lst.map(s => `<option value="${s.id}">${s.id} - ${s.name}</option>`).join('');
        }
        function loadHistory() {
            const id=document.getElementById('historyStaffId').value;
            const dept=document.getElementById('historyDeptFilter').value;
            if(!id && dept === 'all') return alert("Vui lòng chọn Nhân viên hoặc Bộ phận");

            let targetStaffs = [];
            if(id) {
                const s = DB.staff.find(x => x.id === id);
                if(s) targetStaffs.push(s);
            } else {
                targetStaffs = DB.staff.filter(s => (s.dept?s.dept.trim():"") === dept);
            }

            if(targetStaffs.length === 1) {
                const s = targetStaffs[0];
                document.getElementById('historyUserInfo').classList.remove('hidden');
                document.getElementById('histName').innerText = s.name;
                document.getElementById('histDetail').innerText = `Mã: ${s.id} - BP: ${s.dept}`;
            } else {
                document.getElementById('historyUserInfo').classList.add('hidden');
            }
            document.getElementById('btnPrint').classList.remove('hidden');

            const f=document.getElementById('historyFrom').value, t=document.getElementById('historyTo').value;
            let html='', totalMoney=0;
            
            targetStaffs.forEach(staff => {
                if(targetStaffs.length > 1) { html += `<tr style="background:#e3f2fd"><td colspan="6"><b>${staff.name} (${staff.id})</b></td></tr>`; }
                Object.keys(DB.ot).sort().forEach(d => {
                    if((f&&d<f)||(t&&d>t)) return;
                    const o=DB.ot[d][staff.id];
                    if(o && (o.h15+o.h21+o.h20+o.h35)>0) {
                        const sum = o.h15+o.h21+o.h20+o.h35;
                        const m = (o.h15*1.5+o.h21*2.1+o.h20*2.0+o.h35*3.5)*(staff.salary/208);
                        totalMoney+=m;
                        html+=`<tr><td>${d}</td><td>${o.h15||'-'}</td><td>${o.h21||'-'}</td><td>${o.h20||'-'}</td><td>${o.h35||'-'}</td><td><b>${sum.toFixed(1)}</b></td></tr>`;
                    }
                });
            });
            document.getElementById('histTotalMoney').innerText=Math.round(totalMoney).toLocaleString()+' ₫';
            document.getElementById('historyBody').innerHTML=html||'<tr><td colspan="6" class="text-center">Không có dữ liệu</td></tr>';
        }
        function printHistory() {
            const content = document.getElementById('historyBody').parentNode.outerHTML;
            const w=window.open('','_blank');
            w.document.write(`<html><head><title>Phieu OT</title><style>body{font-family:sans-serif;padding:20px}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #333;padding:8px;text-align:center}.header{text-align:center;margin-bottom:20px}.info{margin-bottom:10px}</style></head><body>
                <div class="header"><h2>PHIẾU XÁC NHẬN TĂNG CA</h2><p>Ngày in: ${new Date().toLocaleDateString('vi-VN')}</p></div>
                ${content}
                <div style="margin-top:40px;display:flex;justify-content:space-between;padding:0 50px"><div><strong>Người lập</strong></div><div><strong>Nhân viên</strong></div></div>
            </body></html>`);
            w.document.close();
        }

        // --- REPORTS ---
        function renderReports() {
            const ctx = document.getElementById('deptChart').getContext('2d');
            const mode = document.getElementById('reportMonth').value;
            const stdDays = 26;
            const deptStats = {};
            let totalH = 0; let totalM = 0;

            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7);
            const lastMonthDate = new Date(today.setMonth(today.getMonth()-1));
            const lastMonth = lastMonthDate.toISOString().slice(0, 7);

            Object.keys(DB.ot).forEach(date => {
                if(mode === 'current' && !date.startsWith(currentMonth)) return;
                if(mode === 'last' && !date.startsWith(lastMonth)) return;

                const dayData = DB.ot[date];
                for(const sid in dayData) {
                    const ot = dayData[sid];
                    const h = (ot.h15||0) + (ot.h21||0) + (ot.h20||0) + (ot.h35||0);
                    if(h > 0) {
                        const s = DB.staff.find(x => x.id === sid);
                        const dept = s ? s.dept : "Khác";
                        const money = (ot.h15*1.5+ot.h21*2.1+ot.h20*2.0+ot.h35*3.5) * ((s?s.salary:0)/(stdDays*8));
                        if(!deptStats[dept]) deptStats[dept] = { hours: 0, money: 0 };
                        deptStats[dept].hours += h; deptStats[dept].money += money;
                        totalH += h; totalM += money;
                    }
                }
            });

            document.getElementById('repTotalHours').innerText = totalH.toFixed(1) + "h";
            document.getElementById('repTotalMoney').innerText = Math.round(totalM).toLocaleString() + " ₫";
            let maxH = 0; let topD = "Không có";
            for(const d in deptStats) { if(deptStats[d].hours > maxH) { maxH = deptStats[d].hours; topD = d; } }
            document.getElementById('repTopDept').innerText = topD;

            const labels = Object.keys(deptStats);
            const dataHours = labels.map(d => deptStats[d].hours);

            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Tổng giờ tăng ca', data: dataHours, backgroundColor: '#2196f3' }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- ACCOUNT & SYSTEM ---
        function createAccount() {
            const u=document.getElementById('newUsername').value, p=document.getElementById('newPassword').value;
            if(u&&p) { DB.users.push({username:u,password:p,role:document.getElementById('newRole').value,created:new Date().toISOString()}); saveLocal(); renderAccounts(); }
        }
        function renderAccounts() {
            document.getElementById('accountBody').innerHTML=DB.users.map(u=>`<tr><td><b>${u.username}</b></td><td>${u.role}</td><td>${u.created.split('T')[0]}</td><td><i class="fas fa-trash" onclick="if(confirm('Xóa?')){DB.users=DB.users.filter(x=>x.username!=='${u.username}');saveLocal();renderAccounts()}"></i></td></tr>`).join('');
        }
        function saveLocal() { localStorage.setItem('dongju_v55', JSON.stringify(DB)); }
        function loadLocal() { const d=localStorage.getItem('dongju_v55'); if(d) DB=JSON.parse(d); }
        function clearAllData() { if(confirm('Reset toàn bộ?')) { localStorage.removeItem('dongju_v55'); localStorage.removeItem('dongju_last_backup'); location.reload(); } }
        async function forceReload() {
            document.getElementById('syncStatus').innerText="Đang tải...";
            try { const res=await fetch(API_URL+"?action=load"); const d=await res.json(); if(d.success){ DB.staff=d.staff; DB.ot=d.ot; saveLocal(); location.reload(); } }
            catch(e){ alert("Lỗi tải: "+e); }
        }
        function saveStaffToCloud() {
            if(confirm("Lưu?")) fetch(API_URL+"?action=save&staff="+encodeURIComponent(JSON.stringify(DB.staff))+"&users="+encodeURIComponent(JSON.stringify(DB.users))).then(r=>r.json()).then(d=>alert(d.success?"Đã lưu":"Lỗi"));
        }
        function updateDeptList() {
            const d=[...new Set(DB.staff.map(s=>s.dept ? s.dept.trim() : "").filter(x=>x))];
            document.getElementById('deptFilter').innerHTML='<option value="all">Tất cả</option>'+d.map(x=>`<option value="${x}">${x}</option>`).join('');
        }
        function exportExcelFile() {
            const date=document.getElementById('workDate').value; if(!date) return alert("Chọn ngày");
            const [y,m]=date.split('-'); const days=new Date(y,m,0).getDate();
            const data=[['Mã','Tên','Bộ Phận','Lương CB']]; for(let i=1;i<=days;i++) data[0].push(i); data[0].push('TỔNG TIỀN');
            DB.staff.forEach(s=>{
                const r=[s.id,s.name,s.dept,s.salary]; let tM=0;
                for(let i=1;i<=days;i++){
                    const d=`${y}-${m}-${String(i).padStart(2,'0')}`; const o=(DB.ot[d]&&DB.ot[d][s.id])||{h15:0,h21:0,h20:0,h35:0};
                    const sum=o.h15+o.h21+o.h20+o.h35; r.push(sum>0?sum:"");
                    if(sum>0) tM+=Math.round((o.h15*1.5+o.h21*2.1+o.h20*2.0+o.h35*3.5)*(s.salary/208));
                }
                r.push(tM); data.push(r);
            });
            const ws=XLSX.utils.aoa_to_sheet(data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,`OT_${m}_${y}`); XLSX.writeFile(wb,`OT_${m}_${y}.xlsx`);
        }
        function toggleTurbo() { TURBO_MODE=!TURBO_MODE; document.getElementById('turboBtn').innerText=TURBO_MODE?"Turbo: ON":"Turbo: OFF"; QUEUE.batchSize=TURBO_MODE?50:20; }
    </script>
</body>
</html>
