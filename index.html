<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DONGJU SPORT - OT MANAGEMENT SYSTEM v4.0</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a237e;
            --primary-light: #534bae;
            --accent: #2962ff;
            --accent-light: #768fff;
            --success: #00c853;
            --warning: #ff9100;
            --danger: #ff1744;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-600: #475569;
            --gray-800: #1e293b;
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--gray-50);
            color: var(--gray-800);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary) 0%, #0d47a1 100%);
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .sidebar-header {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 1.6rem;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        .logo-subtitle {
            font-size: 0.75rem;
            color: var(--accent-light);
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .nav-items {
            padding: 20px 15px;
            flex-grow: 1;
        }

        .nav-item {
            padding: 14px 20px;
            margin: 8px 0;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
            color: white;
        }

        .nav-item.active {
            background: white;
            color: var(--primary);
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(41, 98, 255, 0.2);
        }

        .nav-item i {
            width: 24px;
            margin-right: 15px;
            font-size: 1.1rem;
        }

        /* Working Days Info in Sidebar */
        .working-days-sidebar {
            margin-top: auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.15);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .working-days-sidebar .title {
            font-weight: 600;
            color: var(--accent-light);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .working-days-sidebar .info {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
        }

        .sidebar-footer {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-name {
            font-weight: 600;
            color: var(--accent-light);
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .contact-info {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 10px;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .main-header {
            background: white;
            padding: 18px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid var(--gray-200);
            flex-shrink: 0;
            height: 70px;
        }

        .page-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }

        .header-tools {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .sync-status {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 8px 15px;
            border-radius: 20px;
            background: var(--gray-100);
            color: var(--gray-600);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 8px 16px;
            border-radius: 12px;
            border: 1px solid #e1bee7;
        }

        .date-label {
            font-weight: 600;
            color: #7b1fa2;
            font-size: 0.9rem;
        }

        #workDate {
            background: white;
            border: 2px solid #d1c4e9;
            border-radius: 8px;
            padding: 6px 12px;
            font-weight: 500;
            color: var(--gray-800);
            font-size: 0.9rem;
        }

        /* Fixed Toolbar Area */
        .fixed-toolbar-area {
            flex-shrink: 0;
            background: white;
            border-bottom: 1px solid var(--gray-200);
        }

        /* Stats Cards - OPTIMIZED HEIGHT (70px) */
        .stats-container {
            padding: 15px 30px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            height: 70px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 12px;
            height: 70px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .stat-content {
            flex: 1;
            min-width: 0;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--gray-600);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Filter Bar - SINGLE ROW */
        .filter-bar {
            padding: 15px 30px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: nowrap;
            overflow-x: auto;
            height: 70px;
        }

        .filter-bar::-webkit-scrollbar {
            height: 4px;
        }

        .filter-bar::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 2px;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .input-label {
            font-weight: 500;
            color: var(--gray-600);
            font-size: 0.9rem;
            white-space: nowrap;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            padding: 8px 12px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: white;
            min-width: 100px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(41, 98, 255, 0.1);
        }

        /* Bulk Edit */
        .bulk-edit {
            padding: 15px 30px;
            background: linear-gradient(135deg, #fff8e1, #f3e5f5);
            border-bottom: 2px solid #ffe57f;
            height: 80px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .bulk-header {
            font-weight: 700;
            color: #e65100;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            white-space: nowrap;
        }

        .coefficient-inputs {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: nowrap;
            overflow-x: auto;
            flex: 1;
        }

        .coefficient-inputs::-webkit-scrollbar {
            height: 4px;
        }

        .coef-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .coef-label {
            font-weight: 700;
            color: var(--primary);
            width: 40px;
            text-align: center;
        }

        /* Scrollable Content Area */
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 30px 30px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-200);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-100);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--accent);
        }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn-sm {
            padding: 7px 14px;
            font-size: 0.85rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(41, 98, 255, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #64dd17);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #ffab40);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #ff5252);
            color: white;
        }

        .btn-gray {
            background: linear-gradient(135deg, var(--gray-300), var(--gray-400));
            color: var(--gray-800);
        }

        .btn-edit {
            background: linear-gradient(135deg, #00bfa5, #1de9b6);
            color: white;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-200);
            margin-top: 20px;
        }

        .table-header {
            background: var(--gray-50);
            padding: 18px;
            border-bottom: 2px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--gray-50);
            padding: 16px 18px;
            text-align: left;
            font-weight: 600;
            color: var(--gray-600);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--gray-200);
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.9rem;
        }

        tr:hover {
            background: var(--gray-50);
        }

        .highlight {
            background-color: #fff8e1 !important;
        }

        /* OT Input Cells */
        .ot-input-fast {
            width: 70px;
            padding: 6px 8px;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            text-align: center;
            font-weight: 500;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .ot-input-fast:focus {
            border-color: var(--accent);
            background: #f0f7ff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(41, 98, 255, 0.1);
        }

        .ot-input-fast.updating {
            border-color: var(--warning);
            background: #fff8e1;
        }

        .money-cell {
            text-align: right;
            font-weight: 700;
            color: var(--danger);
            font-size: 0.9rem;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .money-cell.updating {
            color: var(--warning);
            background: #fff8e1;
            border-radius: 6px;
            animation: pulse 1s ease-in-out;
        }

        @keyframes pulse {
            0% { background-color: #fff8e1; }
            50% { background-color: #ffe57f; }
            100% { background-color: #fff8e1; }
        }

        /* Queue Status */
        .queue-status {
            background: linear-gradient(135deg, #fff3e0, #fff8e1);
            border: 2px solid #ffcc80;
            border-radius: 10px;
            padding: 12px;
            margin: 10px 30px;
            font-size: 0.85rem;
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }

        /* Speed Controls */
        .speed-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .speed-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .speed-badge.fast {
            background: rgba(0, 200, 83, 0.1);
            color: #00C853;
        }

        .speed-badge.slow {
            background: rgba(255, 152, 0, 0.1);
            color: #FF9800;
        }

        .speed-badge.turbo {
            background: rgba(255, 87, 34, 0.1);
            color: #FF5722;
            animation: pulseTurbo 2s infinite;
        }

        @keyframes pulseTurbo {
            0% { box-shadow: 0 0 5px #FF9800; }
            50% { box-shadow: 0 0 20px #FF5722; }
            100% { box-shadow: 0 0 5px #FF9800; }
        }

        /* Performance Stats */
        .perf-stats {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-family: monospace;
            z-index: 9999;
        }

        /* History Tab Styles */
        .weekday-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #e3f2fd;
            color: #1565c0;
            display: inline-block;
            min-width: 32px;
            text-align: center;
        }

        .weekday-badge.sunday {
            background: #ffebee;
            color: #c62828;
        }

        .history-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .history-stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid;
            text-align: center;
        }

        .history-stat-card:nth-child(1) { border-color: #4CAF50; }
        .history-stat-card:nth-child(2) { border-color: #2196F3; }
        .history-stat-card:nth-child(3) { border-color: #FF9800; }
        .history-stat-card:nth-child(4) { border-color: #9C27B0; }

        .history-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .history-stat-label {
            font-size: 0.9rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-success { background: #00C853; color: white; }
        .toast-warning { background: #FF9800; color: white; }
        .toast-error { background: #FF1744; color: white; }
        .toast-info { background: #2962FF; color: white; }

        /* Hidden utility */
        .hidden { display: none !important; }

        /* Validation */
        .validation-error {
            border-color: #ff1744 !important;
            background-color: #ffeef1 !important;
        }

        .error-message {
            color: #ff1744;
            font-size: 0.8rem;
            margin-top: 5px;
            display: block;
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar {
                width: 240px;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
                height: auto;
                gap: 10px;
            }
            
            .stat-card {
                height: 65px;
                padding: 10px 14px;
            }
            
            .stat-value {
                font-size: 1.3rem;
            }
            
            .filter-bar {
                flex-wrap: wrap;
                height: auto;
                padding: 12px 20px;
            }
            
            .bulk-edit {
                flex-wrap: wrap;
                height: auto;
                padding: 12px 20px;
            }
            
            .coefficient-inputs {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .sidebar-header {
                width: 100%;
                padding: 15px;
            }
            
            .nav-items {
                display: flex;
                padding: 10px;
                overflow-x: auto;
            }
            
            .nav-item {
                padding: 10px 15px;
                margin: 0 5px;
                flex-shrink: 0;
            }
            
            .working-days-sidebar {
                display: none;
            }
            
            .main-header {
                padding: 12px 15px;
                height: 60px;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
                padding: 10px 15px;
            }
            
            .filter-bar {
                padding: 10px 15px;
            }
            
            .scrollable-content {
                padding: 0 15px 15px;
            }
            
            .history-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .history-stats {
                grid-template-columns: 1fr;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            
            .ot-input-fast {
                width: 60px;
                padding: 5px;
            }
        }
    </style>
</head>
<body>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Performance Stats -->
    <div id="perfStats" class="perf-stats hidden">
        ‚ö° <span id="batchSize">20</span> ng∆∞·ªùi/batch | 
        üìä <span id="queueCount">0</span> ch·ªù
    </div>

    <!-- Main App -->
    <div class="app-container" id="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">DONGJU SPORT VN</div>
                <div class="logo-subtitle">OT MANAGEMENT v4.0</div>
            </div>
            
            <div class="nav-items">
                <div id="nav-staff" class="nav-item active" onclick="switchTab('staff')">
                    <i class="fas fa-users-cog"></i>
                    <span>Qu·∫£n l√Ω nh√¢n s·ª±</span>
                </div>
                <div id="nav-ot" class="nav-item" onclick="switchTab('ot')">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Ch·∫•m c√¥ng OT</span>
                </div>
                <div id="nav-history" class="nav-item" onclick="switchTab('history')">
                    <i class="fas fa-history"></i>
                    <span>L·ªãch s·ª≠ OT</span>
                </div>
            </div>
            
            <!-- Working Days Info in Sidebar -->
            <div class="working-days-sidebar">
                <div class="title">
                    <i class="fas fa-calendar-alt"></i>
                    Th√¥ng tin ng√†y c√¥ng
                </div>
                <div class="info" id="workingDaysSidebarInfo">
                    ƒêang t·∫£i th√¥ng tin...
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-name">Designed by Thanh Tien</div>
                <div class="contact-info">
                    <i class="fas fa-phone-alt"></i> 09.18.28.38.25
                </div>
                <div style="margin-top: 10px; font-size: 0.75rem; color: rgba(255,255,255,0.6);">
                    <i class="fas fa-database"></i> Storage: <span id="storageStatus">Google Sheet</span>
                </div>
                <button class="btn btn-danger btn-sm" onclick="clearAllData()" 
                        style="width:100%; margin-top:15px; padding:8px; font-size:0.8rem;">
                    <i class="fas fa-trash-alt"></i> X√≥a d·ªØ li·ªáu c·ª•c b·ªô
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Fixed Header -->
            <div class="main-header">
                <div class="page-title" id="page-title">QU·∫¢N L√ù NH√ÇN S·ª∞</div>
                <div class="header-tools">
                    <div id="syncStatus" class="sync-status">
                        <i class="fas fa-check-circle" style="color:var(--success)"></i>
                        <span id="syncStatusText">S·∫µn s√†ng</span>
                    </div>
                    <div id="date-tool" class="date-selector hidden">
                        <div class="date-label">
                            <i class="fas fa-calendar-alt"></i> Ng√†y:
                        </div>
                        <input type="date" id="workDate" onchange="handleDateChange()">
                    </div>
                    <button class="btn btn-sm" style="background:#e3f2fd; color:#1565c0;" onclick="showQueueStatus()">
                        <i class="fas fa-tasks"></i> Tr·∫°ng th√°i
                    </button>
                </div>
            </div>

            <!-- Fixed Toolbar Area (for OT tab only) -->
            <div id="fixed-toolbar-area" class="fixed-toolbar-area hidden">
                <!-- Stats Cards -->
                <div id="stats-cards" class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-total-staff">0</div>
                            <div class="stat-label">T·ªïng nh√¢n vi√™n</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-total-ot">0</div>
                            <div class="stat-label">T·ªïng gi·ªù OT th√°ng</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-total-money">0 ‚Ç´</div>
                            <div class="stat-label">T·ªïng ti·ªÅn OT</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-today-ot">0</div>
                            <div class="stat-label">NV c√≥ OT trong th√°ng</div>
                        </div>
                    </div>
                </div>

                <!-- Filter Bar - SINGLE ROW -->
                <div class="filter-bar">
                    <div class="input-group">
                        <span class="input-label">B·ªô ph·∫≠n:</span>
                        <select id="deptFilter" onchange="handleFilterChange()" style="width:150px">
                            <option value="all">T·∫•t c·∫£</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <span class="input-label">Ng√†y c√¥ng:</span>
                        <input type="number" id="stdDays" value="26" style="width:80px" min="14" max="26" step="1" onchange="handleStdDaysChange()">
                    </div>
                    
                    <button class="btn btn-primary btn-sm" onclick="renderOTFast(true)">
                        <i class="fas fa-filter"></i> Ch·ªâ hi·ªán c√≥ OT
                    </button>
                    
                    <button class="btn btn-gray btn-sm" onclick="renderOTFast(false)">
                        <i class="fas fa-users"></i> Hi·ªán t·∫•t c·∫£
                    </button>
                    
                    <button class="btn btn-success btn-sm" onclick="validateAndExport()">
                        <i class="fas fa-file-excel"></i> Xu·∫•t Excel
                    </button>
                    
                    <button class="btn btn-sm" style="background:#0F9D58; color:white;" onclick="manualSaveToGoogleSheet()">
                        <i class="fab fa-google-drive"></i> L∆∞u Google Sheet
                    </button>
                    
                    <button class="btn btn-warning btn-sm" onclick="forceProcessQueue()">
                        <i class="fas fa-bolt"></i> ƒê·ªìng b·ªô ngay
                    </button>
                </div>

                <!-- Bulk Edit -->
                <div class="bulk-edit">
                    <div class="bulk-header">
                        <i class="fas fa-bolt"></i>
                        G√ÅN NHANH GI·ªú OT
                    </div>
                    <div class="coefficient-inputs">
                        <div class="coef-group">
                            <span class="coef-label">1.5</span>
                            <input type="number" id="b15" step="0.1" value="0.0" class="ot-input-fast">
                        </div>
                        <div class="coef-group">
                            <span class="coef-label">2.1</span>
                            <input type="number" id="b21" step="0.1" value="0.0" class="ot-input-fast">
                        </div>
                        <div class="coef-group">
                            <span class="coef-label">2.0</span>
                            <input type="number" id="b20" step="0.1" value="0.0" class="ot-input-fast">
                        </div>
                        <div class="coef-group">
                            <span class="coef-label">3.5</span>
                            <input type="number" id="b35" step="0.1" value="0.0" class="ot-input-fast">
                        </div>
                        
                        <button class="btn btn-warning btn-sm" onclick="applyBulk(true)">
                            <i class="fas fa-check"></i> √Åp d·ª•ng d√≤ng ch·ªçn
                        </button>
                        
                        <button class="btn btn-gray btn-sm" onclick="applyBulk(false)">
                            <i class="fas fa-check-double"></i> √Åp d·ª•ng t·∫•t c·∫£
                        </button>
                        
                        <button class="btn btn-danger btn-sm" onclick="clearDay()">
                            <i class="fas fa-trash-alt"></i> X√≥a ng√†y n√†y
                        </button>
                    </div>
                </div>
            </div>

            <!-- Queue Status -->
            <div id="queueStatus" class="queue-status hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <strong><i class="fas fa-sync-alt"></i> H√†ng ƒë·ª£i ƒë·ªìng b·ªô</strong>
                    <span id="queueCountBadge" class="speed-badge">0 ƒëang ch·ªù</span>
                </div>
                <div class="progress-container">
                    <div id="queueProgress" class="progress-bar" style="width:0%"></div>
                </div>
                <div id="queueDetails" style="font-size:0.8rem; margin-top:8px; color:#666;">
                    <i class="fas fa-info-circle"></i> T·ª± ƒë·ªông g·ª≠i 20 ng∆∞·ªùi/l·∫ßn
                </div>
            </div>

            <!-- Scrollable Content Area -->
            <div class="scrollable-content" id="content-area">
                <!-- Staff Management Tab -->
                <div id="tab-staff">
                    <!-- Add Staff Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-user-plus"></i>
                                TH√äM NH√ÇN VI√äN M·ªöI
                            </div>
                        </div>
                        <div class="toolbar" style="display:flex; gap:10px; flex-wrap:wrap;">
                            <input type="text" id="addId" placeholder="M√£ NV" style="width:120px">
                            <input type="text" id="addName" placeholder="H·ªç T√™n" style="width:200px">
                            <input type="text" id="addDept" placeholder="B·ªô Ph·∫≠n" style="width:150px">
                            <input type="number" id="addSalary" placeholder="L∆∞∆°ng CB" style="width:150px" 
                                   oninput="validateSalaryInput(this)">
                            <button class="btn btn-primary" onclick="addNewStaff()">
                                <i class="fas fa-plus"></i> Th√™m m·ªõi
                            </button>
                            <button class="btn btn-sm" style="background:#0F9D58; color:white;" onclick="saveStaffToGoogleSheet()">
                                <i class="fab fa-google-drive"></i> L∆∞u l√™n Google Sheet
                            </button>
                        </div>
                    </div>

                    <!-- Staff Management Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-users"></i>
                                DANH S√ÅCH NH√ÇN VI√äN
                            </div>
                        </div>
                        <div class="toolbar" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <div class="input-group">
                                <i class="fas fa-search" style="color:var(--gray-400)"></i>
                                <input type="text" id="searchStaff" placeholder="T√¨m M√£ NV ho·∫∑c T√™n..." 
                                       style="width:300px" onkeyup="renderStaff()">
                            </div>
                            
                            <label for="fileInput" class="btn btn-gray">
                                <i class="fas fa-file-import"></i> Nh·∫≠p Excel
                            </label>
                            <input type="file" id="fileInput" style="display:none" onchange="importExcel(this)">
                            
                            <button class="btn btn-sm" style="background:#4285F4; color:white;" onclick="loadFromGoogleSheet()">
                                <i class="fab fa-google"></i> T·∫£i t·ª´ Google Sheet
                            </button>
                            
                            <button class="btn btn-danger" onclick="deleteStaff()" style="margin-left:auto">
                                <i class="fas fa-user-minus"></i> X√≥a ƒë√£ ch·ªçn
                            </button>
                        </div>

                        <div class="table-container">
                            <div class="table-header">
                                T·ªïng: <span id="staff-count">0</span> nh√¢n vi√™n
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width:50px">
                                            <input type="checkbox" onclick="toggleAllStaff(this)">
                                        </th>
                                        <th>M√É NV</th>
                                        <th>H·ªå T√äN</th>
                                        <th>B·ªò PH·∫¨N</th>
                                        <th>L∆Ø∆†NG CB</th>
                                        <th style="width:120px">THAO T√ÅC</th>
                                    </tr>
                                </thead>
                                <tbody id="staffBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- OT Management Tab -->
                <div id="tab-ot" class="hidden">
                    <!-- OT Table Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-table"></i>
                                B·∫¢NG CH·∫§M C√îNG OT
                            </div>
                        </div>
                        <div class="table-container" id="otTableContainer">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width:50px">
                                            <input type="checkbox" onclick="toggleAllOT(this)">
                                        </th>
                                        <th>NH√ÇN VI√äN</th>
                                        <th>1.5</th>
                                        <th>2.1</th>
                                        <th>2.0</th>
                                        <th>3.5</th>
                                        <th style="text-align:right; color:var(--danger);">TI·ªÄN NG√ÄY</th>
                                    </tr>
                                </thead>
                                <tbody id="otBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="tab-history" class="hidden">
                    <!-- Search and Filter -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-search"></i>
                                T√åM KI·∫æM L·ªäCH S·ª¨ OT THEO M√É NV
                            </div>
                        </div>
                        <div class="toolbar" style="display:flex; gap:10px; flex-wrap:wrap;">
                            <div class="input-group">
                                <span class="input-label">M√£ NV:</span>
                                <input type="text" id="historyStaffSearch" placeholder="Nh·∫≠p m√£ nh√¢n vi√™n" style="width:200px">
                            </div>
                            
                            <div class="input-group">
                                <span class="input-label">Th√°ng:</span>
                                <input type="month" id="historyMonth" style="width:150px" 
                                       onchange="loadStaffOTHistoryFromLocal()">
                            </div>
                            
                            <div class="input-group">
                                <span class="input-label">T·ª´ ng√†y:</span>
                                <input type="date" id="historyFrom" style="width:150px" onchange="loadStaffOTHistoryFromLocal()">
                            </div>
                            
                            <div class="input-group">
                                <span class="input-label">ƒê·∫øn ng√†y:</span>
                                <input type="date" id="historyTo" style="width:150px" onchange="loadStaffOTHistoryFromLocal()">
                            </div>
                            
                            <button class="btn btn-primary" onclick="searchStaffById()">
                                <i class="fas fa-search"></i> T√¨m theo M√£ NV
                            </button>
                            
                            <button class="btn btn-success" onclick="exportStaffHistory()" style="margin-left:auto">
                                <i class="fas fa-file-excel"></i> Xu·∫•t Excel
                            </button>
                            
                            <button class="btn btn-warning" onclick="printStaffHistory()">
                                <i class="fas fa-print"></i> In b√°o c√°o
                            </button>
                        </div>
                    </div>

                    <!-- Stats Card -->
                    <div class="card" style="border-left:5px solid #4CAF50;">
                        <div class="card-header">
                            <div class="card-title" style="color:#4CAF50;">
                                <i class="fas fa-chart-bar"></i>
                                TH·ªêNG K√ä OT NH√ÇN VI√äN
                            </div>
                        </div>
                        <div class="history-stats">
                            <div class="history-stat-card">
                                <div class="history-stat-value" id="history-total-hours">0</div>
                                <div class="history-stat-label">T·ªïng gi·ªù OT</div>
                            </div>
                            <div class="history-stat-card">
                                <div class="history-stat-value" id="history-total-days">0</div>
                                <div class="history-stat-label">S·ªë ng√†y OT</div>
                            </div>
                            <div class="history-stat-card">
                                <div class="history-stat-value" id="history-total-money">0 ‚Ç´</div>
                                <div class="history-stat-label">T·ªïng ti·ªÅn OT</div>
                            </div>
                            <div class="history-stat-card">
                                <div class="history-stat-value" id="history-avg-day">0 ‚Ç´</div>
                                <div class="history-stat-label">Trung b√¨nh/ng√†y</div>
                            </div>
                        </div>
                    </div>

                    <!-- History Table -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-table"></i>
                                CHI TI·∫æT L·ªäCH S·ª¨ OT
                                <span id="history-staff-name" style="color:var(--primary); margin-left:10px;"></span>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>NG√ÄY</th>
                                        <th>TH·ª®</th>
                                        <th>1.5</th>
                                        <th>2.1</th>
                                        <th>2.0</th>
                                        <th>3.5</th>
                                        <th>T·ªîNG GI·ªú</th>
                                        <th>TI·ªÄN NG√ÄY</th>
                                        <th>GHI CH√ö</th>
                                    </tr>
                                </thead>
                                <tbody id="historyBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CORE SYSTEM ==========
        const GOOGLE_SHEET_API = "https://script.google.com/macros/s/AKfycbys53jjWG4HbzEUbDf-cGSHEQTDH_y1doNbkG4m8GHDT5mlC7z9ZsJb00YzGXXekSBK/exec";
        
        // ========== AUTO SAVE QUEUE SYSTEM - OPTIMIZED FOR 400 EMPLOYEES ==========
        let AUTO_SAVE_QUEUE = {
            pending: {},
            isProcessing: false,
            batchSize: 20,
            totalProcessed: 0,
            totalFailed: 0,
            lastProcessedTime: 0,
            cache: new Map(),
            cacheDuration: 30000
        };
        
        let TURBO_MODE = false;
        let CONNECTION_SPEED = 'NORMAL';
        
        // ========== DATA STRUCTURE ==========
        let DB = { 
            staff: [], 
            ot: {},
            settings: {}
        };
        
        let STATS_CACHE = {
            totalMoney: 0,
            totalHours: 0,
            todayOTCount: 0,
            isDirty: true
        };
        
        let currentUser = "admin";
        let hasSuggestedWorkingDays = false;
        
        const WORKING_DAYS_SETTINGS = {
            minDays: 14,
            maxDays: 26,
            defaultDays: 26
        };
        
        // ========== UTILITY FUNCTIONS ==========
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'warning' ? 'fa-exclamation-triangle' : 
                                 type === 'error' ? 'fa-exclamation-circle' : 
                                 type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 3000);
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // ========== LOCAL STORAGE ==========
        function saveToLocalStorage() {
            try {
                const backupData = {
                    staff: DB.staff,
                    ot: DB.ot,
                    settings: DB.settings,
                    timestamp: new Date().toISOString(),
                    version: '4.0'
                };
                
                localStorage.setItem('dongju_ot_backup', JSON.stringify(backupData));
                return true;
            } catch(e) {
                console.error("‚ùå L·ªói l∆∞u localStorage:", e);
                return false;
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('dongju_ot_backup');
                if(saved) {
                    const data = JSON.parse(saved);
                    DB.staff = data.staff || DB.staff;
                    DB.ot = data.ot || DB.ot;
                    DB.settings = data.settings || DB.settings;
                    return true;
                }
            } catch(e) {
                console.error("‚ùå L·ªói ƒë·ªçc localStorage:", e);
            }
            return false;
        }
        
        function clearAllData() {
            if(!confirm("X√°c nh·∫≠n x√≥a to√†n b·ªô d·ªØ li·ªáu c·ª•c b·ªô?\n\nD·ªØ li·ªáu tr√™n Google Sheet s·∫Ω KH√îNG b·ªã x√≥a.\nCh·ªâ x√≥a d·ªØ li·ªáu trong tr√¨nh duy·ªát n√†y.")) return;
            
            localStorage.removeItem('dongju_ot_backup');
            DB = { 
                staff: [], 
                ot: {},
                settings: {}
            };
            
            AUTO_SAVE_QUEUE.pending = {};
            AUTO_SAVE_QUEUE.totalProcessed = 0;
            AUTO_SAVE_QUEUE.totalFailed = 0;
            
            renderStaff();
            updateQueueStatusDisplay();
            showToast("‚úÖ ƒê√£ x√≥a d·ªØ li·ªáu c·ª•c b·ªô!", 'success');
        }
        
        // ========== STAFF MANAGEMENT ==========
        function addNewStaff() {
            const id = document.getElementById('addId').value.trim();
            const name = document.getElementById('addName').value.trim();
            const dept = document.getElementById('addDept').value.trim();
            const salary = parseFloat(document.getElementById('addSalary').value);
            
            if(!id || !name || !dept || isNaN(salary) || salary <= 0) {
                showToast("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin h·ª£p l·ªá!", 'error');
                return;
            }
            
            if(DB.staff.some(s => s.id === id)) {
                showToast("M√£ nh√¢n vi√™n n√†y ƒë√£ t·ªìn t·∫°i!", 'error');
                return;
            }
            
            DB.staff.push({ id, name, dept, salary });
            renderStaff();
            updateDeptList();
            
            document.getElementById('addId').value = "";
            document.getElementById('addName').value = "";
            document.getElementById('addDept').value = "";
            document.getElementById('addSalary').value = "";
            
            saveToLocalStorage();
            showToast(`‚úÖ ƒê√£ th√™m ${name} v√†o danh s√°ch!`, 'success');
        }
        
        function validateSalaryInput(input) {
            const value = parseFloat(input.value);
            if(isNaN(value) || value <= 0) {
                input.classList.add('validation-error');
            } else {
                input.classList.remove('validation-error');
            }
        }
        
        function renderStaff() {
            const keyword = document.getElementById('searchStaff').value.toLowerCase();
            const filtered = DB.staff.filter(s => {
                const staffId = (s.id || '').toString().toLowerCase();
                const staffName = (s.name || '').toString().toLowerCase();
                return staffId.includes(keyword) || staffName.includes(keyword);
            });
            
            let html = '';
            filtered.forEach(s => {
                html += `
                <tr id="row-${s.id}">
                    <td><input type="checkbox" class="staff-cb" data-id="${s.id}"></td>
                    <td><strong>${s.id}</strong></td>
                    <td>${s.name}</td>
                    <td><span style="background:#e3f2fd; padding:4px 12px; border-radius:20px; font-size:0.85rem;">${s.dept}</span></td>
                    <td style="font-weight:bold; color:var(--primary);">${Number(s.salary).toLocaleString()} ‚Ç´</td>
                    <td>
                        <button class="btn btn-edit btn-sm" onclick="editStaff('${s.id}')">
                            <i class="fas fa-edit"></i> S·ª≠a
                        </button>
                    </td>
                </tr>`;
            });
            
            document.getElementById('staffBody').innerHTML = html;
            document.getElementById('staff-count').textContent = filtered.length;
        }
        
        function editStaff(id) {
            const staff = DB.staff.find(s => s.id === id);
            if(!staff) return;
            
            const newName = prompt("S·ª≠a t√™n nh√¢n vi√™n:", staff.name);
            if(newName === null) return;
            if(newName.trim() === "") {
                showToast("T√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!", 'error');
                return;
            }
            
            const newDept = prompt("S·ª≠a b·ªô ph·∫≠n:", staff.dept);
            if(newDept === null) return;
            
            const newSalary = prompt("S·ª≠a l∆∞∆°ng c∆° b·∫£n:", staff.salary);
            if(newSalary === null) return;
            const salaryNum = parseFloat(newSalary);
            if(isNaN(salaryNum) || salaryNum <= 0) {
                showToast("L∆∞∆°ng ph·∫£i l√† s·ªë d∆∞∆°ng!", 'error');
                return;
            }
            
            staff.name = newName.trim();
            staff.dept = newDept.trim();
            staff.salary = salaryNum;
            
            renderStaff();
            updateDeptList();
            saveToLocalStorage();
            showToast(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin ${staff.name}!`, 'success');
        }
        
        function deleteStaff() {
            const ids = Array.from(document.querySelectorAll('.staff-cb:checked')).map(cb => cb.dataset.id);
            if(ids.length === 0) {
                showToast("Vui l√≤ng ch·ªçn nh√¢n s·ª±!", 'warning');
                return;
            }
            
            if(!confirm(`X√≥a ${ids.length} nh√¢n s·ª± n√†y?`)) return;
            
            DB.staff = DB.staff.filter(s => !ids.includes(s.id));
            renderStaff();
            updateDeptList();
            saveToLocalStorage();
            showToast(`‚úÖ ƒê√£ x√≥a ${ids.length} nh√¢n s·ª±!`, 'success');
        }
        
        function toggleAllStaff(el) { 
            document.querySelectorAll('.staff-cb').forEach(cb => cb.checked = el.checked); 
        }
        
        function importExcel(input) {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                    const newStaff = json.slice(1).filter(r => r[0]).map(r => ({ 
                        id: String(r[0]).trim(), 
                        name: String(r[1] || '').trim(), 
                        dept: String(r[2] || '').trim(), 
                        salary: parseFloat(r[3]) || 0 
                    }));
                    
                    DB.staff = [...DB.staff, ...newStaff.filter(newS => 
                        !DB.staff.some(existing => existing.id === newS.id)
                    )];
                    
                    renderStaff();
                    updateDeptList();
                    saveToLocalStorage();
                    showToast(`‚úÖ ƒê√£ nh·∫≠p ${newStaff.length} nh√¢n vi√™n t·ª´ Excel!`, 'success');
                } catch(error) {
                    showToast("‚ùå L·ªói ƒë·ªçc file Excel!", 'error');
                    console.error("Import error:", error);
                }
            };
            reader.readAsArrayBuffer(input.files[0]);
        }
        
        // ========== OT MANAGEMENT ==========
        function updateDeptList() {
            const depts = [...new Set(DB.staff.map(s => s.dept).filter(dept => dept))];
            const select = document.getElementById('deptFilter');
            select.innerHTML = '<option value="all">T·∫•t c·∫£ b·ªô ph·∫≠n</option>' + 
                depts.map(d => `<option value="${d}">${d}</option>`).join('');
        }
        
        function renderOTFast(onlyOT = false) {
            const date = document.getElementById('workDate').value;
            if(!date) return;
            
            const dept = document.getElementById('deptFilter').value;
            const days = parseFloat(document.getElementById('stdDays').value) || WORKING_DAYS_SETTINGS.defaultDays;
            const otToday = DB.ot[date] || {};
            
            let html = '';
            
            if(STATS_CACHE.isDirty) {
                updateStatsFull();
            }
            
            DB.staff.forEach(s => {
                if(dept !== 'all' && s.dept !== dept) return;
                
                const d = otToday[s.id] || {h15:0, h21:0, h20:0, h35:0};
                if(onlyOT && (d.h15 + d.h21 + d.h20 + d.h35) === 0) return;
                
                const h15 = Number(d.h15) || 0;
                const h21 = Number(d.h21) || 0;
                const h20 = Number(d.h20) || 0;
                const h35 = Number(d.h35) || 0;
                const salary = Number(s.salary) || 0;
                
                let money = 0;
                if(salary > 0 && days > 0) {
                    const hourlyRate = salary / (days * 8);
                    money = (h15 * 1.5 + h21 * 2.1 + h20 * 2.0 + h35 * 3.5) * hourlyRate;
                }
                
                const hasOT = (h15 + h21 + h20 + h35) > 0;
                
                html += `<tr data-id="${s.id}" class="${hasOT ? 'highlight' : ''}">
                    <td><input type="checkbox" class="ot-cb" data-id="${s.id}"></td>
                    <td>
                        <div style="font-weight:600;">${s.name}</div>
                        <div style="font-size:0.85rem; color:var(--gray-600);">${s.id} ‚Ä¢ ${s.dept}</div>
                    </td>
                    <td><input type="number" value="${h15}" step="0.1" min="0" 
                           class="ot-input-fast" data-id="${s.id}" data-field="h15" 
                           oninput="handleOTInput(this)"></td>
                    <td><input type="number" value="${h21}" step="0.1" min="0" 
                           class="ot-input-fast" data-id="${s.id}" data-field="h21"
                           oninput="handleOTInput(this)"></td>
                    <td><input type="number" value="${h20}" step="0.1" min="0" 
                           class="ot-input-fast" data-id="${s.id}" data-field="h20"
                           oninput="handleOTInput(this)"></td>
                    <td><input type="number" value="${h35}" step="0.1" min="0" 
                           class="ot-input-fast" data-id="${s.id}" data-field="h35"
                           oninput="handleOTInput(this)"></td>
                    <td class="money-cell" data-id="${s.id}">
                        ${isNaN(money) ? '0' : Math.round(money).toLocaleString()} ‚Ç´
                    </td>
                </tr>`;
            });
            
            document.getElementById('otBody').innerHTML = html || 
                '<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--gray-400);">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        }
        
        const handleOTInput = debounce(function(input) {
            const id = input.dataset.id;
            const field = input.dataset.field;
            const value = parseFloat(input.value) || 0;
            const date = document.getElementById('workDate').value;
            
            if(!date) return;
            
            const oldValue = (DB.ot[date] && DB.ot[date][id] && DB.ot[date][id][field]) || 0;
            
            if(!DB.ot[date]) DB.ot[date] = {};
            if(!DB.ot[date][id]) DB.ot[date][id] = {h15:0, h21:0, h20:0, h35:0};
            DB.ot[date][id][field] = value;
            
            addToAutoSaveQueue(id, date, field, value);
            
            saveToLocalStorage();
            
            updateRowMoney(id, date);
            updateStatsIncremental(id, field, oldValue, value, date);
            
            input.classList.add('updating');
            setTimeout(() => input.classList.remove('updating'), 300);
        }, 300);
        
        function addToAutoSaveQueue(staffId, date, field, value) {
            const key = `${date}_${staffId}`;
            
            if (!AUTO_SAVE_QUEUE.pending[key]) {
                AUTO_SAVE_QUEUE.pending[key] = {
                    staffId,
                    date,
                    data: {},
                    timestamp: Date.now()
                };
            }
            
            AUTO_SAVE_QUEUE.pending[key].data[field] = value;
            AUTO_SAVE_QUEUE.pending[key].timestamp = Date.now();
            
            if (!AUTO_SAVE_QUEUE.isProcessing) {
                setTimeout(processAutoSaveQueue, 5000);
            }
            
            updateQueueStatusDisplay();
        }
        
        async function processAutoSaveQueue() {
            if (AUTO_SAVE_QUEUE.isProcessing || Object.keys(AUTO_SAVE_QUEUE.pending).length === 0) {
                return;
            }
            
            AUTO_SAVE_QUEUE.isProcessing = true;
            
            try {
                const pendingArray = Object.values(AUTO_SAVE_QUEUE.pending);
                const batches = [];
                
                for (let i = 0; i < pendingArray.length; i += AUTO_SAVE_QUEUE.batchSize) {
                    const batch = pendingArray.slice(i, i + AUTO_SAVE_QUEUE.batchSize);
                    batches.push(batch);
                }
                
                for (let i = 0; i < batches.length; i++) {
                    const batch = batches[i];
                    const batchData = {};
                    
                    batch.forEach(item => {
                        if (!batchData[item.date]) {
                            batchData[item.date] = {};
                        }
                        batchData[item.date][item.staffId] = item.data;
                    });
                    
                    const success = await sendBatchToGoogleSheet(batchData);
                    
                    if (success) {
                        batch.forEach(item => {
                            delete AUTO_SAVE_QUEUE.pending[`${item.date}_${item.staffId}`];
                        });
                        
                        AUTO_SAVE_QUEUE.totalProcessed += batch.length;
                        AUTO_SAVE_QUEUE.lastProcessedTime = Date.now();
                        
                        updateSyncStatus(`ƒê√£ ƒë·ªìng b·ªô ${batch.length} nh√¢n vi√™n`);
                    } else {
                        break;
                    }
                    
                    updateQueueStatusDisplay();
                    
                    if (i < batches.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
            } catch (error) {
                console.error("L·ªói auto save processor:", error);
                showToast('‚ùå L·ªói ƒë·ªìng b·ªô: ' + error.message, 'error');
            } finally {
                AUTO_SAVE_QUEUE.isProcessing = false;
                updateQueueStatusDisplay();
            }
        }
        
        async function sendBatchToGoogleSheet(batchData) {
            if (Object.keys(batchData).length === 0) return true;
            
            try {
                const url = GOOGLE_SHEET_API + 
                    '?action=saveBatch' +
                    '&data=' + encodeURIComponent(JSON.stringify(batchData)) +
                    '&timestamp=' + encodeURIComponent(new Date().toISOString()) +
                    '&user=' + encodeURIComponent(currentUser) +
                    '&t=' + Date.now();
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(url, { 
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const recordCount = Object.values(batchData).reduce((sum, dateData) => 
                        sum + Object.keys(dateData).length, 0);
                    console.log(`‚úÖ ƒê√£ g·ª≠i ${recordCount} nh√¢n vi√™n`);
                    return true;
                } else {
                    console.warn('‚ö†Ô∏è API tr·∫£ v·ªÅ l·ªói:', result.error);
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå L·ªói g·ª≠i batch:', error);
                return false;
            }
        }
        
        function updateRowMoney(id, date) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if(!row) return;
            
            const staff = DB.staff.find(s => s.id === id);
            if (!staff) return;
            
            const days = parseFloat(document.getElementById('stdDays').value) || WORKING_DAYS_SETTINGS.defaultDays;
            const ot = DB.ot[date] && DB.ot[date][id] || {h15:0, h21:0, h20:0, h35:0};
            
            const h15 = Number(ot.h15) || 0;
            const h21 = Number(ot.h21) || 0;
            const h20 = Number(ot.h20) || 0;
            const h35 = Number(ot.h35) || 0;
            
            let money = 0;
            if(staff.salary > 0 && days > 0) {
                const hourlyRate = staff.salary / (days * 8);
                money = (h15 * 1.5 + h21 * 2.1 + h20 * 2.0 + h35 * 3.5) * hourlyRate;
            }
            
            const moneyCell = row.querySelector('.money-cell');
            if(moneyCell) {
                moneyCell.textContent = isNaN(money) ? '0 ‚Ç´' : Math.round(money).toLocaleString() + ' ‚Ç´';
                moneyCell.classList.add('updating');
                setTimeout(() => moneyCell.classList.remove('updating'), 300);
            }
            
            const hasOT = (h15 + h21 + h20 + h35) > 0;
            if(hasOT) {
                row.classList.add('highlight');
            } else {
                row.classList.remove('highlight');
            }
        }
        
        function updateStatsIncremental(id, field, oldValue, newValue, date) {
            const staff = DB.staff.find(s => s.id === id);
            if(!staff) return;
            
            const salary = Number(staff.salary) || 0;
            const days = parseFloat(document.getElementById('stdDays').value) || WORKING_DAYS_SETTINGS.defaultDays;
            
            if(salary > 0 && days > 0) {
                const hourlyRate = salary / (days * 8);
                const coefficient = {
                    'h15': 1.5, 'h21': 2.1, 
                    'h20': 2.0, 'h35': 3.5
                }[field] || 1;
                
                const oldMoney = oldValue * coefficient * hourlyRate;
                const newMoney = newValue * coefficient * hourlyRate;
                
                STATS_CACHE.totalMoney += (newMoney - oldMoney);
                STATS_CACHE.totalHours += (newValue - oldValue);
                
                document.getElementById('stat-total-money').textContent = 
                    Math.round(Math.max(0, STATS_CACHE.totalMoney)).toLocaleString() + ' ‚Ç´';
                document.getElementById('stat-total-ot').textContent = 
                    Math.max(0, STATS_CACHE.totalHours).toFixed(1);
                
                const date = document.getElementById('workDate').value;
                if(!date) return;
                const month = date.substring(0,7);
                const monthOTCount = calculateMonthOTCount(month);
                document.getElementById('stat-today-ot').textContent = monthOTCount;
            }
        }
        
        function calculateMonthOTCount(month) {
            const staffSet = new Set();
            
            Object.keys(DB.ot).forEach(date => {
                if(date.startsWith(month)) {
                    Object.keys(DB.ot[date]).forEach(staffId => {
                        const ot = DB.ot[date][staffId];
                        const h15 = Number(ot.h15) || 0;
                        const h21 = Number(ot.h21) || 0;
                        const h20 = Number(ot.h20) || 0;
                        const h35 = Number(ot.h35) || 0;
                        
                        if(h15 + h21 + h20 + h35 > 0) {
                            staffSet.add(staffId);
                        }
                    });
                }
            });
            
            return staffSet.size;
        }
        
        function updateStatsFull() {
            const date = document.getElementById('workDate').value;
            if(!date) return;
            
            const month = date.substring(0,7);
            const days = parseFloat(document.getElementById('stdDays').value) || WORKING_DAYS_SETTINGS.defaultDays;
            
            let totalHours = 0;
            let totalMoney = 0;
            
            const monthOTCount = calculateMonthOTCount(month);
            
            Object.keys(DB.ot).forEach(d => {
                if(d.startsWith(month)) {
                    Object.entries(DB.ot[d]).forEach(([staffId, ot]) => {
                        const staff = DB.staff.find(s => s.id === staffId);
                        if(staff) {
                            const h15 = Number(ot.h15) || 0;
                            const h21 = Number(ot.h21) || 0;
                            const h20 = Number(ot.h20) || 0;
                            const h35 = Number(ot.h35) || 0;
                            
                            totalHours += h15 + h21 + h20 + h35;
                            
                            const salary = Number(staff.salary) || 0;
                            if(salary > 0 && days > 0) {
                                const hourlyRate = salary / (days * 8);
                                totalMoney += (h15 * 1.5 + h21 * 2.1 + h20 * 2.0 + h35 * 3.5) * hourlyRate;
                            }
                        }
                    });
                }
            });
            
            STATS_CACHE.totalMoney = totalMoney;
            STATS_CACHE.totalHours = totalHours;
            STATS_CACHE.todayOTCount = monthOTCount;
            STATS_CACHE.isDirty = false;
            
            document.getElementById('stat-total-staff').textContent = DB.staff.length;
            document.getElementById('stat-total-ot').textContent = totalHours.toFixed(1);
            document.getElementById('stat-total-money').textContent = 
                isNaN(totalMoney) ? '0 ‚Ç´' : Math.round(totalMoney).toLocaleString() + ' ‚Ç´';
            document.getElementById('stat-today-ot').textContent = monthOTCount;
        }
        
        function handleDateChange() {
            STATS_CACHE.isDirty = true;
            renderOTFast(false);
            updateWorkingDaysInfo();
            updateQueueStatusDisplay();
        }
        
        function handleFilterChange() {
            renderOTFast(false);
        }
        
        function handleStdDaysChange() {
            STATS_CACHE.isDirty = true;
            updateStatsFull();
            updateWorkingDaysInfo();
            
            const date = document.getElementById('workDate').value;
            if(date && DB.ot[date]) {
                Object.keys(DB.ot[date]).forEach(id => {
                    updateRowMoney(id, date);
                });
            }
        }
        
        // ========== BULK OPERATIONS ==========
        function applyBulk(selectedOnly) {
            const date = document.getElementById('workDate').value;
            if(!date) return;
            
            const dept = document.getElementById('deptFilter').value;
            const ids = Array.from(document.querySelectorAll('.ot-cb:checked')).map(cb => cb.dataset.id);
            const vals = { 
                h15: parseFloat(document.getElementById('b15').value) || 0, 
                h21: parseFloat(document.getElementById('b21').value) || 0, 
                h20: parseFloat(document.getElementById('b20').value) || 0, 
                h35: parseFloat(document.getElementById('b35').value) || 0 
            };
            
            if(!DB.ot[date]) DB.ot[date] = {};
            
            if(selectedOnly) {
                ids.forEach(id => {
                    DB.ot[date][id] = {...vals};
                    
                    Object.keys(vals).forEach(field => {
                        addToAutoSaveQueue(id, date, field, vals[field]);
                    });
                    
                    updateRowMoney(id, date);
                });
                showToast(`‚úÖ ƒê√£ √°p d·ª•ng gi·ªù OT cho ${ids.length} nh√¢n vi√™n ƒë√£ ch·ªçn!`, 'success');
            } else {
                let appliedCount = 0;
                DB.staff.forEach(s => { 
                    if(dept === 'all' || s.dept === dept) { 
                        DB.ot[date][s.id] = {...vals}; 
                        
                        Object.keys(vals).forEach(field => {
                            addToAutoSaveQueue(s.id, date, field, vals[field]);
                        });
                        
                        appliedCount++;
                    } 
                });
                renderOTFast();
                showToast(`‚úÖ ƒê√£ √°p d·ª•ng gi·ªù OT cho ${appliedCount} nh√¢n vi√™n!`, 'success');
            }
            
            STATS_CACHE.isDirty = true;
            updateStatsFull();
            saveToLocalStorage();
        }
        
        function clearDay() { 
            const date = document.getElementById('workDate').value;
            if(!date) return;
            
            if(!confirm("X√≥a s·∫°ch gi·ªù OT ng√†y n√†y?\n\nThao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c!")) return; 
            
            delete DB.ot[date]; 
            
            AUTO_SAVE_QUEUE.pending = {};
            
            renderOTFast();
            STATS_CACHE.isDirty = true;
            updateStatsFull();
            saveToLocalStorage();
            updateQueueStatusDisplay();
            showToast("‚úÖ ƒê√£ x√≥a gi·ªù OT ng√†y n√†y!", 'success');
        }
        
        function toggleAllOT(el) { 
            document.querySelectorAll('.ot-cb').forEach(cb => cb.checked = el.checked); 
        }
        
        // ========== WORKING DAYS INFO ==========
        function calculateWorkingDays(year, month) {
            const date = new Date(year, month - 1, 1);
            let workingDays = 0;
            
            while(date.getMonth() === month - 1) {
                const day = date.getDay();
                if(day >= 1 && day <= 6) {
                    workingDays++;
                }
                date.setDate(date.getDate() + 1);
            }
            
            return workingDays;
        }
        
        function updateWorkingDaysInfo() {
            const dateInput = document.getElementById('workDate');
            const stdDaysInput = document.getElementById('stdDays');
            
            if(!dateInput || !dateInput.value || !stdDaysInput) return;
            
            const dateStr = dateInput.value;
            const [year, month] = dateStr.split('-').map(Number);
            const stdDays = parseInt(stdDaysInput.value) || WORKING_DAYS_SETTINGS.defaultDays;
            
            const maxDays = calculateWorkingDays(year, month);
            
            const monthNames = ["Th√°ng 1", "Th√°ng 2", "Th√°ng 3", "Th√°ng 4", "Th√°ng 5", "Th√°ng 6",
                              "Th√°ng 7", "Th√°ng 8", "Th√°ng 9", "Th√°ng 10", "Th√°ng 11", "Th√°ng 12"];
            
            let info = `${monthNames[month-1]}/${year} c√≥ ${maxDays} ng√†y th·ª© 2-7<br>`;
            info += `ƒêang d√πng: ${stdDays} ng√†y c√¥ng`;
            
            if(stdDays < maxDays && stdDays < WORKING_DAYS_SETTINGS.maxDays) {
                info += `<br>${maxDays - stdDays} ng√†y ƒë∆∞·ª£c t√≠nh l√† ngh·ªâ`;
            } else if(stdDays === WORKING_DAYS_SETTINGS.maxDays && maxDays > WORKING_DAYS_SETTINGS.maxDays) {
                info += `<br>√Åp d·ª•ng quy ƒë·ªãnh t·ªëi ƒëa ${WORKING_DAYS_SETTINGS.maxDays} ng√†y`;
            }
            
            document.getElementById('workingDaysSidebarInfo').innerHTML = info;
        }
        
        // ========== QUEUE STATUS ==========
        function updateQueueStatusDisplay() {
            const pendingCount = Object.keys(AUTO_SAVE_QUEUE.pending).length;
            const statusEl = document.getElementById('syncStatus');
            const statusTextEl = document.getElementById('syncStatusText');
            const queueStatusEl = document.getElementById('queueStatus');
            const queueCountBadge = document.getElementById('queueCountBadge');
            const queueCount = document.getElementById('queueCount');
            
            if (statusEl && statusTextEl) {
                if (pendingCount === 0) {
                    statusEl.innerHTML = '<i class="fas fa-check-circle" style="color:var(--success)"></i>';
                    statusTextEl.textContent = 'ƒê√£ ƒë·ªìng b·ªô';
                } else if (AUTO_SAVE_QUEUE.isProcessing) {
                    statusEl.innerHTML = '<i class="fas fa-sync-alt fa-spin" style="color:var(--accent)"></i>';
                    statusTextEl.textContent = `ƒêang ƒë·ªìng b·ªô (${pendingCount})`;
                } else {
                    statusEl.innerHTML = '<i class="fas fa-hourglass-half" style="color:var(--warning)"></i>';
                    statusTextEl.textContent = `Ch·ªù ƒë·ªìng b·ªô (${pendingCount})`;
                }
            }
            
            if (queueStatusEl) {
                if (pendingCount > 0) {
                    queueStatusEl.classList.remove('hidden');
                    
                    if (queueCountBadge) {
                        queueCountBadge.textContent = `${pendingCount} ƒëang ch·ªù`;
                        queueCountBadge.className = `speed-badge ${pendingCount > 50 ? 'speed-slow' : 'speed-fast'}`;
                    }
                } else {
                    queueStatusEl.classList.add('hidden');
                }
            }
            
            if (queueCount) {
                queueCount.textContent = pendingCount;
            }
        }
        
        function showQueueStatus() {
            const pendingCount = Object.keys(AUTO_SAVE_QUEUE.pending).length;
            
            let message = `üìä Tr·∫°ng th√°i ƒë·ªìng b·ªô:\n\n`;
            message += `‚Ä¢ ƒêang ch·ªù: ${pendingCount} nh√¢n vi√™n\n`;
            message += `‚Ä¢ ƒê√£ x·ª≠ l√Ω: ${AUTO_SAVE_QUEUE.totalProcessed} nh√¢n vi√™n\n`;
            message += `‚Ä¢ Batch size: ${AUTO_SAVE_QUEUE.batchSize} ng∆∞·ªùi/batch\n`;
            message += `‚Ä¢ Tr·∫°ng th√°i: ${AUTO_SAVE_QUEUE.isProcessing ? 'ƒêang x·ª≠ l√Ω' : 'Ch·ªù'}`;
            
            alert(message);
        }
        
        function forceProcessQueue() {
            if (Object.keys(AUTO_SAVE_QUEUE.pending).length === 0) {
                showToast("Kh√¥ng c√≥ d·ªØ li·ªáu n√†o ƒëang ch·ªù ƒë·ªìng b·ªô!", 'info');
                return;
            }
            
            if (!AUTO_SAVE_QUEUE.isProcessing) {
                processAutoSaveQueue();
                showToast(`ƒêang b·∫Øt ƒë·∫ßu ƒë·ªìng b·ªô ${Object.keys(AUTO_SAVE_QUEUE.pending).length} nh√¢n vi√™n...`, 'info');
            } else {
                showToast("H·ªá th·ªëng ƒëang t·ª± ƒë·ªông ƒë·ªìng b·ªô. Vui l√≤ng ch·ªù!", 'warning');
            }
        }
        
        function updateSyncStatus(message) {
            console.log("üîÑ " + message);
        }
        
        // ========== HISTORY TAB FUNCTIONS - FIXED ==========
        function searchStaffById() {
            const staffId = document.getElementById('historyStaffSearch').value.trim();
            if (!staffId) {
                showToast("Vui l√≤ng nh·∫≠p M√£ NV!", 'warning');
                clearHistoryTable();
                return;
            }
            
            const staff = DB.staff.find(s => s.id === staffId);
            if (!staff) {
                showToast("Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n v·ªõi m√£ n√†y!", 'error');
                clearHistoryTable();
                return;
            }
            
            // Load t·ª´ local data
            loadStaffOTHistoryFromLocal(staffId);
        }
        
        function loadStaffOTHistoryFromLocal(staffId) {
            const staff = DB.staff.find(s => s.id === staffId);
            if (!staff) {
                showToast("Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n v·ªõi m√£ n√†y!", 'error');
                clearHistoryTable();
                return;
            }
            
            const fromDate = document.getElementById('historyFrom').value;
            const toDate = document.getElementById('historyTo').value;
            const month = document.getElementById('historyMonth').value;
            
            let historyData = [];
            let totalHours = 0;
            let totalMoney = 0;
            let dayCount = 0;
            
            // Duy·ªát qua t·∫•t c·∫£ ng√†y OT trong DB.ot
            Object.keys(DB.ot).forEach(date => {
                // Ki·ªÉm tra filter ng√†y
                if (fromDate && date < fromDate) return;
                if (toDate && date > toDate) return;
                if (month && !date.startsWith(month)) return;
                
                // Ki·ªÉm tra xem nh√¢n vi√™n n√†y c√≥ OT trong ng√†y n√†y kh√¥ng
                const otData = DB.ot[date] && DB.ot[date][staffId];
                if (otData) {
                    const h15 = Number(otData.h15) || 0;
                    const h21 = Number(otData.h21) || 0;
                    const h20 = Number(otData.h20) || 0;
                    const h35 = Number(otData.h35) || 0;
                    
                    const totalDayHours = h15 + h21 + h20 + h35;
                    if (totalDayHours > 0) {
                        // T√≠nh ti·ªÅn cho ng√†y n√†y
                        const stdDays = parseFloat(document.getElementById('stdDays').value) || WORKING_DAYS_SETTINGS.defaultDays;
                        const salary = Number(staff.salary) || 0;
                        let dayMoney = 0;
                        
                        if (salary > 0 && stdDays > 0) {
                            const hourlyRate = salary / (stdDays * 8);
                            dayMoney = (h15 * 1.5 + h21 * 2.1 + h20 * 2.0 + h35 * 3.5) * hourlyRate;
                        }
                        
                        const dateObj = new Date(date);
                        const dayOfWeek = dateObj.getDay();
                        const weekdays = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
                        
                        historyData.push({
                            date,
                            weekday: weekdays[dayOfWeek],
                            h15,
                            h21,
                            h20,
                            h35,
                            totalHours: totalDayHours,
                            money: dayMoney,
                            note: generateOTNoteLocal(h15, h21, h20, h35)
                        });
                        
                        totalHours += totalDayHours;
                        totalMoney += dayMoney;
                        dayCount++;
                    }
                }
            });
            
            // S·∫Øp x·∫øp theo ng√†y m·ªõi nh·∫•t tr∆∞·ªõc
            historyData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // C·∫≠p nh·∫≠t b·∫£ng
            updateHistoryTableLocal(staff, historyData);
            
            // C·∫≠p nh·∫≠t th·ªëng k√™
            updateHistoryStatsLocal(totalHours, totalMoney, dayCount, staff);
            
            if (dayCount === 0) {
                showToast("Kh√¥ng c√≥ d·ªØ li·ªáu OT trong kho·∫£ng th·ªùi gian n√†y!", 'info');
            } else {
                showToast(`‚úÖ ƒê√£ t√¨m th·∫•y ${dayCount} ng√†y OT c·ªßa ${staff.name}`, 'success');
            }
        }
        
        function generateOTNoteLocal(h15, h21, h20, h35) {
            const notes = [];
            if (h15 > 0) notes.push(`${h15}h x 1.5`);
            if (h21 > 0) notes.push(`${h21}h x 2.1`);
            if (h20 > 0) notes.push(`${h20}h x 2.0`);
            if (h35 > 0) notes.push(`${h35}h x 3.5`);
            return notes.join(', ') || '-';
        }
        
        function updateHistoryTableLocal(staff, historyData) {
            const tbody = document.getElementById('historyBody');
            if (!tbody) return;
            
            if (historyData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align:center; padding:40px; color:var(--gray-400);">
                            <i class="fas fa-inbox" style="font-size:2rem; margin-bottom:10px;"></i><br>
                            Kh√¥ng c√≥ d·ªØ li·ªáu OT trong kho·∫£ng th·ªùi gian n√†y
                        </td>
                    </tr>`;
                return;
            }
            
            let html = '';
            let totalAllHours = 0;
            let totalAllMoney = 0;
            
            historyData.forEach(item => {
                totalAllHours += item.totalHours;
                totalAllMoney += item.money;
                
                const isSunday = item.weekday === 'CN';
                const weekdayClass = isSunday ? 'weekday-badge sunday' : 'weekday-badge';
                
                html += `
                <tr>
                    <td><strong>${formatDate(item.date)}</strong></td>
                    <td><span class="${weekdayClass}">${item.weekday}</span></td>
                    <td>${item.h15 > 0 ? item.h15 : '-'}</td>
                    <td>${item.h21 > 0 ? item.h21 : '-'}</td>
                    <td>${item.h20 > 0 ? item.h20 : '-'}</td>
                    <td>${item.h35 > 0 ? item.h35 : '-'}</td>
                    <td><strong>${item.totalHours.toFixed(1)}h</strong></td>
                    <td style="color:var(--danger); font-weight:700; text-align:right;">
                        ${Math.round(item.money).toLocaleString()} ‚Ç´
                    </td>
                    <td style="font-size:0.85rem; color:var(--gray-600);">${item.note}</td>
                </tr>`;
            });
            
            // Th√™m h√†ng t·ªïng c·ªông
            html += `
            <tr style="background:var(--gray-50); font-weight:bold;">
                <td colspan="6" style="text-align:right;">T·ªîNG C·ªòNG:</td>
                <td>${totalAllHours.toFixed(1)}h</td>
                <td style="color:var(--danger); text-align:right;">${Math.round(totalAllMoney).toLocaleString()} ‚Ç´</td>
                <td></td>
            </tr>`;
            
            tbody.innerHTML = html;
            document.getElementById('history-staff-name').textContent = `- ${staff.name} (${staff.id})`;
        }
        
        function updateHistoryStatsLocal(totalHours, totalMoney, dayCount, staff) {
            document.getElementById('history-total-hours').textContent = totalHours.toFixed(1);
            document.getElementById('history-total-days').textContent = dayCount;
            document.getElementById('history-total-money').textContent = 
                Math.round(totalMoney).toLocaleString() + ' ‚Ç´';
            
            const avgPerDay = dayCount > 0 ? (totalMoney / dayCount) : 0;
            document.getElementById('history-avg-day').textContent = 
                Math.round(avgPerDay).toLocaleString() + ' ‚Ç´';
        }
        
        function clearHistoryTable() {
            document.getElementById('historyBody').innerHTML = `
                <tr>
                    <td colspan="9" style="text-align:center; padding:40px; color:var(--gray-400);">
                        <i class="fas fa-user" style="font-size:2rem; margin-bottom:10px;"></i><br>
                        Vui l√≤ng nh·∫≠p M√£ NV ƒë·ªÉ xem l·ªãch s·ª≠ OT
                    </td>
                </tr>`;
            
            document.getElementById('history-total-hours').textContent = '0';
            document.getElementById('history-total-days').textContent = '0';
            document.getElementById('history-total-money').textContent = '0 ‚Ç´';
            document.getElementById('history-avg-day').textContent = '0 ‚Ç´';
            document.getElementById('history-staff-name').textContent = '';
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        function exportStaffHistory() {
            const staffId = document.getElementById('historyStaffSearch').value.trim();
            if (!staffId) {
                showToast("Vui l√≤ng nh·∫≠p M√£ NV!", 'warning');
                return;
            }
            
            const staff = DB.staff.find(s => s.id === staffId);
            if (!staff) {
                showToast("Kh√¥ng t√¨m th·∫•y th√¥ng tin nh√¢n vi√™n!", 'error');
                return;
            }
            
            const fromDate = document.getElementById('historyFrom').value;
            const toDate = document.getElementById('historyTo').value;
            const month = document.getElementById('historyMonth').value;
            
            let historyData = [];
            Object.keys(DB.ot).forEach(date => {
                if (fromDate && date < fromDate) return;
                if (toDate && date > toDate) return;
                if (month && !date.startsWith(month)) return;
                
                const otData = DB.ot[date] && DB.ot[date][staffId];
                if (otData) {
                    const h15 = Number(otData.h15) || 0;
                    const h21 = Number(otData.h21) || 0;
                    const h20 = Number(otData.h20) || 0;
                    const h35 = Number(otData.h35) || 0;
                    
                    if (h15 + h21 + h20 + h35 > 0) {
                        historyData.push({
                            date,
                            h15,
                            h21,
                            h20,
                            h35,
                            total: h15 + h21 + h20 + h35
                        });
                    }
                }
            });
            
            if (historyData.length === 0) {
                showToast("Kh√¥ng c√≥ d·ªØ li·ªáu OT ƒë·ªÉ xu·∫•t!", 'warning');
                return;
            }
            
            const exportData = [
                ['B√ÅO C√ÅO L·ªäCH S·ª¨ OT NH√ÇN VI√äN'],
                ['M√£ NV:', staff.id],
                ['H·ªç t√™n:', staff.name],
                ['B·ªô ph·∫≠n:', staff.dept],
                ['L∆∞∆°ng CB:', staff.salary.toLocaleString() + ' ‚Ç´'],
                ['T·ª´ ng√†y:', fromDate || 'ƒê·∫ßu k·ª≥'],
                ['ƒê·∫øn ng√†y:', toDate || 'Cu·ªëi k·ª≥'],
                ['Ng√†y xu·∫•t:', new Date().toLocaleDateString('vi-VN')],
                [],
                ['Ng√†y', '1.5', '2.1', '2.0', '3.5', 'T·ªïng gi·ªù', 'Ghi ch√∫']
            ];
            
            let totalHours = 0;
            historyData.forEach(item => {
                totalHours += item.total;
                exportData.push([
                    formatDate(item.date),
                    item.h15 || '',
                    item.h21 || '',
                    item.h20 || '',
                    item.h35 || '',
                    item.total.toFixed(1),
                    generateOTNoteLocal(item.h15, item.h21, item.h20, item.h35)
                ]);
            });
            
            exportData.push([]);
            exportData.push(['T·ªîNG C·ªòNG', '', '', '', '', totalHours.toFixed(1) + ' gi·ªù', '']);
            
            try {
                const ws = XLSX.utils.aoa_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'L·ªãch s·ª≠ OT');
                
                ws['!cols'] = [
                    {wch: 12},
                    {wch: 8},
                    {wch: 8},
                    {wch: 8},
                    {wch: 8},
                    {wch: 10},
                    {wch: 30}
                ];
                
                const fileName = `OT_${staff.id}_${fromDate || ''}_${toDate || ''}.xlsx`.replace(/\s+/g, '_');
                XLSX.writeFile(wb, fileName);
                
                showToast(`‚úÖ ƒê√£ xu·∫•t ${historyData.length} ng√†y OT c·ªßa ${staff.name}!`, 'success');
            } catch (e) {
                showToast("‚ùå L·ªói xu·∫•t file: " + e.message, 'error');
            }
        }
        
        function printStaffHistory() {
            const staffId = document.getElementById('historyStaffSearch').value;
            if (!staffId) {
                showToast("Vui l√≤ng nh·∫≠p M√£ NV!", 'warning');
                return;
            }
            
            const staff = DB.staff.find(s => s.id === staffId);
            if (!staff) {
                showToast("Kh√¥ng t√¨m th·∫•y th√¥ng tin nh√¢n vi√™n!", 'error');
                return;
            }
            
            showToast("T√≠nh nƒÉng in ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn", 'info');
        }
        
        // ========== GOOGLE SHEET FUNCTIONS - FIXED ==========
        async function loadFromGoogleSheet() {
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync-alt loading"></i> ƒêang t·∫£i t·ª´ Google Sheet...';
            
            try {
                const response = await fetch(GOOGLE_SHEET_API + '?action=load&t=' + Date.now());
                const result = await response.json();
                
                if(result.success) {
                    // L∆ØU √ù QUAN TR·ªåNG: Lu√¥n gi·ªØ d·ªØ li·ªáu OT hi·ªán t·∫°i khi t·∫£i
                    const currentLocalOT = { ...DB.ot }; // Gi·ªØ l·∫°i d·ªØ li·ªáu local hi·ªán t·∫°i
                    
                    DB.staff = result.staff || [];
                    
                    // QUAN TR·ªåNG: G·ªôp d·ªØ li·ªáu OT t·ª´ Google Sheet v·ªõi d·ªØ li·ªáu local
                    // Kh√¥ng ghi ƒë√® to√†n b·ªô, m√† h·ª£p nh·∫•t d·ªØ li·ªáu
                    if (result.ot) {
                        DB.ot = { ...result.ot, ...currentLocalOT }; // Google Sheet c√≥ ∆∞u ti√™n cao h∆°n
                    } else {
                        DB.ot = currentLocalOT; // Gi·ªØ l·∫°i d·ªØ li·ªáu local n·∫øu Google Sheet kh√¥ng c√≥
                    }
                    
                    DB.settings = result.settings || {};
                    
                    saveToLocalStorage();
                    
                    document.getElementById('syncStatus').innerHTML = 
                        '<i class="fab fa-google" style="color:var(--success)"></i> ƒê√£ ƒë·ªìng b·ªô Google Sheet ' + new Date().toLocaleTimeString();
                    
                    renderStaff();
                    updateDeptList();
                    
                    // Th√™m b∆∞·ªõc n√†y ƒë·ªÉ debug: hi·ªÉn th·ªã s·ªë ng√†y OT ƒë√£ t·∫£i
                    console.log(`‚úÖ ƒê√£ t·∫£i ${DB.staff.length} nh√¢n vi√™n v√† ${Object.keys(DB.ot).length} ng√†y OT`);
                    
                    if(document.getElementById('tab-ot').classList.contains('hidden') === false) {
                        renderOTFast(false);
                        updateStatsFull();
                        updateWorkingDaysInfo();
                    }
                    
                    showToast(`‚úÖ ƒê√£ t·∫£i ${DB.staff.length} nh√¢n vi√™n v√† ${Object.keys(DB.ot).length} ng√†y OT t·ª´ Google Sheet!`, 'success');
                    
                } else {
                    throw new Error(result.error || "Failed to load data from Google Sheet");
                }
                
            } catch(error) {
                console.error("‚ùå Google Sheet load error:", error);
                
                if(loadFromLocalStorage()) {
                    document.getElementById('syncStatus').innerHTML = 
                        '<i class="fas fa-hdd" style="color:var(--warning)"></i> ƒê√£ t·∫£i t·ª´ b·∫£n l∆∞u c·ª•c b·ªô';
                    
                    renderStaff();
                    updateDeptList();
                    
                    showToast("‚ö†Ô∏è ƒêang d√πng d·ªØ li·ªáu t·ª´ b·∫£n l∆∞u tr√¨nh duy·ªát", 'warning');
                    return;
                }
                
                document.getElementById('syncStatus').innerHTML = 
                    '<i class="fas fa-exclamation-triangle" style="color:var(--warning)"></i> Kh√¥ng th·ªÉ k·∫øt n·ªëi';
                
                showToast("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Google Sheet: " + error.message, 'error');
            }
        }
        
        async function saveStaffToGoogleSheet() {
            if(DB.staff.length === 0) {
                showToast("Kh√¥ng c√≥ nh√¢n vi√™n n√†o ƒë·ªÉ l∆∞u!", 'warning');
                return;
            }
            
            if(!confirm("X√°c nh·∫≠n l∆∞u danh s√°ch nh√¢n vi√™n l√™n Google Sheet?")) return;
            
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync-alt loading"></i> ƒêang l∆∞u nh√¢n vi√™n...';
            
            try {
                const batchData = {};
                const today = new Date().toISOString().split('T')[0];
                batchData[today] = {};
                
                DB.staff.forEach(staff => {
                    batchData[today][staff.id] = {h15: 0, h21: 0, h20: 0, h35: 0};
                });
                
                const url = GOOGLE_SHEET_API + 
                    '?action=saveBatch' +
                    '&data=' + encodeURIComponent(JSON.stringify(batchData)) +
                    '&timestamp=' + encodeURIComponent(new Date().toISOString()) +
                    '&user=' + encodeURIComponent(currentUser) +
                    '&t=' + Date.now();
                
                const response = await fetch(url, { method: 'GET' });
                const result = await response.json();
                
                if(result.success) {
                    document.getElementById('syncStatus').innerHTML = 
                        '<i class="fab fa-google" style="color:var(--success)"></i> ƒê√£ l∆∞u ' + new Date().toLocaleTimeString();
                    
                    showToast(`‚úÖ ƒê√£ l∆∞u ${DB.staff.length} nh√¢n vi√™n l√™n Google Sheet!`, 'success');
                } else {
                    throw new Error(result.error || "L·ªói t·ª´ Google Sheet");
                }
                
            } catch(error) {
                console.error("‚ùå L·ªói l∆∞u nh√¢n vi√™n:", error);
                showToast("‚ö†Ô∏è L∆∞u nh√¢n vi√™n th·∫•t b·∫°i: " + error.message, 'error');
                document.getElementById('syncStatus').innerHTML = 
                    '<i class="fas fa-exclamation-triangle" style="color:var(--warning)"></i> L∆∞u th·∫•t b·∫°i';
            }
        }
        
        async function manualSaveToGoogleSheet() {
            const date = document.getElementById('workDate').value;
            if(!date) {
                showToast("Vui l√≤ng ch·ªçn ng√†y l√†m vi·ªác!", 'warning');
                return;
            }
            
            if(!confirm("X√°c nh·∫≠n l∆∞u d·ªØ li·ªáu OT l√™n Google Sheet?\n\nTo√†n b·ªô d·ªØ li·ªáu OT s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o Google Sheet.")) return;
            
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync-alt loading"></i> ƒêang l∆∞u l√™n Google Sheet...';
            
            saveToLocalStorage();
            
            try {
                const batchData = {};
                batchData[date] = DB.ot[date] || {};
                
                const url = GOOGLE_SHEET_API + 
                    '?action=saveBatch' +
                    '&data=' + encodeURIComponent(JSON.stringify(batchData)) +
                    '&timestamp=' + encodeURIComponent(new Date().toISOString()) +
                    '&user=' + encodeURIComponent(currentUser) +
                    '&t=' + Date.now();
                
                const response = await fetch(url, { method: 'GET' });
                const result = await response.json();
                
                if(result.success) {
                    document.getElementById('syncStatus').innerHTML = 
                        '<i class="fab fa-google" style="color:var(--success)"></i> ƒê√£ l∆∞u Google Sheet ' + new Date().toLocaleTimeString();
                    
                    showToast(`‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu OT ng√†y ${date} l√™n Google Sheet!`, 'success');
                } else {
                    throw new Error(result.error || "L·ªói t·ª´ Google Sheet");
                }
                
            } catch(error) {
                console.error("‚ùå L·ªói l∆∞u Google Sheet:", error);
                showToast("‚ö†Ô∏è L∆∞u v√†o Google Sheet th·∫•t b·∫°i: " + error.message, 'error');
                document.getElementById('syncStatus').innerHTML = 
                    '<i class="fas fa-hdd" style="color:var(--warning)"></i> ƒê√£ l∆∞u c·ª•c b·ªô';
            }
        }
        
        // ========== VALIDATION & EXPORT ==========
        function validateDataBeforeExport() {
            const errors = [];
            
            const stdDays = parseFloat(document.getElementById('stdDays').value);
            if(isNaN(stdDays) || stdDays < WORKING_DAYS_SETTINGS.minDays || stdDays > WORKING_DAYS_SETTINGS.maxDays) {
                errors.push(`‚ùå S·ªë ng√†y c√¥ng kh√¥ng h·ª£p l·ªá! Ph·∫£i nh·∫≠p s·ªë t·ª´ ${WORKING_DAYS_SETTINGS.minDays}-${WORKING_DAYS_SETTINGS.maxDays}`);
            }
            
            const invalidStaff = DB.staff.filter(s => {
                const salary = Number(s.salary);
                return isNaN(salary) || salary <= 0;
            });
            
            if(invalidStaff.length > 0) {
                invalidStaff.slice(0, 3).forEach(s => {
                    errors.push(`‚ùå Nh√¢n vi√™n ${s.name} (${s.id}) c√≥ l∆∞∆°ng kh√¥ng h·ª£p l·ªá`);
                });
                if(invalidStaff.length > 3) {
                    errors.push(`... v√† ${invalidStaff.length - 3} nh√¢n vi√™n kh√°c`);
                }
            }
            
            return errors;
        }
        
        function validateAndExport() {
            const date = document.getElementById('workDate').value;
            if(!date) {
                showToast("Vui l√≤ng ch·ªçn ng√†y l√†m vi·ªác!", 'warning');
                return;
            }
            
            const errors = validateDataBeforeExport();
            
            if(errors.length > 0) {
                const errorMsg = "C√≥ l·ªói d·ªØ li·ªáu:\n\n" + errors.join("\n");
                const shouldContinue = confirm(errorMsg + "\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c xu·∫•t Excel kh√¥ng?");
                if(!shouldContinue) return;
            }
            
            exportExcel();
        }
        
        function exportExcel() {
            const date = document.getElementById('workDate').value;
            if(!date) return;
            
            const year = date.substring(0,4);
            const month = date.substring(5,7);
            const stdDays = parseFloat(document.getElementById('stdDays').value) || WORKING_DAYS_SETTINGS.defaultDays;
            
            if(isNaN(stdDays) || stdDays < WORKING_DAYS_SETTINGS.minDays || stdDays > WORKING_DAYS_SETTINGS.maxDays) {
                showToast(`S·ªë ng√†y c√¥ng kh√¥ng h·ª£p l·ªá! Vui l√≤ng nh·∫≠p s·ªë t·ª´ ${WORKING_DAYS_SETTINGS.minDays}-${WORKING_DAYS_SETTINGS.maxDays}.`, 'error');
                document.getElementById('stdDays').focus();
                return;
            }
            
            const daysInMonth = new Date(year, month, 0).getDate();
            let exportData = [];
            
            DB.staff.forEach(s => {
                let row = { 
                    "M√£ NV": s.id, 
                    "H·ªç T√™n": s.name, 
                    "B·ªô ph·∫≠n": s.dept, 
                    "L∆∞∆°ng CB": Number(s.salary) || 0 
                };
                
                let totalMoney = 0;
                let hasAnyOTInMonth = false;
                
                for(let i = 1; i <= daysInMonth; i++) {
                    let dayStr = i < 10 ? '0' + i : i;
                    let dStr = `${year}-${month}-${dayStr}`;
                    let ot = DB.ot[dStr]?.[s.id];
                    
                    if(ot) {
                        const h15 = Number(ot.h15) || 0;
                        const h21 = Number(ot.h21) || 0;
                        const h20 = Number(ot.h20) || 0;
                        const h35 = Number(ot.h35) || 0;
                        
                        if(h15 + h21 + h20 + h35 > 0) {
                            let sum = [];
                            if(h15 > 0) sum.push(`${h15}(1.5)`); 
                            if(h21 > 0) sum.push(`${h21}(2.1)`);
                            if(h20 > 0) sum.push(`${h20}(2.0)`); 
                            if(h35 > 0) sum.push(`${h35}(3.5)`);
                            row[`Ng√†y ${i}`] = sum.join(", ");
                            
                            const salary = Number(s.salary) || 0;
                            if(salary > 0 && stdDays > 0) {
                                const hourlyRate = salary / (stdDays * 8);
                                totalMoney += (h15 * 1.5 + h21 * 2.1 + h20 * 2.0 + h35 * 3.5) * hourlyRate;
                            }
                            hasAnyOTInMonth = true;
                        } else {
                            row[`Ng√†y ${i}`] = "";
                        }
                    } else {
                        row[`Ng√†y ${i}`] = "";
                    }
                }
                
                if(hasAnyOTInMonth) { 
                    row["T·ªîNG TI·ªÄN OT"] = Math.round(totalMoney); 
                    exportData.push(row); 
                }
            });
            
            if(exportData.length === 0) {
                showToast("Kh√¥ng c√≥ d·ªØ li·ªáu OT trong th√°ng n√†y!", 'warning');
                return;
            }
            
            const totalRow = {
                "M√£ NV": "T·ªîNG C·ªòNG",
                "H·ªç T√™n": "",
                "B·ªô ph·∫≠n": "",
                "L∆∞∆°ng CB": "",
            };
            
            const grandTotal = exportData.reduce((sum, row) => {
                return sum + (Number(row["T·ªîNG TI·ªÄN OT"]) || 0);
            }, 0);
            
            totalRow["T·ªîNG TI·ªÄN OT"] = Math.round(grandTotal);
            exportData.push(totalRow);
            
            try {
                const ws = XLSX.utils.json_to_sheet(exportData, {skipHeader: false});
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, `OT_${month}_${year}`);
                
                const wscols = [
                    {wch: 10},
                    {wch: 25},
                    {wch: 15},
                    {wch: 12},
                ];
                
                for(let i = 1; i <= daysInMonth; i++) {
                    wscols.push({wch: 12});
                }
                wscols.push({wch: 15});
                
                ws['!cols'] = wscols;
                
                const range = XLSX.utils.decode_range(ws['!ref']);
                for(let R = range.s.r; R <= range.e.r; R++) {
                    const cellAddress = XLSX.utils.encode_cell({r: R, c: range.e.c});
                    const cell = ws[cellAddress];
                    if(cell && cell.v !== undefined && cell.v !== "T·ªîNG TI·ªÄN OT") {
                        if(!isNaN(cell.v)) {
                            ws[cellAddress].z = '#,##0';
                        }
                    }
                }
                
                XLSX.writeFile(wb, `OT_DONGJU_${month}_${year}.xlsx`);
                
                const staffCount = exportData.length - 1;
                showToast(`‚úÖ ƒê√£ xu·∫•t ${staffCount} nh√¢n vi√™n c√≥ OT, t·ªïng ti·ªÅn ${grandTotal.toLocaleString()} ‚Ç´`, 'success');
                
            } catch(e) {
                showToast("‚ùå L·ªói xu·∫•t file Excel: " + e.message, 'error');
            }
        }
        
        // ========== TAB SWITCHING ==========
        function switchTab(t) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-staff').classList.add('hidden');
            document.getElementById('tab-ot').classList.add('hidden');
            document.getElementById('tab-history').classList.add('hidden');
            document.getElementById('fixed-toolbar-area').classList.add('hidden');
            document.getElementById('date-tool').classList.add('hidden');
            
            document.getElementById('tab-' + t).classList.remove('hidden');
            document.getElementById('nav-' + t).classList.add('active');
            
            if(t === 'staff') {
                document.getElementById('page-title').innerText = "QU·∫¢N L√ù NH√ÇN S·ª∞";
                renderStaff();
            } else if(t === 'ot') {
                document.getElementById('page-title').innerText = "CH·∫§M C√îNG TƒÇNG CA";
                document.getElementById('date-tool').classList.remove('hidden');
                document.getElementById('fixed-toolbar-area').classList.remove('hidden');
                updateDeptList();
                renderOTFast(false);
                updateStatsFull();
                updateWorkingDaysInfo();
                updateQueueStatusDisplay();
            } else if(t === 'history') {
                document.getElementById('page-title').innerText = "L·ªäCH S·ª¨ OT NH√ÇN VI√äN";
                setDefaultHistoryDates();
                clearHistoryTable();
            }
        }
        
        function setDefaultHistoryDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('historyFrom').value = firstDay.toISOString().split('T')[0];
            document.getElementById('historyTo').value = today.toISOString().split('T')[0];
        }
        
        // ========== INITIALIZATION ==========
        window.addEventListener('load', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('workDate').value = today;
            
            loadFromLocalStorage();
            
            initializeApp();
            
            setTimeout(() => {
                loadFromGoogleSheet();
            }, 1000);
            
            const perfStats = document.getElementById('perfStats');
            if (perfStats) {
                perfStats.classList.remove('hidden');
            }
            
            console.log("‚úÖ DONGJU SPORT OT SYSTEM v4.0 - OPTIMIZED FOR 400 EMPLOYEES");
        });
        
        function initializeApp() {
            document.getElementById('storageStatus').textContent = 'Google Sheet';
            
            renderStaff();
            updateDeptList();
            setDefaultHistoryDates();
            
            document.getElementById('perfStats').innerHTML = `
                ‚ö° ${AUTO_SAVE_QUEUE.batchSize} ng∆∞·ªùi/batch | 
                üìä <span id="queueCount">0</span> ch·ªù
            `;
        }
    </script>
</body>
</html>
