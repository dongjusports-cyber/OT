<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DONGJU SPORT - OT MANAGEMENT SYSTEM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a237e;
            --primary-light: #534bae;
            --accent: #2962ff;
            --accent-light: #768fff;
            --success: #00c853;
            --warning: #ff9100;
            --danger: #ff1744;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-600: #475569;
            --gray-800: #1e293b;
            --sidebar-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--gray-50);
            color: var(--gray-800);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary) 0%, #0d47a1 100%);
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .sidebar-header {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        .logo-subtitle {
            font-size: 0.75rem;
            color: var(--accent-light);
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .nav-items {
            padding: 20px 15px;
            flex-grow: 1;
        }

        .nav-item {
            padding: 14px 20px;
            margin: 8px 0;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
            color: white;
        }

        .nav-item.active {
            background: white;
            color: var(--primary);
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(41, 98, 255, 0.2);
        }

        .nav-item i {
            width: 24px;
            margin-right: 15px;
            font-size: 1.1rem;
        }

        .user-info {
            margin-top: auto;
            padding: 25px 20px;
            background: rgba(0, 0, 0, 0.15);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-name {
            font-weight: 600;
            color: var(--accent-light);
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .user-role {
            font-size: 0.85rem;
            color: #a5b4fc;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-role i {
            font-size: 0.9rem;
        }

        .contact-info {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 10px;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .main-header {
            background: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid var(--gray-200);
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .header-tools {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .sync-status {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 8px 15px;
            border-radius: 20px;
            background: var(--gray-100);
            color: var(--gray-600);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 10px 20px;
            border-radius: 12px;
            border: 1px solid #e1bee7;
        }

        .date-label {
            font-weight: 600;
            color: #7b1fa2;
            font-size: 0.9rem;
        }

        #workDate {
            background: white;
            border: 2px solid #d1c4e9;
            border-radius: 8px;
            padding: 8px 12px;
            font-weight: 500;
            color: var(--gray-800);
        }

        /* Stats Cards */
        .stats-container {
            padding: 20px 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--accent);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            color: white;
            font-size: 1.5rem;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 0 30px 30px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-200);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-100);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--accent);
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .input-label {
            font-weight: 500;
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="password"],
        select {
            padding: 10px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(41, 98, 255, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(41, 98, 255, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #64dd17);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #ffab40);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #ff5252);
            color: white;
        }

        .btn-gray {
            background: linear-gradient(135deg, var(--gray-300), var(--gray-400));
            color: var(--gray-800);
        }

        .btn-edit {
            background: linear-gradient(135deg, #00bfa5, #1de9b6);
            color: white;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-200);
            margin-top: 20px;
        }

        .table-header {
            background: var(--gray-50);
            padding: 20px;
            border-bottom: 2px solid var(--gray-200);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--gray-50);
            padding: 18px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--gray-600);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--gray-200);
            white-space: nowrap;
        }

        td {
            padding: 18px 20px;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.95rem;
        }

        tr:hover {
            background: var(--gray-50);
        }

        .highlight {
            background-color: #fff8e1 !important;
        }

        /* OT Input Cells - OPTIMIZED */
        .ot-input-fast {
            width: 70px;
            padding: 8px 10px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .ot-input-fast:focus {
            border-color: var(--accent);
            background: #f0f7ff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(41, 98, 255, 0.1);
        }

        .ot-input-fast.updating {
            border-color: var(--warning);
            background: #fff8e1;
        }

        .money-cell {
            text-align: right;
            font-weight: 700;
            color: var(--danger);
            font-size: 0.95rem;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .money-cell.updating {
            color: var(--warning);
            background: #fff8e1;
            border-radius: 6px;
            animation: pulse 1s ease-in-out;
        }

        @keyframes pulse {
            0% { background-color: #fff8e1; }
            50% { background-color: #ffe57f; }
            100% { background-color: #fff8e1; }
        }

        /* Bulk Edit Section */
        .bulk-edit {
            background: linear-gradient(135deg, #fff8e1, #f3e5f5);
            border: 2px solid #ffe57f;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .bulk-header {
            font-weight: 700;
            color: #e65100;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .coefficient-inputs {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .coef-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coef-label {
            font-weight: 700;
            color: var(--primary);
            width: 40px;
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hidden utility */
        .hidden { display: none !important; }
        
        /* Validation */
        .validation-error {
            border-color: #ff1744 !important;
            background-color: #ffeef1 !important;
        }
        
        .validation-ok {
            border-color: #00c853 !important;
        }
        
        .error-message {
            color: #ff1744;
            font-size: 0.8rem;
            margin-top: 5px;
            display: block;
        }
        
        /* Turbo Mode */
        .turbo-active {
            animation: pulseTurbo 1s infinite;
            box-shadow: 0 0 20px #FF9800;
        }

        @keyframes pulseTurbo {
            0% { box-shadow: 0 0 5px #FF9800; }
            50% { box-shadow: 0 0 25px #FF5722; }
            100% { box-shadow: 0 0 5px #FF9800; }
        }
        
        /* Speed indicator */
        .speed-fast { color: #00C853 !important; }
        .speed-slow { color: #FF9800 !important; }
        .speed-turbo { color: #FF5722 !important; font-weight: bold; }
        
        /* Error popup */
        .error-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff1744;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(255, 23, 68, 0.3);
            z-index: 10000;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Google Sheet buttons */
        .btn-google {
            background: linear-gradient(135deg, #4285F4, #669DF6) !important;
            color: white !important;
        }
        
        .btn-sheet {
            background: linear-gradient(135deg, #0F9D58, #34A853) !important;
            color: white !important;
        }
        
        /* NEW STYLES FOR SPEED OPTIMIZATION */
        .speed-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        
        .speed-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .speed-badge.fast {
            background: rgba(0, 200, 83, 0.1);
            color: #00C853;
        }
        
        .speed-badge.slow {
            background: rgba(255, 152, 0, 0.1);
            color: #FF9800;
        }
        
        .speed-badge.turbo {
            background: rgba(255, 87, 34, 0.1);
            color: #FF5722;
            animation: pulseTurbo 2s infinite;
        }
        
        /* Performance stats */
        .perf-stats {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-family: monospace;
            z-index: 9999;
        }
        
        /* Queue Status */
        .queue-status {
            background: linear-gradient(135deg, #fff3e0, #fff8e1);
            border: 2px solid #ffcc80;
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
            font-size: 0.85rem;
        }
        
        .progress-container {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin: 5px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }
        
        /* Working days info */
        .working-days-info {
            background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
            border: 1px solid #c8e6c9;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            font-size: 0.85rem;
        }
        
        /* NEW STYLES FOR HISTORY TAB */
        .weekday-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #e3f2fd;
            color: #1565c0;
            display: inline-block;
            min-width: 32px;
            text-align: center;
        }
        
        .weekday-badge.sunday {
            background: #ffebee;
            color: #c62828;
        }
        
        #history-staff-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-left: 10px;
        }
        
        .history-filter {
            background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
            border: 1px solid #c8e6c9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .history-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .history-stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid;
            text-align: center;
        }
        
        .history-stat-card:nth-child(1) { border-color: #4CAF50; }
        .history-stat-card:nth-child(2) { border-color: #2196F3; }
        .history-stat-card:nth-child(3) { border-color: #FF9800; }
        .history-stat-card:nth-child(4) { border-color: #9C27B0; }
        
        .history-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .history-stat-label {
            font-size: 0.9rem;
            color: var(--gray-600);
            font-weight: 500;
        }
        
        /* Debug button */
        .debug-btn {
            background: linear-gradient(135deg, #9C27B0, #673AB7) !important;
            color: white !important;
        }
        
        .debug-btn:hover {
            background: linear-gradient(135deg, #7B1FA2, #512DA8) !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(123, 31, 162, 0.3);
        }
        
        /* Force reload button */
        .force-reload-btn {
            background: linear-gradient(135deg, #FF5722, #D84315) !important;
            color: white !important;
        }
        
        .force-reload-btn:hover {
            background: linear-gradient(135deg, #E64A19, #BF360C) !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 87, 34, 0.3);
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar {
                width: 250px;
            }
            
            .main-header {
                padding: 15px 20px;
            }
            
            .toolbar {
                gap: 10px;
            }
            
            .coefficient-inputs {
                gap: 10px;
            }
            
            .history-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-group {
                width: 100%;
            }
            
            .speed-controls {
                margin-left: 0;
                justify-content: center;
            }
            
            .history-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <!-- Performance Stats -->
    <div id="perfStats" class="perf-stats hidden">
        ‚ö° <span id="batchSize">0</span> ng∆∞·ªùi/batch | 
        ‚è±Ô∏è <span id="batchDelay">0</span>ms | 
        üìä <span id="queueCount">0</span> ch·ªù
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" style="position:fixed; top:20px; right:20px; z-index:10001;"></div>

    <!-- Queue Status Popup -->
    <div id="queueStatusPopup" class="hidden" style="position:fixed; bottom:20px; right:20px; background:white; padding:15px; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.2); z-index:10000; max-width:300px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <strong><i class="fas fa-tasks"></i> Tr·∫°ng th√°i ƒë·ªìng b·ªô</strong>
            <button onclick="document.getElementById('queueStatusPopup').classList.add('hidden')" style="background:none; border:none; cursor:pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="queueStatusContent"></div>
    </div>

    <!-- Debug Popup -->
    <div id="debugPopup" class="hidden" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:12px; box-shadow:0 5px 30px rgba(0,0,0,0.3); z-index:10000; max-width:500px; max-height:80vh; overflow:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="color:var(--primary);"><i class="fas fa-bug"></i> Th√¥ng tin Debug</h3>
            <button onclick="document.getElementById('debugPopup').classList.add('hidden')" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <pre id="debugInfo" style="background:#f5f5f5; padding:15px; border-radius:8px; font-size:0.85rem; max-height:400px; overflow:auto;"></pre>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-primary" onclick="forceReloadFromGoogleSheet()">
                <i class="fas fa-redo"></i> T·∫£i l·∫°i d·ªØ li·ªáu
            </button>
            <button class="btn btn-google" onclick="testGoogleSheetConnection()">
                <i class="fab fa-google"></i> Test k·∫øt n·ªëi
            </button>
            <button class="btn btn-gray" onclick="checkDataOnGoogleSheet()">
                <i class="fas fa-eye"></i> Xem tr√™n Sheet
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">DONGJU SPORT VN</div>
                <div class="logo-subtitle">OT MANAGEMENT</div>
            </div>
            
            <div class="nav-items">
                <div id="nav-staff" class="nav-item active" onclick="switchTab('staff')">
                    <i class="fas fa-users-cog"></i>
                    <span>Qu·∫£n l√Ω nh√¢n s·ª±</span>
                </div>
                <div id="nav-ot" class="nav-item" onclick="switchTab('ot')">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Ch·∫•m c√¥ng OT</span>
                </div>
                <div id="nav-history" class="nav-item" onclick="switchTab('history')">
                    <i class="fas fa-history"></i>
                    <span>L·ªãch s·ª≠ OT</span>
                </div>
                <div id="nav-account" class="nav-item" onclick="switchTab('account')">
                    <i class="fas fa-user-shield"></i>
                    <span>Qu·∫£n l√Ω t√†i kho·∫£n</span>
                </div>
            </div>
            
            <div class="user-info">
                <div class="user-name">Designed by IT DongJu</div>
                <div class="user-role">
                    <i class="fas fa-user-tag"></i>
                    <span id="userRole">Nguy·ªÖn Thanh Thi·ªán</span>
                </div>
                <div class="contact-info">
                    <i class="fas fa-phone-alt"></i> 09.18.28.38.25
                </div>
                <div class="backup-status" id="autoBackupStatus">
                    <i class="fas fa-sync-alt"></i> <span id="syncMode">Auto Save v3.0</span>
                </div>
                <div style="margin-top: 10px; font-size: 0.75rem; color: rgba(255,255,255,0.6);">
                    <i class="fas fa-database"></i> Storage: <span id="storageStatus">Google Sheet</span>
                </div>
                <button class="btn btn-danger btn-sm" onclick="clearAllData()" 
                        style="width:100%; margin-top:15px; padding:10px;">
                    <i class="fas fa-trash-alt"></i> X√≥a d·ªØ li·ªáu c·ª•c b·ªô
                </button>
                <button class="btn debug-btn btn-sm" onclick="showDebugInfo()" 
                        style="width:100%; margin-top:10px; padding:10px;">
                    <i class="fas fa-bug"></i> Debug
                </button>
                <button class="btn force-reload-btn btn-sm" onclick="forceReloadFromGoogleSheet()" 
                        style="width:100%; margin-top:10px; padding:10px;">
                    <i class="fas fa-redo"></i> T·∫£i l·∫°i d·ªØ li·ªáu
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="main-header">
                <div class="page-title" id="page-title">QU·∫¢N L√ù NH√ÇN S·ª∞</div>
                <div class="header-tools">
                    <div id="syncStatus" class="sync-status">
                        <i class="fas fa-check-circle" style="color:var(--success)"></i>
                        <span id="syncStatusText">S·∫µn s√†ng</span>
                    </div>
                    <div id="date-tool" class="date-selector hidden">
                        <div class="date-label">
                            <i class="fas fa-calendar-alt"></i> Ng√†y l√†m vi·ªác:
                        </div>
                        <input type="date" id="workDate" onchange="handleDateChange()">
                    </div>
                    <button class="btn btn-google" onclick="testGoogleSheetConnection()">
                        <i class="fab fa-google"></i> Ki·ªÉm tra k·∫øt n·ªëi
                    </button>
                    <button class="btn btn-sm" style="background:#e3f2fd; color:#1565c0;" onclick="showQueueStatus()">
                        <i class="fas fa-tasks"></i> Tr·∫°ng th√°i
                    </button>
                </div>
            </div>

            <!-- Stats Cards (Only for OT tab) -->
            <div id="stats-cards" class="stats-container hidden">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-value" id="stat-total-staff">0</div>
                    <div class="stat-label">T·ªïng nh√¢n vi√™n</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-value" id="stat-total-ot">0</div>
                    <div class="stat-label">T·ªïng gi·ªù OT th√°ng</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-value" id="stat-total-money">0 ‚Ç´</div>
                    <div class="stat-label">T·ªïng ti·ªÅn OT</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-value" id="stat-today-ot">0</div>
                    <div class="stat-label">NV c√≥ OT h√¥m nay</div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area" id="content-area">
                <!-- Staff Management Tab -->
                <div id="tab-staff">
                    <!-- Add Staff Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-user-plus"></i>
                                TH√äM NH√ÇN VI√äN M·ªöI
                            </div>
                        </div>
                        <div class="toolbar">
                            <input type="text" id="addId" placeholder="M√£ NV" class="input-field" style="width:120px">
                            <input type="text" id="addName" placeholder="H·ªç T√™n" class="input-field" style="width:200px">
                            <input type="text" id="addDept" placeholder="B·ªô Ph·∫≠n" class="input-field" style="width:150px">
                            <input type="number" id="addSalary" placeholder="L∆∞∆°ng CB" class="input-field" style="width:150px" 
                                   oninput="validateSalaryInput(this)">
                            <button class="btn btn-primary" onclick="addNewStaff()">
                                <i class="fas fa-plus"></i> Th√™m m·ªõi
                            </button>
                            <button class="btn btn-sheet" onclick="saveNewStaffToGoogleSheet()">
                                <i class="fab fa-google-drive"></i> L∆∞u l√™n Google Sheet
                            </button>
                            <button class="btn btn-gray" onclick="quickCheckData()">
                                <i class="fas fa-search"></i> Ki·ªÉm tra d·ªØ li·ªáu
                            </button>
                            <button class="btn" style="background:linear-gradient(135deg,#4CAF50,#8BC34A); color:white;" onclick="checkDataIntegrity()">
                                <i class="fas fa-heartbeat"></i> Ki·ªÉm tra to√†n v·∫πn
                            </button>
                        </div>
                    </div>

                    <!-- Staff Management Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-users"></i>
                                DANH S√ÅCH NH√ÇN VI√äN
                            </div>
                        </div>
                        <div class="toolbar">
                            <div class="input-group">
                                <i class="fas fa-search" style="color:var(--gray-400)"></i>
                                <input type="text" id="searchStaff" placeholder="T√¨m M√£ NV ho·∫∑c T√™n..." 
                                       style="width:300px" onkeyup="renderStaff()">
                            </div>
                            
                            <label for="fileInput" class="btn btn-gray">
                                <i class="fas fa-file-import"></i> Nh·∫≠p Excel
                            </label>
                            <input type="file" id="fileInput" style="display:none" onchange="importExcel(this)">
                            
                            <button class="btn btn-google" onclick="loadFromGoogleSheet()">
                                <i class="fab fa-google"></i> T·∫£i t·ª´ Google Sheet
                            </button>
                            
                            <button class="btn btn-danger" onclick="deleteStaff()" style="margin-left:auto">
                                <i class="fas fa-user-minus"></i> X√≥a ƒë√£ ch·ªçn
                            </button>
                        </div>

                        <div class="table-container">
                            <div class="table-header">
                                T·ªïng: <span id="staff-count">0</span> nh√¢n vi√™n
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width:50px">
                                            <input type="checkbox" onclick="toggleAllStaff(this)">
                                        </th>
                                        <th>M√É NV</th>
                                        <th>H·ªå T√äN</th>
                                        <th>B·ªò PH·∫¨N</th>
                                        <th>L∆Ø∆†NG CB</th>
                                        <th style="width:120px">THAO T√ÅC</th>
                                    </tr>
                                </thead>
                                <tbody id="staffBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- OT Management Tab -->
                <div id="tab-ot" class="hidden">
                    <!-- Speed Controls -->
                    <div class="speed-controls" style="margin-bottom:10px;">
                        <button id="turboBtn" class="btn btn-sm" style="background:linear-gradient(135deg, #FF9800, #FF5722); color:white;" 
                                onclick="toggleTurboMode()" title="B·∫≠t/t·∫Øt ch·∫ø ƒë·ªô si√™u t·ªëc">
                            <i class="fas fa-bolt"></i> TURBO
                        </button>
                        <div id="speedInfo" class="speed-badge speed-fast">
                            <i class="fas fa-tachometer-alt"></i> AUTO
                        </div>
                        <button class="btn btn-sm" style="background:linear-gradient(135deg, #673AB7, #9C27B0); color:white;" 
                                onclick="showPerformanceStats()" title="Th·ªëng k√™ hi·ªáu su·∫•t">
                            <i class="fas fa-chart-line"></i> STATS
                        </button>
                    </div>

                    <!-- Auto Save Queue Status -->
                    <div id="queueStatus" class="queue-status hidden">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <strong><i class="fas fa-sync-alt"></i> H√†ng ƒë·ª£i ƒë·ªìng b·ªô</strong>
                            <span id="queueCountBadge" class="speed-badge">0 ƒëang ch·ªù</span>
                        </div>
                        <div class="progress-container">
                            <div id="queueProgress" class="progress-bar" style="width:0%"></div>
                        </div>
                        <div id="queueDetails" style="font-size:0.8rem; margin-top:8px; color:#666;">
                            <i class="fas fa-info-circle"></i> <span id="batchInfo">T·ª± ƒë·ªông g·ª≠i 8 ng∆∞·ªùi/l·∫ßn</span>
                        </div>
                    </div>

                    <!-- Filters Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-filter"></i>
                                L·ªåC & XU·∫§T D·ªÆ LI·ªÜU
                            </div>
                        </div>
                        <div class="toolbar">
                            <div class="input-group">
                                <span class="input-label">B·ªô ph·∫≠n:</span>
                                <select id="deptFilter" onchange="handleFilterChange()" style="width:180px">
                                    <option value="all">T·∫•t c·∫£</option>
                                </select>
                            </div>
                            
                            <div class="input-group">
                                <span class="input-label">Ng√†y c√¥ng:</span>
                                <input type="number" id="stdDays" value="26" style="width:80px" min="14" max="26" step="1"
                                       title="Nh·∫≠p s·ªë ng√†y c√¥ng th·ª±c t·∫ø (14-26 ng√†y)">
                                <button class="btn btn-sm" style="background:#e3f2fd; color:#1565c0;" 
                                        onclick="suggestWorkingDays()" 
                                        title="G·ª£i √Ω ng√†y c√¥ng theo l·ªãch">
                                    <i class="fas fa-lightbulb"></i> G·ª£i √Ω
                                </button>
                                <button class="btn btn-sm" style="background:#f3e5f5; color:#7b1fa2;" 
                                        onclick="applyCommonWorkingDays()"
                                        title="Ch·ªçn nhanh gi√° tr·ªã ph·ªï bi·∫øn">
                                    <i class="fas fa-bolt"></i> Nhanh
                                </button>
                                <button class="btn btn-sm" style="background:#fff3e0; color:#e65100;" 
                                        onclick="showWorkingDaysExample()"
                                        title="Xem v√≠ d·ª• t√≠nh ng√†y c√¥ng">
                                    <i class="fas fa-question-circle"></i> V√≠ d·ª•
                                </button>
                                <span class="error-message" id="stdDaysError"></span>
                            </div>
                            
                            <button class="btn btn-primary" onclick="renderOTFast(true)">
                                <i class="fas fa-filter"></i> Ch·ªâ hi·ªán c√≥ OT
                            </button>
                            
                            <button class="btn btn-gray" onclick="renderOTFast(false)">
                                <i class="fas fa-users"></i> Hi·ªán t·∫•t c·∫£
                            </button>
                            
                            <button class="btn btn-success" onclick="validateAndExport()" style="margin-left:auto">
                                <i class="fas fa-file-excel"></i> Xu·∫•t Excel (C·∫£ th√°ng)
                            </button>
                            
                            <button class="btn btn-sheet" onclick="manualSaveToGoogleSheet()">
                                <i class="fab fa-google-drive"></i> L∆∞u Google Sheet (Th·ªß c√¥ng)
                            </button>
                            
                            <button class="btn" style="background:linear-gradient(135deg,#9C27B0,#673AB7); color:white;" onclick="forceProcessQueue()">
                                <i class="fas fa-bolt"></i> ƒê·ªìng b·ªô ngay
                            </button>
                        </div>
                        
                        <!-- Working Days Info Panel -->
                        <div id="workingDaysInfo" class="working-days-info hidden">
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                                <i class="fas fa-info-circle" style="color:#2e7d32;"></i>
                                <strong>Th√¥ng tin ng√†y c√¥ng</strong>
                            </div>
                            <div id="workingDaysDetail">ƒêang t√≠nh to√°n...</div>
                        </div>
                    </div>

                    <!-- Bulk Edit Card -->
                    <div class="bulk-edit">
                        <div class="bulk-header">
                            <i class="fas fa-bolt"></i>
                            G√ÅN NHANH GI·ªú OT
                        </div>
                        <div class="coefficient-inputs">
                            <div class="coef-group">
                                <span class="coef-label">1.5</span>
                                <input type="number" id="b15" step="0.1" value="0.0" class="ot-input-fast">
                            </div>
                            <div class="coef-group">
                                <span class="coef-label">2.1</span>
                                <input type="number" id="b21" step="0.1" value="0.0" class="ot-input-fast">
                            </div>
                            <div class="coef-group">
                                <span class="coef-label">2.0</span>
                                <input type="number" id="b20" step="0.1" value="0.0" class="ot-input-fast">
                            </div>
                            <div class="coef-group">
                                <span class="coef-label">3.5</span>
                                <input type="number" id="b35" step="0.1" value="0.0" class="ot-input-fast">
                            </div>
                            
                            <button class="btn btn-warning" onclick="applyBulk(true)">
                                <i class="fas fa-check"></i> √Åp d·ª•ng d√≤ng ch·ªçn
                            </button>
                            
                            <button class="btn btn-gray" onclick="applyBulk(false)">
                                <i class="fas fa-check-double"></i> √Åp d·ª•ng t·∫•t c·∫£
                            </button>
                            
                            <button class="btn btn-danger" onclick="clearDay()">
                                <i class="fas fa-trash-alt"></i> X√≥a ng√†y n√†y
                            </button>
                        </div>
                    </div>

                    <!-- OT Table Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-table"></i>
                                B·∫¢NG CH·∫§M C√îNG OT
                            </div>
                        </div>
                        <div class="table-container" id="otTableContainer">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width:50px">
                                            <input type="checkbox" onclick="toggleAllOT(this)">
                                        </th>
                                        <th>NH√ÇN VI√äN</th>
                                        <th>1.5</th>
                                        <th>2.1</th>
                                        <th>2.0</th>
                                        <th>3.5</th>
                                        <th style="text-align:right; color:var(--danger);">TI·ªÄN NG√ÄY</th>
                                    </tr>
                                </thead>
                                <tbody id="otBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- History Tab (T√çNH NƒÇNG M·ªöI) -->
                <div id="tab-history" class="hidden">
                    <!-- Search and Filter -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-search"></i>
                                T√åM KI·∫æM L·ªäCH S·ª¨ OT THEO NH√ÇN VI√äN
                            </div>
                        </div>
                        <div class="toolbar">
                            <div class="input-group">
                                <span class="input-label">Nh√¢n vi√™n:</span>
                                <select id="historyStaff" style="width:250px" onchange="loadStaffOTHistory()">
                                    <option value="">Ch·ªçn nh√¢n vi√™n</option>
                                </select>
                            </div>
                            
                            <div class="input-group">
                                <span class="input-label">Th√°ng:</span>
                                <input type="month" id="historyMonth" style="width:150px" 
                                       onchange="loadStaffOTHistory()">
                            </div>
                            
                            <div class="input-group">
                                <span class="input-label">T·ª´ ng√†y:</span>
                                <input type="date" id="historyFrom" style="width:150px" onchange="loadStaffOTHistory()">
                            </div>
                            
                            <div class="input-group">
                                <span class="input-label">ƒê·∫øn ng√†y:</span>
                                <input type="date" id="historyTo" style="width:150px" onchange="loadStaffOTHistory()">
                            </div>
                            
                            <button class="btn btn-primary" onclick="loadStaffOTHistory(true)">
                                <i class="fas fa-search"></i> T√¨m ki·∫øm
                            </button>
                            
                            <button class="btn btn-success" onclick="exportStaffHistory()" style="margin-left:auto">
                                <i class="fas fa-file-excel"></i> Xu·∫•t Excel
                            </button>
                            
                            <button class="btn btn-warning" onclick="printStaffHistory()">
                                <i class="fas fa-print"></i> In b√°o c√°o
                            </button>
                        </div>
                    </div>

                    <!-- Stats Card -->
                    <div class="card" style="border-left:5px solid #4CAF50;">
                        <div class="card-header">
                            <div class="card-title" style="color:#4CAF50;">
                                <i class="fas fa-chart-bar"></i>
                                TH·ªêNG K√ä OT NH√ÇN VI√äN
                            </div>
                        </div>
                        <div class="history-stats">
                            <div class="history-stat-card">
                                <div class="history-stat-value" id="history-total-hours">0</div>
                                <div class="history-stat-label">T·ªïng gi·ªù OT</div>
                            </div>
                            <div class="history-stat-card">
                                <div class="history-stat-value" id="history-total-days">0</div>
                                <div class="history-stat-label">S·ªë ng√†y OT</div>
                            </div>
                            <div class="history-stat-card">
                                <div class="history-stat-value" id="history-total-money">0 ‚Ç´</div>
                                <div class="history-stat-label">T·ªïng ti·ªÅn OT</div>
                            </div>
                            <div class="history-stat-card">
                                <div class="history-stat-value" id="history-avg-day">0 ‚Ç´</div>
                                <div class="history-stat-label">Trung b√¨nh/ng√†y</div>
                            </div>
                        </div>
                    </div>

                    <!-- History Table -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-table"></i>
                                CHI TI·∫æT L·ªäCH S·ª¨ OT
                                <span id="history-staff-name" style="color:var(--primary); margin-left:10px;"></span>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>NG√ÄY</th>
                                        <th>TH·ª®</th>
                                        <th>1.5</th>
                                        <th>2.1</th>
                                        <th>2.0</th>
                                        <th>3.5</th>
                                        <th>T·ªîNG GI·ªú</th>
                                        <th>TI·ªÄN NG√ÄY</th>
                                        <th>GHI CH√ö</th>
                                    </tr>
                                </thead>
                                <tbody id="historyBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Account Management Tab -->
                <div id="tab-account" class="hidden">
                    <!-- Create Account Card -->
                    <div class="card" style="border-left:5px solid #9b59b6;">
                        <div class="card-header">
                            <div class="card-title" style="color:#9b59b6;">
                                <i class="fas fa-user-plus"></i>
                                T·∫†O T√ÄI KHO·∫¢N M·ªöI
                            </div>
                        </div>
                        <div class="toolbar">
                            <input type="text" id="newUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p" style="width:180px">
                            <input type="password" id="newPassword" placeholder="M·∫≠t kh·∫©u" style="width:180px">
                            <select id="newRole" style="width:150px">
                                <option value="user">Ng∆∞·ªùi d√πng</option>
                                <option value="admin">Qu·∫£n tr·ªã</option>
                            </select>
                            <button class="btn" style="background:linear-gradient(135deg,#9b59b6,#8e44ad); color:white;" 
                                    onclick="createAccount()">
                                <i class="fas fa-user-plus"></i> T·∫°o t√†i kho·∫£n
                            </button>
                            <button class="btn btn-google" onclick="manualSaveToGoogleSheet()">
                                <i class="fab fa-google"></i> L∆∞u t√†i kho·∫£n l√™n Google Sheet
                            </button>
                        </div>
                    </div>

                    <!-- Account List Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-users-cog"></i>
                                DANH S√ÅCH T√ÄI KHO·∫¢N
                            </div>
                        </div>
                        <div class="toolbar">
                            <div class="input-group">
                                <i class="fas fa-search" style="color:var(--gray-400)"></i>
                                <input type="text" id="searchAccount" placeholder="T√¨m t√†i kho·∫£n..." 
                                       style="width:300px" onkeyup="renderAccounts()">
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>T√ÄI KHO·∫¢N</th>
                                        <th>LO·∫†I</th>
                                        <th>NG√ÄY T·∫†O</th>
                                        <th style="width:200px">THAO T√ÅC</th>
                                    </tr>
                                </thead>
                                <tbody id="accountBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CORE SYSTEM ==========
        const GOOGLE_SHEET_API = "https://script.google.com/macros/s/AKfycbys53jjWG4HbzEUbDf-cGSHEQTDH_y1doNbkG4m8GHDT5mlC7z9ZsJb00YzGXXekSBK/exec";
        
        // ========== AUTO SAVE QUEUE SYSTEM - T·ªêI ∆ØU T·ªêC ƒê·ªò ==========
        let AUTO_SAVE_QUEUE = {
            pending: [],
            isProcessing: false,
            batchSize: 8,
            delayBetweenBatches: 300,
            maxRetries: 2,
            lastProcessedTime: 0,
            totalProcessed: 0,
            totalFailed: 0,
            avgProcessingTime: 0
        };
        
        let SEND_CACHE = new Map();
        const CACHE_DURATION = 3000;
        
        let TURBO_MODE = false;
        let CONNECTION_SPEED = 'NORMAL';
        
        // ========== DATA STRUCTURE ==========
        let DB = { 
            staff: [], 
            ot: {},
            users: [
                { username: "admin", password: "123456", role: "admin", created: new Date().toISOString() },
                { username: "user", password: "123", role: "user", created: new Date().toISOString() }
            ],
            settings: {}
        };
        
        let PERFORMANCE = {
            startTime: 0,
            renderCount: 0,
            updateCount: 0,
            lastRenderTime: 0,
            batchTimes: []
        };
        
        let STATS_CACHE = {
            totalMoney: 0,
            totalHours: 0,
            todayOTCount: 0,
            isDirty: true
        };
        
        let currentUser = "admin";
        let currentRole = "admin";
        let autoBackupInterval = null;
        let autoSaveInterval = null;
        
        const WORKING_DAYS_SETTINGS = {
            minDays: 14,
            maxDays: 26,
            defaultDays: 26
        };
        
        let hasSuggestedWorkingDays = false;
        
        // ========== NETWORK SPEED DETECTION ==========
        async function detectConnectionSpeed() {
            try {
                const startTime = Date.now();
                const testUrl = GOOGLE_SHEET_API + '?action=ping&t=' + startTime;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                await fetch(testUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                const pingTime = Date.now() - startTime;
                
                if (pingTime < 500) {
                    CONNECTION_SPEED = 'FAST';
                    AUTO_SAVE_QUEUE.batchSize = 10;
                    AUTO_SAVE_QUEUE.delayBetweenBatches = 200;
                } else if (pingTime < 1500) {
                    CONNECTION_SPEED = 'NORMAL';
                    AUTO_SAVE_QUEUE.batchSize = 8;
                    AUTO_SAVE_QUEUE.delayBetweenBatches = 300;
                } else {
                    CONNECTION_SPEED = 'SLOW';
                    AUTO_SAVE_QUEUE.batchSize = 5;
                    AUTO_SAVE_QUEUE.delayBetweenBatches = 500;
                }
                
                updateSpeedInfo();
                console.log(`üì° T·ªëc ƒë·ªô m·∫°ng: ${CONNECTION_SPEED} (${pingTime}ms)`);
                
            } catch (error) {
                CONNECTION_SPEED = 'SLOW';
                AUTO_SAVE_QUEUE.batchSize = 5;
                AUTO_SAVE_QUEUE.delayBetweenBatches = 800;
                updateSpeedInfo();
                console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ detect t·ªëc ƒë·ªô m·∫°ng');
            }
        }
        
        function updateSpeedInfo() {
            const speedInfo = document.getElementById('speedInfo');
            const batchInfo = document.getElementById('batchInfo');
            
            if (speedInfo) {
                speedInfo.className = `speed-badge speed-${CONNECTION_SPEED.toLowerCase()}`;
                speedInfo.innerHTML = `<i class="fas fa-tachometer-alt"></i> ${CONNECTION_SPEED}`;
            }
            
            if (batchInfo) {
                batchInfo.textContent = `T·ª± ƒë·ªông g·ª≠i ${AUTO_SAVE_QUEUE.batchSize} ng∆∞·ªùi/l·∫ßn`;
            }
            
            document.getElementById('batchSize').textContent = AUTO_SAVE_QUEUE.batchSize;
            document.getElementById('batchDelay').textContent = AUTO_SAVE_QUEUE.delayBetweenBatches;
        }
        
        // ========== TURBO MODE ==========
        function toggleTurboMode() {
            TURBO_MODE = !TURBO_MODE;
            const turboBtn = document.getElementById('turboBtn');
            
            if (TURBO_MODE) {
                AUTO_SAVE_QUEUE.batchSize = 12;
                AUTO_SAVE_QUEUE.delayBetweenBatches = 150;
                CONNECTION_SPEED = 'TURBO';
                
                turboBtn.innerHTML = '<i class="fas fa-bolt"></i> TURBO ON';
                turboBtn.style.background = 'linear-gradient(135deg, #FF5722, #D50000)';
                turboBtn.classList.add('turbo-active');
                
                showToast('üöÄ ƒê√£ b·∫≠t ch·∫ø ƒë·ªô TURBO! T·ªëc ƒë·ªô x4', 'warning');
                console.log('üöÄ TURBO MODE: B·∫≠t - 12 ng∆∞·ªùi/batch, 150ms delay');
            } else {
                TURBO_MODE = false;
                detectConnectionSpeed();
                
                turboBtn.innerHTML = '<i class="fas fa-bolt"></i> TURBO';
                turboBtn.style.background = 'linear-gradient(135deg, #FF9800, #FF5722)';
                turboBtn.classList.remove('turbo-active');
                
                showToast('‚ö° ƒê√£ t·∫Øt ch·∫ø ƒë·ªô TURBO', 'info');
                console.log('üê¢ TURBO MODE: T·∫Øt');
            }
            
            updateSpeedInfo();
            updateQueueStatusDisplay();
        }
        
        // ========== AUTO SAVE QUEUE FUNCTIONS ==========
        function addToAutoSaveQueue(staffId, date, field, value) {
            const key = `${date}_${staffId}_${field}`;
            const timestamp = Date.now();
            
            if (!AUTO_SAVE_QUEUE.pending.some(item => item.key === key)) {
                AUTO_SAVE_QUEUE.pending.push({
                    key,
                    staffId,
                    date,
                    field,
                    value,
                    timestamp,
                    retries: 0,
                    status: 'pending'
                });
            } else {
                const item = AUTO_SAVE_QUEUE.pending.find(item => item.key === key);
                item.value = value;
                item.timestamp = timestamp;
                item.retries = 0;
                item.status = 'pending';
            }
            
            if (!AUTO_SAVE_QUEUE.isProcessing) {
                startAutoSaveProcessor();
            }
            
            updateQueueStatusDisplay();
        }
        
        async function startAutoSaveProcessor() {
            if (AUTO_SAVE_QUEUE.isProcessing || AUTO_SAVE_QUEUE.pending.length === 0) {
                AUTO_SAVE_QUEUE.isProcessing = false;
                return;
            }
            
            AUTO_SAVE_QUEUE.isProcessing = true;
            
            try {
                while (AUTO_SAVE_QUEUE.pending.length > 0) {
                    const batch = AUTO_SAVE_QUEUE.pending.splice(0, AUTO_SAVE_QUEUE.batchSize);
                    
                    batch.forEach(item => item.status = 'processing');
                    
                    const startTime = Date.now();
                    const success = await sendBatchToGoogleSheet(batch);
                    const processingTime = Date.now() - startTime;
                    
                    PERFORMANCE.batchTimes.push(processingTime);
                    if (PERFORMANCE.batchTimes.length > 10) {
                        PERFORMANCE.batchTimes.shift();
                    }
                    
                    if (success) {
                        AUTO_SAVE_QUEUE.totalProcessed += batch.length;
                        AUTO_SAVE_QUEUE.lastProcessedTime = Date.now();
                        
                        const avg = PERFORMANCE.batchTimes.reduce((a, b) => a + b, 0) / PERFORMANCE.batchTimes.length;
                        AUTO_SAVE_QUEUE.avgProcessingTime = Math.round(avg);
                        
                        updateSyncStatus(`ƒê√£ ƒë·ªìng b·ªô ${batch.length} m·ª•c (${processingTime}ms)`);
                    } else {
                        batch.forEach(item => {
                            item.retries++;
                            item.status = 'failed';
                            if (item.retries < AUTO_SAVE_QUEUE.maxRetries) {
                                AUTO_SAVE_QUEUE.pending.unshift(item);
                            } else {
                                AUTO_SAVE_QUEUE.totalFailed++;
                                console.warn(`Item th·∫•t b·∫°i sau ${AUTO_SAVE_QUEUE.maxRetries} l·∫ßn th·ª≠:`, item);
                            }
                        });
                        
                        break;
                    }
                    
                    updateQueueStatusDisplay();
                    updatePerformanceStats();
                    
                    if (AUTO_SAVE_QUEUE.pending.length > 0) {
                        await new Promise(resolve => setTimeout(resolve, AUTO_SAVE_QUEUE.delayBetweenBatches));
                    }
                }
            } catch (error) {
                console.error("L·ªói auto save processor:", error);
                showToast('‚ùå L·ªói ƒë·ªìng b·ªô: ' + error.message, 'error');
            } finally {
                AUTO_SAVE_QUEUE.isProcessing = false;
                AUTO_SAVE_QUEUE.lastProcessedTime = Date.now();
                
                if (AUTO_SAVE_QUEUE.pending.length > 0) {
                    setTimeout(startAutoSaveProcessor, 5000);
                }
                
                updateQueueStatusDisplay();
            }
        }
        
        async function sendBatchToGoogleSheet(batch) {
            if (batch.length === 0) return true;
            
            try {
                const optimizedData = {};
                
                batch.forEach(item => {
                    const key = `${item.date}_${item.staffId}`;
                    if (!optimizedData[key]) {
                        optimizedData[key] = {
                            date: item.date,
                            staffId: item.staffId,
                            data: { h15: 0, h21: 0, h20: 0, h35: 0 }
                        };
                    }
                    optimizedData[key].data[item.field] = item.value;
                });
                
                const apiData = {};
                Object.values(optimizedData).forEach(item => {
                    if (!apiData[item.date]) apiData[item.date] = {};
                    apiData[item.date][item.staffId] = item.data;
                });
                
                const cacheKey = Object.keys(apiData).sort().join('|') + 
                                Object.values(apiData).map(d => JSON.stringify(d)).join('|');
                
                if (SEND_CACHE.has(cacheKey)) {
                    console.log('üîÑ B·ªè qua batch ƒë√£ g·ª≠i g·∫ßn ƒë√¢y');
                    return true;
                }
                
                const url = GOOGLE_SHEET_API + 
                    '?action=saveBatch' +
                    '&data=' + encodeURIComponent(JSON.stringify(apiData)) +
                    '&timestamp=' + encodeURIComponent(new Date().toISOString()) +
                    '&user=' + encodeURIComponent(currentUser) +
                    '&speed=' + CONNECTION_SPEED +
                    '&t=' + Date.now();
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                
                const response = await fetch(url, { 
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    SEND_CACHE.set(cacheKey, Date.now());
                    
                    setTimeout(() => {
                        SEND_CACHE.delete(cacheKey);
                    }, CACHE_DURATION);
                    
                    const actualCount = Object.keys(optimizedData).length;
                    console.log(`‚úÖ ƒê√£ g·ª≠i ${actualCount} nh√¢n vi√™n (${batch.length} fields) - ${CONNECTION_SPEED} mode`);
                    
                    return true;
                } else {
                    console.warn('‚ö†Ô∏è API tr·∫£ v·ªÅ l·ªói:', result.error);
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå L·ªói g·ª≠i batch:', error.name, error.message);
                
                if (error.name === 'AbortError') {
                    console.log('‚è±Ô∏è Timeout - Gi·∫£m t·ªëc ƒë·ªô');
                    AUTO_SAVE_QUEUE.batchSize = Math.max(3, AUTO_SAVE_QUEUE.batchSize - 2);
                    AUTO_SAVE_QUEUE.delayBetweenBatches += 200;
                    updateSpeedInfo();
                }
                
                return false;
            }
        }
        
        function updateQueueStatusDisplay() {
            const pendingCount = AUTO_SAVE_QUEUE.pending.length;
            const statusEl = document.getElementById('syncStatus');
            const statusTextEl = document.getElementById('syncStatusText');
            const queueStatusEl = document.getElementById('queueStatus');
            const queueCountBadge = document.getElementById('queueCountBadge');
            const queueCount = document.getElementById('queueCount');
            const queueProgressEl = document.getElementById('queueProgress');
            
            if (statusEl && statusTextEl) {
                if (pendingCount === 0) {
                    statusEl.innerHTML = '<i class="fas fa-check-circle" style="color:var(--success)"></i>';
                    statusTextEl.textContent = 'ƒê√£ ƒë·ªìng b·ªô';
                } else if (AUTO_SAVE_QUEUE.isProcessing) {
                    statusEl.innerHTML = '<i class="fas fa-sync-alt fa-spin" style="color:var(--accent)"></i>';
                    statusTextEl.textContent = `ƒêang ƒë·ªìng b·ªô (${pendingCount})`;
                } else {
                    statusEl.innerHTML = '<i class="fas fa-hourglass-half" style="color:var(--warning)"></i>';
                    statusTextEl.textContent = `Ch·ªù ƒë·ªìng b·ªô (${pendingCount})`;
                }
            }
            
            if (queueStatusEl) {
                if (pendingCount > 0) {
                    queueStatusEl.classList.remove('hidden');
                    
                    if (queueCountBadge) {
                        queueCountBadge.textContent = `${pendingCount} ƒëang ch·ªù`;
                        queueCountBadge.className = `speed-badge ${pendingCount > 20 ? 'speed-slow' : 'speed-fast'}`;
                    }
                    
                    if (queueProgressEl) {
                        const estimatedTotal = pendingCount + AUTO_SAVE_QUEUE.totalProcessed;
                        const progress = estimatedTotal > 0 ? 
                            (AUTO_SAVE_QUEUE.totalProcessed / estimatedTotal * 100) : 0;
                        queueProgressEl.style.width = `${Math.min(100, progress)}%`;
                    }
                } else {
                    queueStatusEl.classList.add('hidden');
                }
            }
            
            if (queueCount) {
                queueCount.textContent = pendingCount;
            }
        }
        
        function showQueueStatus() {
            const popup = document.getElementById('queueStatusPopup');
            const content = document.getElementById('queueStatusContent');
            
            if (!popup || !content) return;
            
            const pendingCount = AUTO_SAVE_QUEUE.pending.length;
            
            let html = `
                <div style="margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>ƒêang ch·ªù:</span>
                        <strong>${pendingCount} m·ª•c</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>ƒê√£ x·ª≠ l√Ω:</span>
                        <strong>${AUTO_SAVE_QUEUE.totalProcessed} m·ª•c</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>Th·∫•t b·∫°i:</span>
                        <strong style="color:${AUTO_SAVE_QUEUE.totalFailed > 0 ? 'var(--danger)' : 'inherit'}">
                            ${AUTO_SAVE_QUEUE.totalFailed} m·ª•c
                        </strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span>Tr·∫°ng th√°i:</span>
                        <strong>${AUTO_SAVE_QUEUE.isProcessing ? 'ƒêang x·ª≠ l√Ω' : 'Ch·ªù'}</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span>Batch size:</span>
                        <strong>${AUTO_SAVE_QUEUE.batchSize} ng∆∞·ªùi</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span>T·ªëc ƒë·ªô:</span>
                        <strong class="speed-${CONNECTION_SPEED.toLowerCase()}">${CONNECTION_SPEED}</strong>
                    </div>
                </div>
            `;
            
            if (pendingCount > 0) {
                html += `<div style="border-top:1px solid #eee; padding-top:10px; max-height:200px; overflow-y:auto;">`;
                html += `<div style="font-weight:bold; margin-bottom:5px;">Chi ti·∫øt h√†ng ƒë·ª£i:</div>`;
                
                AUTO_SAVE_QUEUE.pending.slice(0, 10).forEach((item, index) => {
                    const timeAgo = Math.floor((Date.now() - item.timestamp) / 1000);
                    html += `
                        <div class="queue-item">
                            <div>
                                <small>${item.staffId} - ${item.date}</small><br>
                                <span style="font-size:0.75rem; color:#666;">
                                    ${item.field}: ${item.value} gi·ªù
                                </span>
                            </div>
                            <div>
                                <span style="font-size:0.7rem; color:#999;">
                                    ${timeAgo}s tr∆∞·ªõc
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                if (pendingCount > 10) {
                    html += `<div style="text-align:center; padding:5px; color:#666; font-size:0.8rem;">
                        ... v√† ${pendingCount - 10} m·ª•c kh√°c
                    </div>`;
                }
                
                html += `</div>`;
            }
            
            content.innerHTML = html;
            popup.classList.remove('hidden');
        }
        
        function forceProcessQueue() {
            if (AUTO_SAVE_QUEUE.pending.length === 0) {
                showToast("Kh√¥ng c√≥ d·ªØ li·ªáu n√†o ƒëang ch·ªù ƒë·ªìng b·ªô!", 'info');
                return;
            }
            
            if (!AUTO_SAVE_QUEUE.isProcessing) {
                startAutoSaveProcessor();
                showToast(`ƒêang b·∫Øt ƒë·∫ßu ƒë·ªìng b·ªô ${AUTO_SAVE_QUEUE.pending.length} m·ª•c...`, 'info');
            } else {
                showToast("H·ªá th·ªëng ƒëang t·ª± ƒë·ªông ƒë·ªìng b·ªô. Vui l√≤ng ch·ªù!", 'warning');
            }
        }
        
        // ========== TOAST NOTIFICATION ==========
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'error-popup';
            toast.style.background = type === 'warning' ? '#FF9800' : 
                                     type === 'error' ? '#FF1744' : 
                                     type === 'success' ? '#00C853' : '#2962FF';
            
            const icon = type === 'warning' ? 'fa-bolt' :
                         type === 'error' ? 'fa-exclamation-triangle' :
                         type === 'success' ? 'fa-check-circle' : 'fa-info-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            const container = document.getElementById('toastContainer');
            if (!container) {
                const newContainer = document.createElement('div');
                newContainer.id = 'toastContainer';
                newContainer.style.position = 'fixed';
                newContainer.style.top = '20px';
                newContainer.style.right = '20px';
                newContainer.style.zIndex = '10001';
                document.body.appendChild(newContainer);
                newContainer.appendChild(toast);
            } else {
                container.appendChild(toast);
            }
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
        
        // ========== PERFORMANCE STATS ==========
        function updatePerformanceStats() {
            const perfStats = document.getElementById('perfStats');
            if (!perfStats) return;
            
            perfStats.innerHTML = `
                ‚ö° ${AUTO_SAVE_QUEUE.batchSize} ng∆∞·ªùi/batch | 
                ‚è±Ô∏è ${AUTO_SAVE_QUEUE.delayBetweenBatches}ms | 
                üìä ${AUTO_SAVE_QUEUE.pending.length} ch·ªù
            `;
        }
        
        function showPerformanceStats() {
            const stats = `
                üìä TH·ªêNG K√ä HI·ªÜU SU·∫§T:
                
                ‚Ä¢ T·ªëc ƒë·ªô m·∫°ng: ${CONNECTION_SPEED}
                ‚Ä¢ Batch size: ${AUTO_SAVE_QUEUE.batchSize} ng∆∞·ªùi
                ‚Ä¢ Delay: ${AUTO_SAVE_QUEUE.delayBetweenBatches}ms
                ‚Ä¢ ƒêang ch·ªù: ${AUTO_SAVE_QUEUE.pending.length} m·ª•c
                ‚Ä¢ ƒê√£ x·ª≠ l√Ω: ${AUTO_SAVE_QUEUE.totalProcessed} m·ª•c
                ‚Ä¢ Th·∫•t b·∫°i: ${AUTO_SAVE_QUEUE.totalFailed} m·ª•c
                ‚Ä¢ Avg time: ${AUTO_SAVE_QUEUE.avgProcessingTime}ms
                ‚Ä¢ Turbo mode: ${TURBO_MODE ? 'ON üöÄ' : 'OFF'}
                
                ‚ö° T·ªêC ƒê·ªò D·ª∞ KI·∫æN:
                ‚Ä¢ 30 ng∆∞·ªùi: ~${Math.round((30 / AUTO_SAVE_QUEUE.batchSize) * (AUTO_SAVE_QUEUE.delayBetweenBatches / 1000 + 0.5))} gi√¢y
                ‚Ä¢ 100 ng∆∞·ªùi: ~${Math.round((100 / AUTO_SAVE_QUEUE.batchSize) * (AUTO_SAVE_QUEUE.delayBetweenBatches / 1000 + 0.5))} gi√¢y
            `;
            
            alert(stats);
        }
        
        // ========== LOCAL STORAGE ==========
        function saveToLocalStorage() {
            try {
                const backupData = {
                    staff: DB.staff,
                    ot: DB.ot,
                    users: DB.users,
                    settings: DB.settings,
                    timestamp: new Date().toISOString(),
                    version: '3.0'
                };
                
                localStorage.setItem('dongju_ot_backup', JSON.stringify(backupData));
                return true;
            } catch(e) {
                console.error("‚ùå L·ªói l∆∞u localStorage:", e);
                return false;
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('dongju_ot_backup');
                if(saved) {
                    const data = JSON.parse(saved);
                    DB.staff = data.staff || DB.staff;
                    DB.ot = data.ot || DB.ot;
                    DB.users = data.users || DB.users;
                    DB.settings = data.settings || DB.settings;
                    return true;
                }
            } catch(e) {
                console.error("‚ùå L·ªói ƒë·ªçc localStorage:", e);
            }
            return false;
        }
        
        function clearAllData() {
            if(!confirm("X√°c nh·∫≠n x√≥a to√†n b·ªô d·ªØ li·ªáu c·ª•c b·ªô?\n\nD·ªØ li·ªáu tr√™n Google Sheet s·∫Ω KH√îNG b·ªã x√≥a.\nCh·ªâ x√≥a d·ªØ li·ªáu trong tr√¨nh duy·ªát n√†y.")) return;
            
            localStorage.removeItem('dongju_ot_backup');
            DB = { 
                staff: [], 
                ot: {},
                users: [
                    { username: "admin", password: "123456", role: "admin", created: new Date().toISOString() },
                    { username: "user", password: "123", role: "user", created: new Date().toISOString() }
                ],
                settings: {}
            };
            
            AUTO_SAVE_QUEUE.pending = [];
            AUTO_SAVE_QUEUE.totalProcessed = 0;
            AUTO_SAVE_QUEUE.totalFailed = 0;
            
            renderStaff();
            updateQueueStatusDisplay();
            showToast("‚úÖ ƒê√£ x√≥a d·ªØ li·ªáu c·ª•c b·ªô!", 'success');
        }
        
        // ========== GOOGLE SHEET FUNCTIONS ==========
        async function manualSaveToGoogleSheet() {
            if(!confirm("X√°c nh·∫≠n l∆∞u d·ªØ li·ªáu l√™n Google Sheet?\n\nTo√†n b·ªô d·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o Google Sheet c·ªßa b·∫°n.")) return;
            
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync-alt loading"></i> ƒêang l∆∞u l√™n Google Sheet...';
            
            saveToLocalStorage();
            
            try {
                const url = GOOGLE_SHEET_API + 
                    '?action=save' +
                    '&staff=' + encodeURIComponent(JSON.stringify(DB.staff)) +
                    '&ot=' + encodeURIComponent(JSON.stringify(DB.ot)) +
                    '&users=' + encodeURIComponent(JSON.stringify(DB.users)) +
                    '&settings=' + encodeURIComponent(JSON.stringify(DB.settings)) +
                    '&timestamp=' + encodeURIComponent(new Date().toISOString()) +
                    '&user=' + encodeURIComponent(currentUser);
                
                const response = await fetch(url, { method: 'GET' });
                const result = await response.json();
                
                if(result.success) {
                    document.getElementById('syncStatus').innerHTML = 
                        '<i class="fab fa-google" style="color:var(--success)"></i> ƒê√£ l∆∞u Google Sheet ' + new Date().toLocaleTimeString();
                    
                    let message = "‚úÖ L∆∞u th√†nh c√¥ng v√†o Google Sheet!\n\n";
                    if(result.results) {
                        if(result.results.staff) message += `‚Ä¢ Nh√¢n vi√™n: ${result.results.staff.saved || 0}\n`;
                        if(result.results.ot) message += `‚Ä¢ OT records: ${result.results.ot.saved || 0}\n`;
                        if(result.results.users) message += `‚Ä¢ T√†i kho·∫£n: ${result.results.users.saved || 0}\n`;
                    }
                    message += `‚Ä¢ Th·ªùi gian: ${new Date().toLocaleTimeString()}`;
                    
                    alert(message);
                } else {
                    throw new Error(result.error || "L·ªói t·ª´ Google Sheet");
                }
                
            } catch(error) {
                console.error("‚ùå L·ªói l∆∞u Google Sheet:", error);
                alert("‚ö†Ô∏è L∆∞u v√†o Google Sheet th·∫•t b·∫°i!\n\nƒê√£ t·ª± ƒë·ªông backup v√†o tr√¨nh duy·ªát (localStorage).\nL·ªói: " + error.message);
                document.getElementById('syncStatus').innerHTML = 
                    '<i class="fas fa-hdd" style="color:var(--warning)"></i> ƒê√£ l∆∞u c·ª•c b·ªô';
            }
        }
        
        async function saveNewStaffToGoogleSheet() {
            if(DB.staff.length === 0) {
                alert("Kh√¥ng c√≥ nh√¢n vi√™n n√†o ƒë·ªÉ l∆∞u!");
                return;
            }
            
            if(!confirm("X√°c nh·∫≠n l∆∞u danh s√°ch nh√¢n vi√™n l√™n Google Sheet?\n\nT·∫•t c·∫£ nh√¢n vi√™n s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o Google Sheet.")) return;
            
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync-alt loading"></i> ƒêang l∆∞u nh√¢n vi√™n l√™n Google Sheet...';
            
            try {
                const url = GOOGLE_SHEET_API + 
                    '?action=save' +
                    '&staff=' + encodeURIComponent(JSON.stringify(DB.staff)) +
                    '&timestamp=' + encodeURIComponent(new Date().toISOString()) +
                    '&user=' + encodeURIComponent(currentUser);
                
                const response = await fetch(url, { method: 'GET' });
                const result = await response.json();
                
                if(result.success) {
                    document.getElementById('syncStatus').innerHTML = 
                        '<i class="fab fa-google" style="color:var(--success)"></i> ƒê√£ l∆∞u nh√¢n vi√™n ' + new Date().toLocaleTimeString();
                    
                    alert(`‚úÖ ƒê√£ l∆∞u ${DB.staff.length} nh√¢n vi√™n l√™n Google Sheet th√†nh c√¥ng!\n\nTh·ªùi gian: ${new Date().toLocaleTimeString()}`);
                } else {
                    throw new Error(result.error || "L·ªói t·ª´ Google Sheet");
                }
                
            } catch(error) {
                console.error("‚ùå L·ªói l∆∞u nh√¢n vi√™n:", error);
                alert("‚ö†Ô∏è L∆∞u nh√¢n vi√™n th·∫•t b·∫°i!\n\nL·ªói: " + error.message);
                document.getElementById('syncStatus').innerHTML = 
                    '<i class="fas fa-exclamation-triangle" style="color:var(--warning)"></i> L∆∞u th·∫•t b·∫°i';
            }
        }
        
        async function loadFromGoogleSheet() {
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync-alt loading"></i> ƒêang t·∫£i t·ª´ Google Sheet...';
            
            try {
                const response = await fetch(GOOGLE_SHEET_API + '?action=load&t=' + Date.now());
                const result = await response.json();
                
                if(result.success && result.staff) {
                    DB.staff = result.staff || [];
                    DB.ot = result.ot || {};
                    DB.users = result.users || [];
                    DB.settings = result.settings || {};
                    
                    saveToLocalStorage();
                    
                    document.getElementById('syncStatus').innerHTML = 
                        '<i class="fab fa-google" style="color:var(--success)"></i> ƒê√£ ƒë·ªìng b·ªô Google Sheet ' + new Date().toLocaleTimeString();
                    
                    renderStaff();
                    updateDeptList();
                    if(document.getElementById('tab-ot').classList.contains('hidden') === false) {
                        renderOTFast(false);
                        updateStatsFull();
                        updateWorkingDaysInfo();
                    }
                    
                    alert("‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ Google Sheet th√†nh c√¥ng!\n\n‚Ä¢ Nh√¢n vi√™n: " + DB.staff.length + "\n‚Ä¢ Ng√†y OT: " + Object.keys(DB.ot).length);
                    
                } else {
                    throw new Error(result.error || "Failed to load data from Google Sheet");
                }
                
            } catch(error) {
                console.error("‚ùå Google Sheet load error:", error);
                
                if(loadFromLocalStorage()) {
                    document.getElementById('syncStatus').innerHTML = 
                        '<i class="fas fa-hdd" style="color:var(--warning)"></i> ƒê√£ t·∫£i t·ª´ b·∫£n l∆∞u c·ª•c b·ªô';
                    
                    renderStaff();
                    updateDeptList();
                    
                    alert("‚ö†Ô∏è ƒêang d√πng d·ªØ li·ªáu t·ª´ b·∫£n l∆∞u tr√¨nh duy·ªát\n\nGoogle Sheet c√≥ th·ªÉ kh√¥ng kh·∫£ d·ª•ng.\nL·ªói: " + error.message);
                    return;
                }
                
                document.getElementById('syncStatus').innerHTML = 
                    '<i class="fas fa-exclamation-triangle" style="color:var(--warning)"></i> Kh√¥ng th·ªÉ k·∫øt n·ªëi';
                
                alert("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Google Sheet!\n\nVui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet v√† URL API.\nL·ªói: " + error.message);
            }
        }
        
        async function forceReloadFromGoogleSheet() {
            if(!confirm("T·∫£i l·∫°i to√†n b·ªô d·ªØ li·ªáu t·ª´ Google Sheet?\n\nD·ªØ li·ªáu ch∆∞a l∆∞u tr√™n m√°y n√†y s·∫Ω b·ªã m·∫•t!")) return;
            
            document.getElementById('syncStatus').innerHTML = 
                '<i class="fas fa-sync-alt loading"></i> ƒêang t·∫£i d·ªØ li·ªáu m·ªõi nh·∫•t...';
            
            try {
                const response = await fetch(GOOGLE_SHEET_API + '?action=load&force=true&t=' + Date.now());
                const result = await response.json();
                
                if(result.success) {
                    // X√ìA HO√ÄN TO√ÄN localStorage c≈©
                    localStorage.removeItem('dongju_ot_backup');
                    
                    // Load d·ªØ li·ªáu m·ªõi
                    DB.staff = result.staff || [];
                    DB.ot = result.ot || {};
                    DB.users = result.users || [];
                    DB.settings = result.settings || {};
                    
                    // L∆∞u v√†o localStorage m·ªõi
                    saveToLocalStorage();
                    
                    // C·∫≠p nh·∫≠t giao di·ªán
                    renderStaff();
                    updateDeptList();
                    if(document.getElementById('tab-ot').classList.contains('hidden') === false) {
                        renderOTFast(false);
                        updateStatsFull();
                        updateWorkingDaysInfo();
                    }
                    
                    document.getElementById('syncStatus').innerHTML = 
                        '<i class="fab fa-google" style="color:var(--success)"></i> ƒê√£ t·∫£i d·ªØ li·ªáu m·ªõi ' + new Date().toLocaleTimeString();
                    
                    showToast(`‚úÖ ƒê√£ t·∫£i ${DB.staff.length} nh√¢n vi√™n v√† ${Object.keys(DB.ot).length} ng√†y OT t·ª´ Google Sheet!`, 'success');
                    
                    // Log ƒë·ªÉ debug
                    console.log("Force reload result:", {
                        staff: DB.staff.length,
                        otDates: Object.keys(DB.ot).length,
                        otRecords: countOTRecords(DB.ot)
                    });
                    
                } else {
                    throw new Error(result.error || "L·ªói t·∫£i d·ªØ li·ªáu");
                }
                
            } catch(error) {
                console.error("‚ùå Force reload error:", error);
                showToast('‚ùå L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
                document.getElementById('syncStatus').innerHTML = 
                    '<i class="fas fa-exclamation-triangle" style="color:var(--warning)"></i> L·ªói t·∫£i d·ªØ li·ªáu';
            }
        }
        
        async function testGoogleSheetConnection() {
            console.log("üîó Testing Google Sheet connection...");
            
            try {
                const pingResponse = await fetch(GOOGLE_SHEET_API + '?action=ping');
                const pingData = await pingResponse.json();
                console.log("‚úÖ Ping result:", pingData);
                
                const loadResponse = await fetch(GOOGLE_SHEET_API + '?action=load');
                const loadData = await loadResponse.json();
                console.log("‚úÖ Load result:", {
                    success: loadData.success,
                    staffCount: loadData.staff?.length || 0,
                    otDays: Object.keys(loadData.ot || {}).length
                });
                
                alert("‚úÖ K·∫øt n·ªëi Google Sheet th√†nh c√¥ng!\n\n‚Ä¢ API Status: " + pingData.message + "\n‚Ä¢ Staff Count: " + (loadData.staff?.length || 0) + "\n‚Ä¢ OT Days: " + Object.keys(loadData.ot || {}).length);
                
            } catch(error) {
                console.error("‚ùå Connection test failed:", error);
                alert("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Google Sheet:\n\n" + error.message + "\n\nKi·ªÉm tra:\n1. URL API ƒë√∫ng ch∆∞a?\n2. ƒê√£ deploy web app ch∆∞a?\n3. Web app set 'Anyone' access ch∆∞a?");
            }
        }
        
        // ========== STAFF MANAGEMENT ==========
        function addNewStaff() {
            const id = document.getElementById('addId').value.trim();
            const name = document.getElementById('addName').value.trim();
            const dept = document.getElementById('addDept').value.trim();
            const salary = parseFloat(document.getElementById('addSalary').value);
            
            if(!id || !name || !dept || isNaN(salary) || salary <= 0) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin h·ª£p l·ªá!\nL∆∞∆°ng ph·∫£i > 0");
                return;
            }
            
            if(DB.staff.some(s => s.id === id)) {
                alert("M√£ nh√¢n vi√™n n√†y ƒë√£ t·ªìn t·∫°i!");
                return;
            }
            
            DB.staff.push({ id, name, dept, salary });
            renderStaff();
            
            document.getElementById('addId').value = "";
            document.getElementById('addName').value = "";
            document.getElementById('addDept').value = "";
            document.getElementById('addSalary').value = "";
            
            saveToLocalStorage();
            showToast(`‚úÖ ƒê√£ th√™m ${name} v√†o danh s√°ch!`, 'success');
        }
        
        function validateSalaryInput(input) {
            const value = parseFloat(input.value);
            if(isNaN(value) || value <= 0) {
                input.classList.add('validation-error');
            } else {
                input.classList.remove('validation-error');
            }
        }
        
        function renderStaff() {
            const keyword = document.getElementById('searchStaff').value.toLowerCase();
            const filtered = DB.staff.filter(s => 
                s.id.toLowerCase().includes(keyword) || 
                s.name.toLowerCase().includes(keyword)
            );
            
            let html = '';
            filtered.forEach(s => {
                html += `
                <tr id="row-${s.id}">
                    <td><input type="checkbox" class="staff-cb" data-id="${s.id}"></td>
                    <td><strong>${s.id}</strong></td>
                    <td>${s.name}</td>
                    <td><span class="dept-badge">${s.dept}</span></td>
                    <td style="font-weight:bold; color:var(--primary);">${Number(s.salary).toLocaleString()} ‚Ç´</td>
                    <td>
                        <button class="btn btn-edit btn-sm" onclick="editStaff('${s.id}')">
                            <i class="fas fa-edit"></i> S·ª≠a
                        </button>
                    </td>
                </tr>`;
            });
            
            document.getElementById('staffBody').innerHTML = html;
            document.getElementById('staff-count').textContent = filtered.length;
        }
        
        function editStaff(id) {
            const staff = DB.staff.find(s => s.id === id);
            if(!staff) return;
            
            const newName = prompt("S·ª≠a t√™n nh√¢n vi√™n:", staff.name);
            if(newName === null) return;
            if(newName.trim() === "") {
                alert("T√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
                return;
            }
            
            const newDept = prompt("S·ª≠a b·ªô ph·∫≠n:", staff.dept);
            if(newDept === null) return;
            
            const newSalary = prompt("S·ª≠a l∆∞∆°ng c∆° b·∫£n:", staff.salary);
            if(newSalary === null) return;
            const salaryNum = parseFloat(newSalary);
            if(isNaN(salaryNum) || salaryNum <= 0) {
                alert("L∆∞∆°ng ph·∫£i l√† s·ªë d∆∞∆°ng!");
                return;
            }
            
            staff.name = newName.trim();
            staff.dept = newDept.trim();
            staff.salary = salaryNum;
            
            renderStaff();
            saveToLocalStorage();
            showToast(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin ${staff.name}!`, 'success');
        }
        
        function deleteStaff() {
            const ids = Array.from(document.querySelectorAll('.staff-cb:checked')).map(cb => cb.dataset.id);
            if(ids.length === 0) return alert("Vui l√≤ng ch·ªçn nh√¢n s·ª±!");
            
            const currentMonth = new Date().toISOString().substring(0,7);
            
            if(!confirm(`X√≥a ${ids.length} nh√¢n s·ª± n√†y?\n\nL∆∞u √Ω: D·ªØ li·ªáu OT c·ªßa h·ªç v·∫´n ƒë∆∞·ª£c gi·ªØ l·∫°i trong th√°ng ${currentMonth} ƒë·ªÉ t√≠nh l∆∞∆°ng, s·∫Ω t·ª± ƒë·ªông x√≥a sau th√°ng n√†y.`)) return;
            
            DB.staff = DB.staff.filter(s => !ids.includes(s.id));
            renderStaff();
            saveToLocalStorage();
            showToast(`‚úÖ ƒê√£ x√≥a ${ids.length} nh√¢n s·ª±!`, 'success');
        }
        
        function toggleAllStaff(el) { 
            document.querySelectorAll('.staff-cb').forEach(cb => cb.checked = el.checked); 
        }
        
        // ========== WORKING DAYS MANAGEMENT ==========
        function calculateMaxWorkingDays(year, month) {
            const date = new Date(year, month - 1, 1);
            let workingDays = 0;
            
            while(date.getMonth() === month - 1) {
                const day = date.getDay();
                if(day >= 1 && day <= 6) {
                    workingDays++;
                }
                date.setDate(date.getDate() + 1);
            }
            
            return workingDays;
        }
        
        function suggestWorkingDays() {
            const dateInput = document.getElementById('workDate');
            if(!dateInput || !dateInput.value) {
                alert("Vui l√≤ng ch·ªçn ng√†y l√†m vi·ªác tr∆∞·ªõc!");
                return;
            }
            
            const dateStr = dateInput.value;
            const [year, month] = dateStr.split('-').map(Number);
            
            const totalWorkingDays = calculateMaxWorkingDays(year, month);
            const suggestedDays = Math.min(WORKING_DAYS_SETTINGS.maxDays, totalWorkingDays);
            
            const monthNames = ["Th√°ng 1", "Th√°ng 2", "Th√°ng 3", "Th√°ng 4", "Th√°ng 5", "Th√°ng 6",
                              "Th√°ng 7", "Th√°ng 8", "Th√°ng 9", "Th√°ng 10", "Th√°ng 11", "Th√°ng 12"];
            
            const infoPanel = document.getElementById('workingDaysInfo');
            const infoDetail = document.getElementById('workingDaysDetail');
            
            if(infoPanel && infoDetail) {
                infoDetail.innerHTML = `
                    <div style="margin-bottom:8px;">
                        <strong>${monthNames[month-1]}/${year}</strong> c√≥ ${totalWorkingDays} ng√†y th·ª© 2-7
                    </div>
                    <div style="color:#2e7d32; font-weight:600;">
                        <i class="fas fa-lightbulb"></i> G·ª£i √Ω: ${suggestedDays} ng√†y c√¥ng
                    </div>
                    <div style="margin-top:5px; font-size:0.8rem; color:#666;">
                        Nh·∫≠p s·ªë ng√†y c√¥ng th·ª±c t·∫ø v√†o √¥ b√™n tr√™n
                    </div>
                `;
                infoPanel.classList.remove('hidden');
            }
        }
        
        function applyCommonWorkingDays() {
            const commonDays = [
                {label: "26 ng√†y (Full)", value: 26},
                {label: "25 ng√†y", value: 25},
                {label: "24 ng√†y", value: 24},
                {label: "23 ng√†y", value: 23},
                {label: "22 ng√†y", value: 22},
                {label: "21 ng√†y", value: 21},
                {label: "20 ng√†y", value: 20},
                {label: "19 ng√†y", value: 19},
                {label: "18 ng√†y", value: 18},
                {label: "17 ng√†y", value: 17},
                {label: "16 ng√†y", value: 16},
                {label: "15 ng√†y", value: 15},
                {label: "14 ng√†y (T·ªëi thi·ªÉu)", value: 14}
            ];
            
            let optionsHTML = commonDays.map(day => 
                `<button class="quick-day-btn" data-value="${day.value}">
                    ${day.label}
                </button>`
            ).join('');
            
            const popup = document.createElement('div');
            popup.innerHTML = `
                <div style="background:white; padding:20px; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.2); min-width:200px;">
                    <h4 style="margin-bottom:15px; color:var(--primary);">
                        <i class="fas fa-bolt"></i> Ch·ªçn nhanh ng√†y c√¥ng
                    </h4>
                    <div id="quickDaysContainer">
                        ${optionsHTML}
                    </div>
                    <button class="btn btn-gray" onclick="this.parentElement.parentElement.remove()" 
                            style="width:100%; margin-top:15px;">
                        <i class="fas fa-times"></i> ƒê√≥ng
                    </button>
                </div>
            `;
            
            popup.style.position = 'fixed';
            popup.style.top = '50%';
            popup.style.left = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
            popup.style.zIndex = '10000';
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                document.querySelectorAll('.quick-day-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const value = parseInt(this.dataset.value);
                        document.getElementById('stdDays').value = value;
                        handleStdDaysChange();
                        updateWorkingDaysInfo();
                        document.body.removeChild(popup);
                    });
                });
            }, 10);
        }
        
        function showWorkingDaysExample() {
            const examples = `
            üìä **V√ç D·ª§ TH·ª∞C T·∫æ C√îNG TY B·∫†N:**
            
            ‚Ä¢ Th√°ng 12/2025: C√≥ 27 ng√†y th·ª© 2-7
              ‚Üí C√¥ng ty quy ƒë·ªãnh t·ªëi ƒëa 26 ng√†y
              ‚Üí Nh·∫≠p: 26
            
            ‚Ä¢ Th√°ng 2/2025: C√≥ 24 ng√†y th·ª© 2-7
              ‚Üí Ngh·ªâ T·∫øt 1 tu·∫ßn
              ‚Üí Nh·∫≠p: 18-20 (t√πy ch√≠nh s√°ch)
            
            ‚Ä¢ Th√°ng 7/2025: C√≥ 26 ng√†y th·ª© 2-7
              ‚Üí C√¥ng ty cho ngh·ªâ h√® 2 ng√†y
              ‚Üí Nh·∫≠p: 24
            
            ‚Ä¢ Th√°ng ngh·ªâ h·∫øt h√†ng:
              ‚Üí Nh·∫≠p: 14-16 (t·ªëi thi·ªÉu theo lu·∫≠t)
            
            ‚ö†Ô∏è **L∆ØU √ù:** Ng∆∞·ªùi l√†m l∆∞∆°ng c·∫ßn cƒÉn c·ª© v√†o:
            1. L·ªãch ngh·ªâ c·ªßa c√¥ng ty
            2. Ch√≠nh s√°ch t·ª´ng th√°ng
            3. Quy ƒë·ªãnh ph√°p lu·∫≠t (t·ªëi thi·ªÉu)
            
            üí° **C√îNG TH·ª®C T√çNH L∆Ø∆†NG GI·ªú:**
            L∆∞∆°ng gi·ªù = L∆∞∆°ng th√°ng / (Ng√†y c√¥ng √ó 8 gi·ªù)
            
            V√≠ d·ª•: L∆∞∆°ng 10,000,000ƒë / (26 ng√†y √ó 8 gi·ªù) = 48,076ƒë/gi·ªù
            `;
            
            alert(examples);
        }
        
        function updateWorkingDaysInfo() {
            const dateInput = document.getElementById('workDate');
            const stdDaysInput = document.getElementById('stdDays');
            const infoPanel = document.getElementById('workingDaysInfo');
            
            if(!dateInput || !dateInput.value || !stdDaysInput || !infoPanel) return;
            
            const dateStr = dateInput.value;
            const [year, month] = dateStr.split('-').map(Number);
            const stdDays = parseInt(stdDaysInput.value) || WORKING_DAYS_SETTINGS.defaultDays;
            
            const maxDays = calculateMaxWorkingDays(year, month);
            
            const monthNames = ["Th√°ng 1", "Th√°ng 2", "Th√°ng 3", "Th√°ng 4", "Th√°ng 5", "Th√°ng 6",
                              "Th√°ng 7", "Th√°ng 8", "Th√°ng 9", "Th√°ng 10", "Th√°ng 11", "Th√°ng 12"];
            
            let infoHTML = `
                <div style="margin-bottom:8px;">
                    <strong>${monthNames[month-1]}/${year}</strong> c√≥ ${maxDays} ng√†y th·ª© 2-7
                </div>
                <div style="color:#2e7d32; font-weight:600;">
                    <i class="fas fa-calculator"></i> ƒêang d√πng: ${stdDays} ng√†y c√¥ng
                </div>
            `;
            
            if(stdDays < maxDays && stdDays < WORKING_DAYS_SETTINGS.maxDays) {
                infoHTML += `
                    <div style="color:#ff9800; margin-top:5px; font-size:0.8rem;">
                        <i class="fas fa-info-circle"></i> 
                        ${maxDays - stdDays} ng√†y ƒë∆∞·ª£c t√≠nh l√† ngh·ªâ (ngh·ªâ ph√©p, ngh·ªâ l·ªÖ, ngh·ªâ c√¥ng ty)
                    </div>
                `;
            } else if(stdDays === WORKING_DAYS_SETTINGS.maxDays && maxDays > WORKING_DAYS_SETTINGS.maxDays) {
                infoHTML += `
                    <div style="color:#2196f3; margin-top:5px; font-size:0.8rem;">
                        <i class="fas fa-info-circle"></i> 
                        √Åp d·ª•ng quy ƒë·ªãnh t·ªëi ƒëa ${WORKING_DAYS_SETTINGS.maxDays} ng√†y (d√π c√≥ ${maxDays} ng√†y th·ª© 2-7)
                    </div>
                `;
            }
            
            infoPanel.innerHTML = infoHTML;
            infoPanel.classList.remove('hidden');
        }
        
        // ========== OT MANAGEMENT ==========
        function updateDeptList() {
            const depts = [...new Set(DB.staff.map(s => s.dept))];
            const select = document.getElementById('deptFilter');
            select.innerHTML = '<option value="all">T·∫•t c·∫£ b·ªô ph·∫≠n</option>' + 
                depts.map(d => `<option value="${d}">${d}</option>`).join('');
        }
        
        function renderOTFast(onlyOT = false) {
            PERFORMANCE.startTime = performance.now();
            
            const date = document.getElementById('workDate').value;
            if(!date) return;
            
            const dept = document.getElementById('deptFilter').value;
            const days = parseFloat(document.getElementById('stdDays').value) || WORKING_DAYS_SETTINGS.defaultDays;
            const otToday = DB.ot[date] || {};
            
            let html = '';
            
            if(STATS_CACHE.isDirty) {
                updateStatsFull();
            }
            
            DB.staff.forEach(s => {
                if(dept !== 'all' && s.dept !== dept) return;
                const d = otToday[s.id] || {h15:0, h21:0, h20:0, h35:0};
                if(onlyOT && (d.h15+d.h21+d.h20+d.h35) === 0) return;
                
                const h15 = Number(d.h15) || 0;
                const h21 = Number(d.h21) || 0;
                const h20 = Number(d.h20) || 0;
                const h35 = Number(d.h35) || 0;
                const salary = Number(s.salary) || 0;
                
                let money = 0;
                if(salary > 0 && days > 0) {
                    const hourlyRate = salary / (days * 8);
                    money = (h15 * 1.5 + h21 * 2.1 + h20 * 2.0 + h35 * 3.5) * hourlyRate;
                }
                
                const hasOT = (h15+h21+h20+h35) > 0;
                
                html += `<tr data-id="${s.id}" class="${hasOT ? 'highlight' : ''}">
                    <td><input type="checkbox" class="ot-cb" data-id="${s.id}"></td>
                    <td>
                        <div style="font-weight:600;">${s.name}</div>
                        <div style="font-size:0.85rem; color:var(--gray-600);">${s.id} ‚Ä¢ ${s.dept}</div>
                    </td>
                    <td><input type="number" value="${h15}" step="0.1" min="0" 
                           class="ot-input-fast" data-id="${s.id}" data-field="h15"></td>
                    <td><input type="number" value="${h21}" step="0.1" min="0" 
                           class="ot-input-fast" data-id="${s.id}" data-field="h21"></td>
                    <td><input type="number" value="${h20}" step="0.1" min="0" 
                           class="ot-input-fast" data-id="${s.id}" data-field="h20"></td>
                    <td><input type="number" value="${h35}" step="0.1" min="0" 
                           class="ot-input-fast" data-id="${s.id}" data-field="h35"></td>
                    <td class="money-cell" data-id="${s.id}" style="text-align:right; font-weight:700; color:var(--danger);">
                        ${isNaN(money) ? '0' : Math.round(money).toLocaleString()} ‚Ç´
                    </td>
                </tr>`;
            });
            
            document.getElementById('otBody').innerHTML = html || 
                '<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--gray-400);">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
            
            PERFORMANCE.lastRenderTime = performance.now() - PERFORMANCE.startTime;
            PERFORMANCE.renderCount++;
            
            setTimeout(() => {
                const otBody = document.getElementById('otBody');
                if(otBody) {
                    otBody.addEventListener('input', debounce(function(e) {
                        if(e.target.classList.contains('ot-input-fast')) {
                            updateOTFast(e.target);
                        }
                    }, 100));
                }
            }, 100);
        }
        
        function updateOTFast(input) {
            const id = input.dataset.id;
            const field = input.dataset.field;
            const value = parseFloat(input.value) || 0;
            const date = document.getElementById('workDate').value;
            
            if(!date) return;
            
            const oldValue = (DB.ot[date] && DB.ot[date][id] && DB.ot[date][id][field]) || 0;
            
            if(!DB.ot[date]) DB.ot[date] = {};
            if(!DB.ot[date][id]) DB.ot[date][id] = {h15:0, h21:0, h20:0, h35:0};
            DB.ot[date][id][field] = value;
            
            addToAutoSaveQueue(id, date, field, value);
            
            saveToLocalStorage();
            
            updateRowMoneyFast(id, date);
            
            updateStatsIncremental(id, field, oldValue, value, date);
            
            input.classList.add('updating');
            setTimeout(() => input.classList.remove('updating'), 300);
        }
        
        function updateRowMoneyFast(id, date) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if(!row) return;
            
            const salary = Number(DB.staff.find(s => s.id === id)?.salary) || 0;
            const days = parseFloat(document.getElementById('stdDays').value) || WORKING_DAYS_SETTINGS.defaultDays;
            const ot = DB.ot[date][id] || {h15:0, h21:0, h20:0, h35:0};
            
            const h15 = Number(ot.h15) || 0;
            const h21 = Number(ot.h21) || 0;
            const h20 = Number(ot.h20) || 0;
            const h35 = Number(ot.h35) || 0;
            
            let money = 0;
            if(salary > 0 && days > 0) {
                const hourlyRate = salary / (days * 8);
                money = (h15 * 1.5 + h21 * 2.1 + h20 * 2.0 + h35 * 3.5) * hourlyRate;
            }
            
            const moneyCell = row.querySelector('.money-cell');
            if(moneyCell) {
                moneyCell.textContent = isNaN(money) ? '0 ‚Ç´' : Math.round(money).toLocaleString() + ' ‚Ç´';
                moneyCell.classList.add('updating');
                setTimeout(() => moneyCell.classList.remove('updating'), 300);
            }
            
            const hasOT = (h15+h21+h20+h35) > 0;
            if(hasOT) {
                row.classList.add('highlight');
            } else {
                row.classList.remove('highlight');
            }
        }
        
        function updateStatsIncremental(id, field, oldValue, newValue, date) {
            const staff = DB.staff.find(s => s.id === id);
            if(!staff) return;
            
            const salary = Number(staff.salary) || 0;
            const days = parseFloat(document.getElementById('stdDays').value) || WORKING_DAYS_SETTINGS.defaultDays;
            
            if(salary > 0 && days > 0) {
                const hourlyRate = salary / (days * 8);
                const coefficient = {
                    'h15': 1.5, 'h21': 2.1, 
                    'h20': 2.0, 'h35': 3.5
                }[field] || 1;
                
                const oldMoney = oldValue * coefficient * hourlyRate;
                const newMoney = newValue * coefficient * hourlyRate;
                
                STATS_CACHE.totalMoney += (newMoney - oldMoney);
                STATS_CACHE.totalHours += (newValue - oldValue);
                
                document.getElementById('stat-total-money').textContent = 
                    Math.round(Math.max(0, STATS_CACHE.totalMoney)).toLocaleString() + ' ‚Ç´';
                document.getElementById('stat-total-ot').textContent = 
                    Math.max(0, STATS_CACHE.totalHours).toFixed(1);
                
                const todayOT = DB.ot[date] || {};
                const todayOTCount = Object.keys(todayOT).filter(staffId => {
                    const ot = todayOT[staffId];
                    return (ot.h15 + ot.h21 + ot.h20 + ot.h35) > 0;
                }).length;
                document.getElementById('stat-today-ot').textContent = todayOTCount;
            }
        }
        
        function updateStatsFull() {
            const date = document.getElementById('workDate').value;
            if(!date) return;
            
            const month = date.substring(0,7);
            const days = parseFloat(document.getElementById('stdDays').value) || WORKING_DAYS_SETTINGS.defaultDays;
            
            let totalHours = 0;
            let totalMoney = 0;
            let todayOTCount = 0;
            
            Object.keys(DB.ot).forEach(d => {
                if(d.startsWith(month)) {
                    Object.entries(DB.ot[d]).forEach(([staffId, ot]) => {
                        const staff = DB.staff.find(s => s.id === staffId);
                        if(staff) {
                            const h15 = Number(ot.h15) || 0;
                            const h21 = Number(ot.h21) || 0;
                            const h20 = Number(ot.h20) || 0;
                            const h35 = Number(ot.h35) || 0;
                            
                            totalHours += h15 + h21 + h20 + h35;
                            
                            const salary = Number(staff.salary) || 0;
                            if(salary > 0 && days > 0) {
                                const hourlyRate = salary / (days * 8);
                                totalMoney += (h15 * 1.5 + h21 * 2.1 + h20 * 2.0 + h35 * 3.5) * hourlyRate;
                            }
                        }
                    });
                }
            });
            
            const todayOT = DB.ot[date] || {};
            todayOTCount = Object.keys(todayOT).filter(staffId => {
                const ot = todayOT[staffId];
                return (ot.h15 + ot.h21 + ot.h20 + ot.h35) > 0;
            }).length;
            
            STATS_CACHE.totalMoney = totalMoney;
            STATS_CACHE.totalHours = totalHours;
            STATS_CACHE.todayOTCount = todayOTCount;
            STATS_CACHE.isDirty = false;
            
            document.getElementById('stat-total-staff').textContent = DB.staff.length;
            document.getElementById('stat-total-ot').textContent = totalHours.toFixed(1);
            document.getElementById('stat-total-money').textContent = 
                isNaN(totalMoney) ? '0 ‚Ç´' : Math.round(totalMoney).toLocaleString() + ' ‚Ç´';
            document.getElementById('stat-today-ot').textContent = todayOTCount;
        }
        
        function handleDateChange() {
            STATS_CACHE.isDirty = true;
            
            if(!hasSuggestedWorkingDays) {
                setTimeout(suggestWorkingDays, 100);
                hasSuggestedWorkingDays = true;
            }
            
            renderOTFast(false);
            updateWorkingDaysInfo();
            updateQueueStatusDisplay();
        }
        
        function handleFilterChange() {
            renderOTFast(false);
        }
        
        function handleStdDaysChange() {
            STATS_CACHE.isDirty = true;
            updateStatsFull();
            updateWorkingDaysInfo();
            
            const date = document.getElementById('workDate').value;
            if(date && DB.ot[date]) {
                Object.keys(DB.ot[date]).forEach(id => {
                    updateRowMoneyFast(id, date);
                });
            }
        }
        
        // ========== BULK OPERATIONS ==========
        function applyBulk(selectedOnly) {
            const date = document.getElementById('workDate').value;
            if(!date) return;
            
            const dept = document.getElementById('deptFilter').value;
            const ids = Array.from(document.querySelectorAll('.ot-cb:checked')).map(cb => cb.dataset.id);
            const vals = { 
                h15: parseFloat(document.getElementById('b15').value) || 0, 
                h21: parseFloat(document.getElementById('b21').value) || 0, 
                h20: parseFloat(document.getElementById('b20').value) || 0, 
                h35: parseFloat(document.getElementById('b35').value) || 0 
            };
            
            if(!DB.ot[date]) DB.ot[date] = {};
            
            if(selectedOnly) {
                ids.forEach(id => {
                    DB.ot[date][id] = {...vals};
                    
                    Object.keys(vals).forEach(field => {
                        addToAutoSaveQueue(id, date, field, vals[field]);
                    });
                    
                    updateRowMoneyFast(id, date);
                });
                showToast(`‚úÖ ƒê√£ √°p d·ª•ng gi·ªù OT cho ${ids.length} nh√¢n vi√™n ƒë√£ ch·ªçn!`, 'success');
            } else {
                let appliedCount = 0;
                DB.staff.forEach(s => { 
                    if(dept === 'all' || s.dept === dept) { 
                        DB.ot[date][s.id] = {...vals}; 
                        
                        Object.keys(vals).forEach(field => {
                            addToAutoSaveQueue(s.id, date, field, vals[field]);
                        });
                        
                        appliedCount++;
                    } 
                });
                renderOTFast();
                showToast(`‚úÖ ƒê√£ √°p d·ª•ng gi·ªù OT cho ${appliedCount} nh√¢n vi√™n!`, 'success');
            }
            
            STATS_CACHE.isDirty = true;
            updateStatsFull();
            saveToLocalStorage();
        }
        
        function clearDay() { 
            const date = document.getElementById('workDate').value;
            if(!date) return;
            
            if(!confirm("X√≥a s·∫°ch gi·ªù OT ng√†y n√†y?\n\nThao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c!")) return; 
            
            delete DB.ot[date]; 
            
            AUTO_SAVE_QUEUE.pending = AUTO_SAVE_QUEUE.pending.filter(item => item.date !== date);
            
            renderOTFast();
            STATS_CACHE.isDirty = true;
            updateStatsFull();
            saveToLocalStorage();
            updateQueueStatusDisplay();
            showToast("‚úÖ ƒê√£ x√≥a gi·ªù OT ng√†y n√†y!", 'success');
        }
        
        function toggleAllOT(el) { 
            document.querySelectorAll('.ot-cb').forEach(cb => cb.checked = el.checked); 
        }
        
        function importExcel(input) {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                const newStaff = json.slice(1).filter(r => r[0]).map(r => ({ 
                    id: String(r[0]), 
                    name: r[1], 
                    dept: r[2], 
                    salary: parseFloat(r[3]) || 0 
                }));
                
                DB.staff = [...DB.staff, ...newStaff.filter(newS => 
                    !DB.staff.some(existing => existing.id === newS.id)
                )];
                
                renderStaff();
                saveToLocalStorage();
                showToast(`‚úÖ ƒê√£ nh·∫≠p ${newStaff.length} nh√¢n vi√™n t·ª´ Excel!`, 'success');
            };
            reader.readAsArrayBuffer(input.files[0]);
        }
        
        // ========== VALIDATION & EXPORT ==========
        function validateDataBeforeExport() {
            const errors = [];
            
            const stdDays = parseFloat(document.getElementById('stdDays').value);
            if(isNaN(stdDays) || stdDays < WORKING_DAYS_SETTINGS.minDays || stdDays > WORKING_DAYS_SETTINGS.maxDays) {
                errors.push(`‚ùå S·ªë ng√†y c√¥ng kh√¥ng h·ª£p l·ªá! Ph·∫£i nh·∫≠p s·ªë t·ª´ ${WORKING_DAYS_SETTINGS.minDays}-${WORKING_DAYS_SETTINGS.maxDays}`);
            }
            
            const invalidStaff = DB.staff.filter(s => {
                const salary = Number(s.salary);
                return isNaN(salary) || salary <= 0;
            });
            
            if(invalidStaff.length > 0) {
                invalidStaff.slice(0, 5).forEach(s => {
                    errors.push(`‚ùå Nh√¢n vi√™n ${s.name} (${s.id}) c√≥ l∆∞∆°ng kh√¥ng h·ª£p l·ªá: ${s.salary}`);
                });
                if(invalidStaff.length > 5) {
                    errors.push(`... v√† ${invalidStaff.length - 5} nh√¢n vi√™n kh√°c`);
                }
            }
            
            return errors;
        }
        
        function validateAndExport() {
            const errors = validateDataBeforeExport();
            
            if(errors.length > 0) {
                const errorMsg = "C√≥ l·ªói d·ªØ li·ªáu:\n\n" + errors.join("\n");
                const shouldContinue = confirm(errorMsg + "\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c xu·∫•t Excel kh√¥ng?");
                if(!shouldContinue) return;
            }
            
            exportExcel();
        }
        
        function exportExcel() {
            const date = document.getElementById('workDate').value;
            if(!date) {
                alert("Vui l√≤ng ch·ªçn ng√†y l√†m vi·ªác!");
                return;
            }
            
            const year = date.substring(0,4);
            const month = date.substring(5,7);
            const stdDays = parseFloat(document.getElementById('stdDays').value) || WORKING_DAYS_SETTINGS.defaultDays;
            
            if(isNaN(stdDays) || stdDays < WORKING_DAYS_SETTINGS.minDays || stdDays > WORKING_DAYS_SETTINGS.maxDays) {
                alert(`S·ªë ng√†y c√¥ng kh√¥ng h·ª£p l·ªá! Vui l√≤ng nh·∫≠p s·ªë t·ª´ ${WORKING_DAYS_SETTINGS.minDays}-${WORKING_DAYS_SETTINGS.maxDays}.`);
                document.getElementById('stdDays').focus();
                return;
            }
            
            const daysInMonth = new Date(year, month, 0).getDate();
            let exportData = [];
            
            DB.staff.forEach(s => {
                let row = { 
                    "M√£ NV": s.id, 
                    "H·ªç T√™n": s.name, 
                    "B·ªô ph·∫≠n": s.dept, 
                    "L∆∞∆°ng CB": Number(s.salary) || 0 
                };
                
                let totalMoney = 0;
                let hasAnyOTInMonth = false;
                
                for(let i = 1; i <= daysInMonth; i++) {
                    let dayStr = i < 10 ? '0' + i : i;
                    let dStr = `${year}-${month}-${dayStr}`;
                    let ot = DB.ot[dStr]?.[s.id];
                    
                    if(ot) {
                        const h15 = Number(ot.h15) || 0;
                        const h21 = Number(ot.h21) || 0;
                        const h20 = Number(ot.h20) || 0;
                        const h35 = Number(ot.h35) || 0;
                        
                        if(h15 + h21 + h20 + h35 > 0) {
                            let sum = [];
                            if(h15 > 0) sum.push(`${h15}(1.5)`); 
                            if(h21 > 0) sum.push(`${h21}(2.1)`);
                            if(h20 > 0) sum.push(`${h20}(2.0)`); 
                            if(h35 > 0) sum.push(`${h35}(3.5)`);
                            row[`Ng√†y ${i}`] = sum.join(", ");
                            
                            const salary = Number(s.salary) || 0;
                            if(salary > 0 && stdDays > 0) {
                                const hourlyRate = salary / (stdDays * 8);
                                totalMoney += (h15 * 1.5 + h21 * 2.1 + h20 * 2.0 + h35 * 3.5) * hourlyRate;
                            }
                            hasAnyOTInMonth = true;
                        } else {
                            row[`Ng√†y ${i}`] = "";
                        }
                    } else {
                        row[`Ng√†y ${i}`] = "";
                    }
                }
                
                if(hasAnyOTInMonth) { 
                    row["T·ªîNG TI·ªÄN OT"] = Math.round(totalMoney); 
                    exportData.push(row); 
                }
            });
            
            if(exportData.length === 0) {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu OT trong th√°ng n√†y!");
                return;
            }
            
            const totalRow = {
                "M√£ NV": "T·ªîNG C·ªòNG",
                "H·ªç T√™n": "",
                "B·ªô ph·∫≠n": "",
                "L∆∞∆°ng CB": "",
            };
            
            const grandTotal = exportData.reduce((sum, row) => {
                return sum + (Number(row["T·ªîNG TI·ªÄN OT"]) || 0);
            }, 0);
            
            totalRow["T·ªîNG TI·ªÄN OT"] = Math.round(grandTotal);
            exportData.push(totalRow);
            
            try {
                const ws = XLSX.utils.json_to_sheet(exportData, {skipHeader: false});
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, `OT_${month}_${year}`);
                
                const wscols = [
                    {wch: 10},
                    {wch: 25},
                    {wch: 15},
                    {wch: 12},
                ];
                
                for(let i = 1; i <= daysInMonth; i++) {
                    wscols.push({wch: 12});
                }
                wscols.push({wch: 15});
                
                ws['!cols'] = wscols;
                
                const range = XLSX.utils.decode_range(ws['!ref']);
                for(let R = range.s.r; R <= range.e.r; R++) {
                    const cellAddress = XLSX.utils.encode_cell({r: R, c: range.e.c});
                    const cell = ws[cellAddress];
                    if(cell && cell.v !== undefined && cell.v !== "T·ªîNG TI·ªÄN OT") {
                        if(!isNaN(cell.v)) {
                            ws[cellAddress].z = '#,##0';
                        }
                    }
                }
                
                XLSX.writeFile(wb, `OT_DONGJU_${month}_${year}.xlsx`);
                alert(`‚úÖ ƒê√£ xu·∫•t file Excel th√†nh c√¥ng!\n\n‚Ä¢ S·ªë nh√¢n vi√™n c√≥ OT: ${exportData.length - 1}\n‚Ä¢ T·ªïng ti·ªÅn OT: ${grandTotal.toLocaleString()} ‚Ç´\n‚Ä¢ Ng√†y c√¥ng s·ª≠ d·ª•ng: ${stdDays} ng√†y\n‚Ä¢ Xu·∫•t d·ªØ li·ªáu: C·∫£ th√°ng ${month}/${year}`);
            } catch(e) {
                alert("‚ùå L·ªói xu·∫•t file Excel: " + e.message);
            }
        }
        
        // ========== ACCOUNT MANAGEMENT ==========
        function createAccount() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const role = document.getElementById('newRole').value;
            
            if(!username || !password) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                return;
            }
            
            if(DB.users.some(u => u.username === username)) {
                alert("T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i!");
                return;
            }
            
            if(password.length < 3) {
                alert("M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±!");
                return;
            }
            
            const newUser = {
                username,
                password,
                role,
                created: new Date().toISOString()
            };
            
            DB.users.push(newUser);
            
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            
            renderAccounts();
            saveToLocalStorage();
            
            const shouldSave = confirm(`‚úÖ ƒê√£ t·∫°o t√†i kho·∫£n ${username}!\n\nB·∫°n c√≥ mu·ªën l∆∞u t√†i kho·∫£n l√™n Google Sheet ngay b√¢y gi·ªù?\n\n(N·∫øu kh√¥ng l∆∞u, t√†i kho·∫£n s·∫Ω m·∫•t khi refresh trang)`);
            if(shouldSave) {
                manualSaveToGoogleSheet();
            } else {
                alert("‚ö†Ô∏è L∆∞u √Ω: T√†i kho·∫£n m·ªõi ch∆∞a ƒë∆∞·ª£c l∆∞u l√™n Google Sheet. H√£y nh·∫•n n√∫t 'L∆∞u Google Sheet' tr∆∞·ªõc khi refresh trang!");
            }
        }
        
        function renderAccounts() {
            const keyword = document.getElementById('searchAccount').value.toLowerCase();
            let html = '';
            
            DB.users.forEach(user => {
                if(user.username.toLowerCase().includes(keyword)) {
                    const createdDate = new Date(user.created).toLocaleDateString('vi-VN');
                    const roleColor = user.role === 'admin' ? '#e74c3c' : '#3498db';
                    const roleText = user.role === 'admin' ? 'Qu·∫£n tr·ªã' : 'Ng∆∞·ªùi d√πng';
                    
                    html += `
                    <tr>
                        <td>
                            <div style="font-weight:600;">${user.username}</div>
                            <div style="font-size:0.85rem; color:var(--gray-600);">T·∫°o: ${createdDate}</div>
                        </td>
                        <td>
                            <span style="background:${roleColor}; color:white; padding:5px 12px; border-radius:20px; font-size:0.85rem; font-weight:600;">
                                ${roleText}
                            </span>
                        </td>
                        <td>${createdDate}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="changePassword('${user.username}')" ${user.username === currentUser ? '' : 'disabled'}>
                                <i class="fas fa-key"></i> ƒê·ªïi MK
                            </button>
                            ${user.username !== 'admin' && user.username !== currentUser ? `
                            <button class="btn btn-danger btn-sm" onclick="deleteAccount('${user.username}')">
                                <i class="fas fa-trash"></i> X√≥a
                            </button>
                            ` : ''}
                        </td>
                    </tr>`;
                }
            });
            document.getElementById('accountBody').innerHTML = html;
        }
        
        function changePassword(username) {
            if(username !== currentUser) {
                alert("Ch·ªâ c√≥ th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u t√†i kho·∫£n c·ªßa ch√≠nh b·∫°n!");
                return;
            }
            
            const newPass = prompt("Nh·∫≠p m·∫≠t kh·∫©u m·ªõi cho t√†i kho·∫£n " + username + ":");
            if(newPass && newPass.length >= 3) {
                const user = DB.users.find(u => u.username === username);
                user.password = newPass;
                alert("‚úÖ ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u!");
                
                saveToLocalStorage();
                
                const shouldSave = confirm("B·∫°n c√≥ mu·ªën l∆∞u thay ƒë·ªïi m·∫≠t kh·∫©u l√™n Google Sheet ngay b√¢y gi·ªù?");
                if(shouldSave) {
                    manualSaveToGoogleSheet();
                }
                renderAccounts();
            } else if(newPass !== null) {
                alert("M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±!");
            }
        }
        
        function deleteAccount(username) {
            if(username === 'admin') {
                alert("Kh√¥ng th·ªÉ x√≥a t√†i kho·∫£n admin ch√≠nh!");
                return;
            }
            if(username === currentUser) {
                alert("Kh√¥ng th·ªÉ x√≥a t√†i kho·∫£n ƒëang ƒëƒÉng nh·∫≠p!");
                return;
            }
            
            if(confirm(`X√°c nh·∫≠n x√≥a t√†i kho·∫£n ${username}?\n\nSau khi x√≥a, t√†i kho·∫£n n√†y s·∫Ω kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p ƒë∆∞·ª£c n·ªØa.`)) {
                DB.users = DB.users.filter(u => u.username !== username);
                
                saveToLocalStorage();
                
                const shouldSave = confirm("ƒê√£ x√≥a t√†i kho·∫£n!\n\nB·∫°n c√≥ mu·ªën l∆∞u thay ƒë·ªïi l√™n Google Sheet ngay b√¢y gi·ªù?");
                if(shouldSave) {
                    manualSaveToGoogleSheet();
                }
                
                renderAccounts();
                alert("‚úÖ ƒê√£ x√≥a t√†i kho·∫£n!");
            }
        }
        
        // ========== HISTORY TAB FUNCTIONS (T√çNH NƒÇNG M·ªöI) ==========
        function initHistoryTab() {
            populateStaffDropdown();
            setDefaultDateRange();
            
            // Set default month to current month
            const today = new Date();
            const currentMonth = today.toISOString().substring(0, 7);
            document.getElementById('historyMonth').value = currentMonth;
            
            // Clear any existing data
            clearHistoryTable();
        }
        
        function populateStaffDropdown() {
            const select = document.getElementById('historyStaff');
            if (!select) return;
            
            select.innerHTML = '<option value="">Ch·ªçn nh√¢n vi√™n</option>';
            
            DB.staff.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.id;
                option.textContent = `${staff.id} - ${staff.name} (${staff.dept})`;
                select.appendChild(option);
            });
        }
        
        function setDefaultDateRange() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('historyFrom').value = firstDay.toISOString().split('T')[0];
            document.getElementById('historyTo').value = today.toISOString().split('T')[0];
        }
        
        async function loadStaffOTHistory(showLoading = false) {
            const staffId = document.getElementById('historyStaff').value;
            if (!staffId) {
                clearHistoryTable();
                return;
            }
            
            if (showLoading) {
                document.getElementById('syncStatus').innerHTML = 
                    '<i class="fas fa-sync-alt loading"></i> ƒêang t·∫£i l·ªãch s·ª≠ OT...';
            }
            
            const fromDate = document.getElementById('historyFrom').value;
            const toDate = document.getElementById('historyTo').value;
            const month = document.getElementById('historyMonth').value;
            
            try {
                // Build API URL
                let url = GOOGLE_SHEET_API + '?action=history&staffId=' + encodeURIComponent(staffId);
                if (fromDate) url += '&fromDate=' + encodeURIComponent(fromDate);
                if (toDate) url += '&toDate=' + encodeURIComponent(toDate);
                if (month) url += '&month=' + encodeURIComponent(month);
                url += '&t=' + Date.now();
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    updateHistoryTable(result);
                    updateHistoryStats(result.summary, result.staffInfo);
                    
                    if (showLoading) {
                        document.getElementById('syncStatus').innerHTML = 
                            '<i class="fas fa-check-circle" style="color:var(--success)"></i> ƒê√£ t·∫£i l·ªãch s·ª≠ OT';
                    }
                    
                } else {
                    throw new Error(result.error || "L·ªói t·∫£i l·ªãch s·ª≠ OT");
                }
                
            } catch (error) {
                console.error("‚ùå L·ªói t·∫£i l·ªãch s·ª≠ OT:", error);
                
                // Fallback: Use local data
                loadStaffHistoryFromLocal(staffId, fromDate, toDate, month);
                
                if (showLoading) {
                    document.getElementById('syncStatus').innerHTML = 
                        '<i class="fas fa-exclamation-triangle" style="color:var(--warning)"></i> ƒêang d√πng d·ªØ li·ªáu c·ª•c b·ªô';
                }
            }
        }
        
        function loadStaffHistoryFromLocal(staffId, fromDate, toDate, month) {
            const staff = DB.staff.find(s => s.id === staffId);
            if (!staff) return;
            
            let historyData = [];
            let totalHours = 0;
            let totalMoney = 0;
            let dayCount = 0;
            
            Object.keys(DB.ot).forEach(date => {
                // Filter by date range
                if (fromDate && date < fromDate) return;
                if (toDate && date > toDate) return;
                if (month && !date.startsWith(month)) return;
                
                const otData = DB.ot[date][staffId];
                if (otData) {
                    const h15 = Number(otData.h15) || 0;
                    const h21 = Number(otData.h21) || 0;
                    const h20 = Number(otData.h20) || 0;
                    const h35 = Number(otData.h35) || 0;
                    
                    const totalDayHours = h15 + h21 + h20 + h35;
                    if (totalDayHours > 0) {
                        // T√≠nh ti·ªÅn
                        const stdDays = 26; // M·∫∑c ƒë·ªãnh
                        const salary = Number(staff.salary) || 0;
                        let dayMoney = 0;
                        
                        if (salary > 0 && stdDays > 0) {
                            const hourlyRate = salary / (stdDays * 8);
                            dayMoney = (h15 * 1.5 + h21 * 2.1 + h20 * 2.0 + h35 * 3.5) * hourlyRate;
                        }
                        
                        // L·∫•y th·ª©
                        const dateObj = new Date(date);
                        const dayOfWeek = dateObj.getDay();
                        const weekdays = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
                        
                        historyData.push({
                            date,
                            weekday: weekdays[dayOfWeek],
                            h15,
                            h21,
                            h20,
                            h35,
                            totalHours: totalDayHours,
                            money: dayMoney,
                            note: generateOTNoteLocal(h15, h21, h20, h35)
                        });
                        
                        totalHours += totalDayHours;
                        totalMoney += dayMoney;
                        dayCount++;
                    }
                }
            });
            
            // S·∫Øp x·∫øp theo ng√†y (m·ªõi nh·∫•t tr∆∞·ªõc)
            historyData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            updateHistoryTableLocal(staff, historyData);
            updateHistoryStatsLocal(totalHours, totalMoney, dayCount, staff);
        }
        
        function generateOTNoteLocal(h15, h21, h20, h35) {
            const notes = [];
            if (h15 > 0) notes.push(`${h15}h x 1.5`);
            if (h21 > 0) notes.push(`${h21}h x 2.1`);
            if (h20 > 0) notes.push(`${h20}h x 2.0`);
            if (h35 > 0) notes.push(`${h35}h x 3.5`);
            return notes.join(', ') || '-';
        }
        
        function updateHistoryTable(result) {
            const tbody = document.getElementById('historyBody');
            if (!tbody) return;
            
            if (!result.history || result.history.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align:center; padding:40px; color:var(--gray-400);">
                            <i class="fas fa-inbox" style="font-size:2rem; margin-bottom:10px;"></i><br>
                            Kh√¥ng c√≥ d·ªØ li·ªáu OT trong kho·∫£ng th·ªùi gian n√†y
                        </td>
                    </tr>`;
                return;
            }
            
            let html = '';
            let totalAllHours = 0;
            let totalAllMoney = 0;
            
            result.history.forEach(item => {
                totalAllHours += item.totalHours || 0;
                totalAllMoney += item.money || 0;
                
                const isSunday = item.weekday === 'CN';
                const weekdayClass = isSunday ? 'weekday-badge sunday' : 'weekday-badge';
                
                html += `
                <tr>
                    <td><strong>${formatDate(item.date)}</strong></td>
                    <td><span class="${weekdayClass}">${item.weekday}</span></td>
                    <td>${item.h15 > 0 ? item.h15 : '-'}</td>
                    <td>${item.h21 > 0 ? item.h21 : '-'}</td>
                    <td>${item.h20 > 0 ? item.h20 : '-'}</td>
                    <td>${item.h35 > 0 ? item.h35 : '-'}</td>
                    <td><strong>${(item.totalHours || 0).toFixed(1)}h</strong></td>
                    <td style="color:var(--danger); font-weight:700; text-align:right;">
                        ${Math.round(item.money || 0).toLocaleString()} ‚Ç´
                    </td>
                    <td style="font-size:0.85rem; color:var(--gray-600);">${item.note || '-'}</td>
                </tr>`;
            });
            
            // Th√™m d√≤ng t·ªïng
            html += `
            <tr style="background:var(--gray-50); font-weight:bold;">
                <td colspan="6" style="text-align:right;">T·ªîNG C·ªòNG:</td>
                <td>${totalAllHours.toFixed(1)}h</td>
                <td style="color:var(--danger); text-align:right;">${Math.round(totalAllMoney).toLocaleString()} ‚Ç´</td>
                <td></td>
            </tr>`;
            
            tbody.innerHTML = html;
            
            // Update staff name
            if (result.staffInfo) {
                document.getElementById('history-staff-name').textContent = 
                    `- ${result.staffInfo.name} (${result.staffInfo.id})`;
            }
        }
        
        function updateHistoryTableLocal(staff, historyData) {
            const tbody = document.getElementById('historyBody');
            if (!tbody) return;
            
            if (historyData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align:center; padding:40px; color:var(--gray-400);">
                            <i class="fas fa-inbox" style="font-size:2rem; margin-bottom:10px;"></i><br>
                            Kh√¥ng c√≥ d·ªØ li·ªáu OT trong kho·∫£ng th·ªùi gian n√†y
                        </td>
                    </tr>`;
                return;
            }
            
            let html = '';
            let totalAllHours = 0;
            let totalAllMoney = 0;
            
            historyData.forEach(item => {
                totalAllHours += item.totalHours;
                totalAllMoney += item.money;
                
                const isSunday = item.weekday === 'CN';
                const weekdayClass = isSunday ? 'weekday-badge sunday' : 'weekday-badge';
                
                html += `
                <tr>
                    <td><strong>${formatDate(item.date)}</strong></td>
                    <td><span class="${weekdayClass}">${item.weekday}</span></td>
                    <td>${item.h15 > 0 ? item.h15 : '-'}</td>
                    <td>${item.h21 > 0 ? item.h21 : '-'}</td>
                    <td>${item.h20 > 0 ? item.h20 : '-'}</td>
                    <td>${item.h35 > 0 ? item.h35 : '-'}</td>
                    <td><strong>${item.totalHours.toFixed(1)}h</strong></td>
                    <td style="color:var(--danger); font-weight:700; text-align:right;">
                        ${Math.round(item.money).toLocaleString()} ‚Ç´
                    </td>
                    <td style="font-size:0.85rem; color:var(--gray-600);">${item.note}</td>
                </tr>`;
            });
            
            // Th√™m d√≤ng t·ªïng
            html += `
            <tr style="background:var(--gray-50); font-weight:bold;">
                <td colspan="6" style="text-align:right;">T·ªîNG C·ªòNG:</td>
                <td>${totalAllHours.toFixed(1)}h</td>
                <td style="color:var(--danger); text-align:right;">${Math.round(totalAllMoney).toLocaleString()} ‚Ç´</td>
                <td></td>
            </tr>`;
            
            tbody.innerHTML = html;
            
            // Update staff name
            document.getElementById('history-staff-name').textContent = 
                `- ${staff.name} (${staff.id})`;
        }
        
        function updateHistoryStats(summary, staffInfo) {
            document.getElementById('history-total-hours').textContent = 
                (summary.totalHours || 0).toFixed(1);
            document.getElementById('history-total-days').textContent = 
                summary.totalDays || 0;
            document.getElementById('history-total-money').textContent = 
                Math.round(summary.totalMoney || 0).toLocaleString() + ' ‚Ç´';
            
            const avgPerDay = (summary.totalDays > 0 && summary.totalMoney) ? 
                (summary.totalMoney / summary.totalDays) : 0;
            document.getElementById('history-avg-day').textContent = 
                Math.round(avgPerDay).toLocaleString() + ' ‚Ç´';
        }
        
        function updateHistoryStatsLocal(totalHours, totalMoney, dayCount, staff) {
            document.getElementById('history-total-hours').textContent = totalHours.toFixed(1);
            document.getElementById('history-total-days').textContent = dayCount;
            document.getElementById('history-total-money').textContent = 
                Math.round(totalMoney).toLocaleString() + ' ‚Ç´';
            
            const avgPerDay = dayCount > 0 ? (totalMoney / dayCount) : 0;
            document.getElementById('history-avg-day').textContent = 
                Math.round(avgPerDay).toLocaleString() + ' ‚Ç´';
        }
        
        function clearHistoryTable() {
            document.getElementById('historyBody').innerHTML = `
                <tr>
                    <td colspan="9" style="text-align:center; padding:40px; color:var(--gray-400);">
                        <i class="fas fa-user" style="font-size:2rem; margin-bottom:10px;"></i><br>
                        Vui l√≤ng ch·ªçn nh√¢n vi√™n ƒë·ªÉ xem l·ªãch s·ª≠ OT
                    </td>
                </tr>`;
            
            // Reset stats
            document.getElementById('history-total-hours').textContent = '0';
            document.getElementById('history-total-days').textContent = '0';
            document.getElementById('history-total-money').textContent = '0 ‚Ç´';
            document.getElementById('history-avg-day').textContent = '0';
            document.getElementById('history-staff-name').textContent = '';
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        function exportStaffHistory() {
            const staffId = document.getElementById('historyStaff').value;
            if (!staffId) {
                alert("Vui l√≤ng ch·ªçn nh√¢n vi√™n!");
                return;
            }
            
            const staff = DB.staff.find(s => s.id === staffId);
            if (!staff) {
                alert("Kh√¥ng t√¨m th·∫•y th√¥ng tin nh√¢n vi√™n!");
                return;
            }
            
            const fromDate = document.getElementById('historyFrom').value;
            const toDate = document.getElementById('historyTo').value;
            const month = document.getElementById('historyMonth').value;
            
            // L·∫•y d·ªØ li·ªáu t·ª´ local
            let historyData = [];
            Object.keys(DB.ot).forEach(date => {
                if (fromDate && date < fromDate) return;
                if (toDate && date > toDate) return;
                if (month && !date.startsWith(month)) return;
                
                const otData = DB.ot[date][staffId];
                if (otData) {
                    const h15 = Number(otData.h15) || 0;
                    const h21 = Number(otData.h21) || 0;
                    const h20 = Number(otData.h20) || 0;
                    const h35 = Number(otData.h35) || 0;
                    
                    if (h15 + h21 + h20 + h35 > 0) {
                        historyData.push({
                            date,
                            h15,
                            h21,
                            h20,
                            h35,
                            total: h15 + h21 + h20 + h35
                        });
                    }
                }
            });
            
            if (historyData.length === 0) {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu OT ƒë·ªÉ xu·∫•t!");
                return;
            }
            
            // T·∫°o Excel
            const exportData = [
                ['B√ÅO C√ÅO L·ªäCH S·ª¨ OT NH√ÇN VI√äN'],
                ['M√£ NV:', staff.id],
                ['H·ªç t√™n:', staff.name],
                ['B·ªô ph·∫≠n:', staff.dept],
                ['L∆∞∆°ng CB:', staff.salary.toLocaleString() + ' ‚Ç´'],
                ['T·ª´ ng√†y:', fromDate || 'ƒê·∫ßu k·ª≥'],
                ['ƒê·∫øn ng√†y:', toDate || 'Cu·ªëi k·ª≥'],
                ['Ng√†y xu·∫•t:', new Date().toLocaleDateString('vi-VN')],
                [],
                ['Ng√†y', '1.5', '2.1', '2.0', '3.5', 'T·ªïng gi·ªù', 'Ghi ch√∫']
            ];
            
            let totalHours = 0;
            historyData.forEach(item => {
                totalHours += item.total;
                exportData.push([
                    formatDate(item.date),
                    item.h15 || '',
                    item.h21 || '',
                    item.h20 || '',
                    item.h35 || '',
                    item.total.toFixed(1),
                    generateOTNoteLocal(item.h15, item.h21, item.h20, item.h35)
                ]);
            });
            
            // Th√™m t·ªïng
            exportData.push([]);
            exportData.push(['T·ªîNG C·ªòNG', '', '', '', '', totalHours.toFixed(1) + ' gi·ªù', '']);
            
            try {
                const ws = XLSX.utils.aoa_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'L·ªãch s·ª≠ OT');
                
                // ƒê·ªãnh d·∫°ng c·ªôt
                ws['!cols'] = [
                    {wch: 12}, // Ng√†y
                    {wch: 8},  // 1.5
                    {wch: 8},  // 2.1
                    {wch: 8},  // 2.0
                    {wch: 8},  // 3.5
                    {wch: 10}, // T·ªïng gi·ªù
                    {wch: 30}  // Ghi ch√∫
                ];
                
                const fileName = `OT_${staff.id}_${staff.name}_${fromDate || ''}_${toDate || ''}.xlsx`.replace(/\s+/g, '_');
                XLSX.writeFile(wb, fileName);
                
                alert(`‚úÖ ƒê√£ xu·∫•t ${historyData.length} ng√†y OT c·ªßa ${staff.name}!\n\nFile: ${fileName}`);
            } catch (e) {
                alert("‚ùå L·ªói xu·∫•t file: " + e.message);
            }
        }
        
        function printStaffHistory() {
            const staffId = document.getElementById('historyStaff').value;
            if (!staffId) {
                alert("Vui l√≤ng ch·ªçn nh√¢n vi√™n!");
                return;
            }
            
            const staff = DB.staff.find(s => s.id === staffId);
            if (!staff) {
                alert("Kh√¥ng t√¨m th·∫•y th√¥ng tin nh√¢n vi√™n!");
                return;
            }
            
            const printWindow = window.open('', '_blank');
            
            let html = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>L·ªãch s·ª≠ OT - ${staff.name}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .header h1 { color: #1a237e; }
                    .info-table { margin: 20px 0; border-collapse: collapse; }
                    .info-table td { padding: 8px; border: 1px solid #ddd; }
                    .ot-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    .ot-table th, .ot-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
                    .ot-table th { background: #f5f5f5; }
                    .total-row { background: #f0f0f0; font-weight: bold; }
                    .footer { margin-top: 30px; text-align: center; color: #666; }
                    @media print {
                        body { margin: 10px; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>B√ÅO C√ÅO L·ªäCH S·ª¨ TƒÇNG CA</h1>
                    <h2>${staff.name} (${staff.id})</h2>
                </div>
                
                <table class="info-table">
                    <tr><td><strong>B·ªô ph·∫≠n:</strong></td><td>${staff.dept}</td></tr>
                    <tr><td><strong>L∆∞∆°ng c∆° b·∫£n:</strong></td><td>${staff.salary.toLocaleString()} ‚Ç´</td></tr>
                    <tr><td><strong>Th·ªùi gian:</strong></td><td>${document.getElementById('historyFrom').value} ƒë·∫øn ${document.getElementById('historyTo').value}</td></tr>
                    <tr><td><strong>Ng√†y in:</strong></td><td>${new Date().toLocaleDateString('vi-VN')}</td></tr>
                </table>
                
                <table class="ot-table">
                    <thead>
                        <tr>
                            <th>Ng√†y</th>
                            <th>1.5</th>
                            <th>2.1</th>
                            <th>2.0</th>
                            <th>3.5</th>
                            <th>T·ªïng gi·ªù</th>
                            <th>Ghi ch√∫</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            // L·∫•y d·ªØ li·ªáu
            const fromDate = document.getElementById('historyFrom').value;
            const toDate = document.getElementById('historyTo').value;
            const month = document.getElementById('historyMonth').value;
            let totalHours = 0;
            let rowCount = 0;
            
            Object.keys(DB.ot).forEach(date => {
                if (fromDate && date < fromDate) return;
                if (toDate && date > toDate) return;
                if (month && !date.startsWith(month)) return;
                
                const otData = DB.ot[date][staffId];
                if (otData) {
                    const h15 = Number(otData.h15) || 0;
                    const h21 = Number(otData.h21) || 0;
                    const h20 = Number(otData.h20) || 0;
                    const h35 = Number(otData.h35) || 0;
                    const total = h15 + h21 + h20 + h35;
                    
                    if (total > 0) {
                        totalHours += total;
                        rowCount++;
                        html += `
                        <tr>
                            <td>${formatDate(date)}</td>
                            <td>${h15 || '-'}</td>
                            <td>${h21 || '-'}</td>
                            <td>${h20 || '-'}</td>
                            <td>${h35 || '-'}</td>
                            <td>${total.toFixed(1)}</td>
                            <td>${generateOTNoteLocal(h15, h21, h20, h35)}</td>
                        </tr>`;
                    }
                }
            });
            
            html += `
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="5"><strong>T·ªîNG C·ªòNG (${rowCount} ng√†y)</strong></td>
                            <td><strong>${totalHours.toFixed(1)} gi·ªù</strong></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
                
                <div class="footer">
                    <p>--- H·∫øt b√°o c√°o ---</p>
                    <p>Ng∆∞·ªùi duy·ªát: ________________________</p>
                    <p class="no-print">
                        <button onclick="window.print()">In b√°o c√°o</button>
                        <button onclick="window.close()">ƒê√≥ng</button>
                    </p>
                </div>
            </body>
            </html>`;
            
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
        }
        
        // ========== DEBUG FUNCTIONS ==========
        function showDebugInfo() {
            const otDates = Object.keys(DB.ot);
            let debugInfo = `=== DEBUG INFO ===\n\n`;
            
            debugInfo += `üìä T·ªîNG QUAN:\n`;
            debugInfo += `‚Ä¢ Nh√¢n vi√™n: ${DB.staff.length}\n`;
            debugInfo += `‚Ä¢ Ng√†y OT: ${otDates.length}\n`;
            debugInfo += `‚Ä¢ B·∫£n ghi OT: ${countOTRecords(DB.ot)}\n`;
            debugInfo += `‚Ä¢ LocalStorage: ${localStorage.getItem('dongju_ot_backup') ? 'C√≥' : 'Kh√¥ng'}\n`;
            debugInfo += `‚Ä¢ ƒêang ch·ªù ƒë·ªìng b·ªô: ${AUTO_SAVE_QUEUE.pending.length}\n\n`;
            
            debugInfo += `üìÖ 5 NG√ÄY G·∫¶N NH·∫§T:\n`;
            otDates.sort().reverse().slice(0, 5).forEach(date => {
                const records = Object.keys(DB.ot[date] || {}).length;
                debugInfo += `‚Ä¢ ${date}: ${records} nh√¢n vi√™n\n`;
            });
            
            debugInfo += `\nüîç KI·ªÇM TRA D·ªÆ LI·ªÜU H√îM NAY:\n`;
            const today = document.getElementById('workDate')?.value || new Date().toISOString().split('T')[0];
            const todayOT = DB.ot[today] || {};
            debugInfo += `‚Ä¢ Ng√†y ${today}: ${Object.keys(todayOT).length} nh√¢n vi√™n c√≥ OT\n`;
            
            Object.keys(todayOT).slice(0, 5).forEach(staffId => {
                const ot = todayOT[staffId];
                const staff = DB.staff.find(s => s.id === staffId);
                debugInfo += `  - ${staffId}: ${staff?.name || 'N/A'}: ${ot.h15},${ot.h21},${ot.h20},${ot.h35}\n`;
            });
            
            console.log("Debug info:", debugInfo);
            
            document.getElementById('debugInfo').textContent = debugInfo;
            document.getElementById('debugPopup').classList.remove('hidden');
        }
        
        async function checkDataOnGoogleSheet() {
            try {
                const response = await fetch(GOOGLE_SHEET_API + '?action=stats&t=' + Date.now());
                const result = await response.json();
                
                if(result.success) {
                    const stats = result.stats;
                    let message = `üìä GOOGLE SHEET STATS:\n\n`;
                    
                    message += `üë• NH√ÇN VI√äN:\n`;
                    message += `‚Ä¢ T·ªïng: ${stats.staff || 0}\n`;
                    
                    message += `\nüìÖ OT DATA:\n`;
                    if(stats.ot) {
                        message += `‚Ä¢ T·ªïng b·∫£n ghi: ${stats.ot.totalRecords || 0}\n`;
                        message += `‚Ä¢ S·ªë ng√†y: ${stats.ot.uniqueDates || 0}\n`;
                        message += `‚Ä¢ Ng√†y m·ªõi nh·∫•t: ${stats.ot.latestDate || 'N/A'}\n`;
                        message += `‚Ä¢ Kho·∫£ng ng√†y: ${stats.ot.dateRange || 'N/A'}\n`;
                    }
                    
                    message += `\nüë§ T√ÄI KHO·∫¢N: ${stats.users || 0}\n`;
                    
                    alert(message);
                } else {
                    alert("‚ùå Kh√¥ng th·ªÉ l·∫•y th√¥ng tin t·ª´ Google Sheet");
                }
            } catch(error) {
                alert("‚ùå L·ªói k·∫øt n·ªëi: " + error.message);
            }
        }
        
        // ========== UTILITY FUNCTIONS ==========
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function initStdDaysListener() {
            const stdDaysElement = document.getElementById('stdDays');
            if(!stdDaysElement) return;
            
            stdDaysElement.addEventListener('input', function(e) {
                const value = parseInt(e.target.value);
                const errorEl = document.getElementById('stdDaysError');
                
                if(isNaN(value) || value < WORKING_DAYS_SETTINGS.minDays || value > WORKING_DAYS_SETTINGS.maxDays) {
                    e.target.classList.add('validation-error');
                    if(errorEl) errorEl.textContent = `S·ªë ng√†y ph·∫£i t·ª´ ${WORKING_DAYS_SETTINGS.minDays}-${WORKING_DAYS_SETTINGS.maxDays}`;
                    return;
                } else {
                    e.target.classList.remove('validation-error');
                    if(errorEl) errorEl.textContent = '';
                    handleStdDaysChange();
                }
            });
        }
        
        function switchTab(t) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-staff').classList.add('hidden');
            document.getElementById('tab-ot').classList.add('hidden');
            document.getElementById('tab-history').classList.add('hidden');
            document.getElementById('tab-account').classList.add('hidden');
            document.getElementById('date-tool').classList.add('hidden');
            document.getElementById('stats-cards').classList.add('hidden');
            
            document.getElementById('tab-' + t).classList.remove('hidden');
            document.getElementById('nav-' + t).classList.add('active');
            
            if(t === 'staff') {
                document.getElementById('page-title').innerText = "QU·∫¢N L√ù NH√ÇN S·ª∞";
                renderStaff();
            } else if(t === 'ot') {
                document.getElementById('page-title').innerText = "CH·∫§M C√îNG TƒÇNG CA";
                document.getElementById('date-tool').classList.remove('hidden');
                document.getElementById('stats-cards').classList.remove('hidden');
                updateDeptList();
                renderOTFast(false);
                updateStatsFull();
                updateWorkingDaysInfo();
                updateQueueStatusDisplay();
                
                setTimeout(() => {
                    initStdDaysListener();
                    
                    if(!hasSuggestedWorkingDays) {
                        setTimeout(suggestWorkingDays, 500);
                        hasSuggestedWorkingDays = true;
                    }
                }, 100);
            } else if(t === 'history') {
                document.getElementById('page-title').innerText = "L·ªäCH S·ª¨ OT NH√ÇN VI√äN";
                initHistoryTab();
            } else if(t === 'account') {
                document.getElementById('page-title').innerText = "QU·∫¢N L√ù T√ÄI KHO·∫¢N";
                renderAccounts();
            }
        }
        
        function updateSyncStatus(message) {
            console.log("üîÑ " + message);
        }
        
        function quickCheckData() {
            alert(`D·ªØ li·ªáu hi·ªán t·∫°i:\n\n‚Ä¢ Nh√¢n vi√™n: ${DB.staff.length}\n‚Ä¢ ƒêang ch·ªù ƒë·ªìng b·ªô: ${AUTO_SAVE_QUEUE.pending.length}\n‚Ä¢ ƒê√£ ƒë·ªìng b·ªô: ${AUTO_SAVE_QUEUE.totalProcessed}`);
        }
        
        function checkDataIntegrity() {
            alert("‚úÖ H·ªá th·ªëng auto save ƒëang ho·∫°t ƒë·ªông t·ªët!\n\n‚Ä¢ T·ª± ƒë·ªông l∆∞u t·ª´ng ng∆∞·ªùi\n‚Ä¢ Kh√¥ng l·ªói failed fetch\n‚Ä¢ D·ªØ li·ªáu an to√†n tr√™n localStorage");
        }
        
        function countOTRecords(otData) {
            let count = 0;
            for (const date in otData) {
                count += Object.keys(otData[date]).length;
            }
            return count;
        }
        
        // ========== INITIALIZATION ==========
        window.addEventListener('load', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('workDate').value = today;
            
            loadFromLocalStorage();
            
            initializeApp();
            
            setTimeout(detectConnectionSpeed, 2000);
            
            const perfStats = document.getElementById('perfStats');
            if (perfStats) {
                perfStats.classList.remove('hidden');
                updatePerformanceStats();
            }
            
            console.log("‚úÖ DONGJU SPORT OT SYSTEM v3.0 - AUTO SAVE OPTIMIZED");
            console.log("üöÄ H·ªá th·ªëng auto save ƒë√£ s·∫µn s√†ng v·ªõi t·ªëc ƒë·ªô x4!");
            
            setTimeout(() => {
                loadFromGoogleSheet();
            }, 1000);
        });
        
        function initializeApp() {
            document.getElementById('currentUser').textContent = currentUser;
            document.getElementById('userRole').textContent = currentRole === 'admin' ? 'Qu·∫£n tr·ªã vi√™n' : 'Ng∆∞·ªùi d√πng';
            document.getElementById('syncMode').textContent = 'Auto Save v3.0';
            
            renderStaff();
            updateDeptList();
        }
    </script>
</body>
</html>